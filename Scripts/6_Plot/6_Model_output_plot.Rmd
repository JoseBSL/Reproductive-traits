---
title: "Visitation_stacked_barplot"
output:
  pdf_document: default
  html_document: default
---


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=9, fig.width=10}
library(ggplot2)
library(brms)
library(png)
library(grid)
library(grid)
library(gridExtra)

setwd("~/Dropbox/PhD/R") #DROPBOX, files too large for github
m_5_clust_zero_neg_hclust <- readRDS("m_5_clust_zero_neg_hclust_1.RDS")
setwd("~/R_Projects/Reproductive Traits")
d_5_1 <- read.csv("Data/Csv/d_5_1_brms_all_5_clusters.csv")
#Visits
ce_1 <- conditional_effects(m_5_clust_zero_neg_hclust, effects = "Clusters:guild",points=T) 
#change colnames in model output to use same aesthetics
#if not gg seems to don't like it
colnames(ce_1[[1]])[4] <- "a"
colnames(ce_1[[1]])[10] <- "Interaction"
ce_1[[1]][10]<- ce_1[[1]][10]+1
#Order levels
#fixing label
d_5_1$guild <- as.character(d_5_1$guild)
d_5_1$guild[d_5_1$guild=="Bee"] <- "Bees"
ce_1[[1]]$guild <- as.character(ce_1[[1]]$guild)
ce_1[[1]]$guild[ce_1[[1]]$guild=="Bee"] <- "Bees"

ce_1[[1]]$guild <- factor(ce_1[[1]]$guild, levels = c("Bees","Non-bee-Hymenoptera","Syrphids","Non-syrphids-diptera","Lepidoptera","Coleoptera"))
d_5_1$guild <- factor(d_5_1$guild, levels = c("Bees","Non-bee-Hymenoptera","Syrphids","Non-syrphids-diptera","Lepidoptera","Coleoptera"))

#read images
 get_png <- function(filename) {
  grid::rasterGrob(png::readPNG(filename), interpolate = TRUE)
 }
 
# 
d_1 <- get_png("Images/dip_green_2.png")
l <- get_png("Images/lepi_brown.png")
b <- get_png("Images/bumble_orange.png")
f <- get_png("Images/form_orange.png")
s <- get_png("Images/syr_blue.png")

t <- grid::roundrectGrob(x=0.5, y=0.5, width=1, height=1)


t <- ggplot(ce_1[[1]], aes(x = Clusters, y = Interaction, colour = as.factor(guild), group = 
  as.factor(guild))) +
  geom_point(size = 1.2, position = position_dodge(width = 0.9), alpha=1) +
  theme_bw()+ ylab("NÂº of visits per plant taxa") + xlab("Plant reproductive groups")+
  geom_point(data = d_5_1,aes(x = Clusters, y = (Interaction+1)),size = 1.2, position = position_jitterdodge(dodge.width = 0.9,   jitter.width = 0.2), alpha=0.2)+
  geom_errorbar(data=ce_1[[1]],mapping=aes(x=Clusters, ymin=lower__, ymax=upper__,colour = as.factor(guild), group = 
  as.factor(guild)), width=.6,alpha=0.85, size = 0.9,position = position_dodge(width = 0.9)) +ylim(0,200)+
  scale_color_manual("Floral visitors guilds",values=c("#E69F00","#D55E00", "#287DAB", "#009E73", "#A7473A",  "black"))+
  annotation_custom(d_1, xmin = 1.02, xmax =1.15 , ymin = -5.1, ymax =-0.2) + #diptera
  annotation_custom(l, xmin = 1.16, xmax =1.30 , ymin = -28, ymax =22) +  #lepidoptera
  geom_vline(xintercept = c(1.5,2.5,3.5,4.5), linetype="dashed", color = "grey", size=0.5)+ #vertical lines
  theme(panel.grid.major.x = element_blank(),panel.grid.minor.y  = element_blank())+ # remove some grids
  annotation_custom(b, xmin = 0.46, xmax =0.79 , ymin = -4.35, ymax =-0.25) + #bees
 annotation_custom(f, xmin = 0.67, xmax =0.87 , ymin = -4.35, ymax =-0.25) + #hymenoptera non bees
 annotation_custom(s, xmin = 0.817, xmax =1.05 , ymin = -5.3, ymax =-0.25)

gg_table <- ggplot_gtable(ggplot_build(t))
gg_table$layout$clip[gg_table$layout$name=="panel"] <- "off"
grid.draw(gg_table)



#Bumblebee image credit to Melissa Broussard
```

