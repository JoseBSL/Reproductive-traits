---
title: ""
output:
  pdf_document: default
  html_document: default
---


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=9, fig.width=10}
library(ggplot2)
library(brms)
library(png)
library(grid)
library(grid)
library(gridExtra)

setwd("~/Dropbox/PhD/R") #DROPBOX, files too large for github
m_5_clust_zero_neg_hclust <- readRDS("m_5_clust_zero_neg_hclust_1.RDS")
setwd("~/R_Projects/Reproductive Traits")
d_5_1 <- read.csv("Data/Csv/d_5_1_brms_all_5_clusters.csv")
#Visits
ce_1 <- conditional_effects(m_5_clust_zero_neg_hclust, effects = "Clusters:guild",points=T) 
#change colnames in model output to use same aesthetics
#if not gg seems to don't like it
colnames(ce_1[[1]])[4] <- "a"
colnames(ce_1[[1]])[10] <- "Interaction"
ce_1[[1]][10]<- ce_1[[1]][10]+1
#Order levels
#fixing label
d_5_1$guild <- as.character(d_5_1$guild)
d_5_1$guild[d_5_1$guild=="Bee"] <- "Bees"
ce_1[[1]]$guild <- as.character(ce_1[[1]]$guild)
ce_1[[1]]$guild[ce_1[[1]]$guild=="Bee"] <- "Bees"

ce_1[[1]]$guild <- factor(ce_1[[1]]$guild, levels = c("Bees","Non-bee-Hymenoptera","Syrphids","Non-syrphids-diptera","Lepidoptera","Coleoptera"))
d_5_1$guild <- factor(d_5_1$guild, levels = c("Bees","Non-bee-Hymenoptera","Syrphids","Non-syrphids-diptera","Lepidoptera","Coleoptera"))

#read images
 get_png <- function(filename) {
  grid::rasterGrob(png::readPNG(filename), interpolate = TRUE)
 }
 
# 
d_1 <- get_png("Images/dip_green_2.png")
l <- get_png("Images/lepi_brown.png")
b <- get_png("Images/bee_orange.png")
f <- get_png("Images/form_2.png")
s <- get_png("Images/syr_blue.png")
beet <- get_png("Images/beet_black.png")

t <- grid::roundrectGrob(x=20, y=20, width=20, height=20)


t <- ggplot(ce_1[[1]], aes(x = Clusters, y = Interaction, colour = as.factor(guild), group = 
  as.factor(guild))) +
  geom_point(size = 1.2, position = position_dodge(width = 0.9), alpha=1) +
  theme_bw()+ ylab("NÂº of visits per plant taxa") + xlab("Plant reproductive groups")+
  geom_point(data = d_5_1,aes(x = Clusters, y = (Interaction+1)),size = 1.2, position = position_jitterdodge(dodge.width = 0.9,   jitter.width = 0.2), alpha=0.2)+
  geom_errorbar(data=ce_1[[1]],mapping=aes(x=Clusters, ymin=lower__, ymax=upper__,colour = as.factor(guild), group = 
  as.factor(guild)), width=.6,alpha=0.85, size = 0.9,position = position_dodge(width = 0.9)) +ylim(0,200)+
  scale_color_manual("Floral visitors guilds",values=c("#E69F00","#D55E00", "#287DAB", "#009E73", "#A7473A",  "black"))+  theme(panel.grid.major.x = element_blank(),panel.grid.minor.y  = element_blank())+   geom_vline(xintercept = c(1.5,2.5,3.5,4.5), linetype="dashed", color = "black", size=0.5)+coord_cartesian(clip = "off")+theme(legend.box.margin=margin(6,6,6,6))
  #cluster 1
t_1 <-  t + annotation_custom(l, xmin = 1.17, xmax =1.28 , ymin = -5.75, ymax =0.5)+ #needed to colour the rest
  annotation_custom(l, xmin = 1.17, xmax =1.28 , ymin = -5.75, ymax =0.5) +  #lepidoptera
  annotation_custom(b, xmin = 0.55, xmax =0.70 , ymin = -5, ymax =0) + #bee
  annotation_custom(f, xmin = 0.67, xmax =0.87 , ymin = -4.5, ymax =-0.65) + #wasp
  annotation_custom(s, xmin = 0.85, xmax =0.99 , ymin = -5.5, ymax =-0.25)+ # syrphid
  annotation_custom(d_1, xmin = 1.0, xmax =1.14 , ymin = -5.75, ymax =1) + #diptera
  annotation_custom(beet, xmin = 1.265, xmax =1.485 , ymin = -4.5, ymax =-0.35) #beetle
  #cluster 2
t_2 <-  t_1 + annotation_custom(l, xmin = 2.17, xmax =2.28 , ymin = -5.75, ymax =0.5)+ #needed to colour the rest
  annotation_custom(l, xmin = 2.17, xmax =2.28 , ymin = -5.75, ymax =0.5) +  #lepidoptera
  annotation_custom(b, xmin = 1.55, xmax =1.70 , ymin = -5, ymax =0) + #bee
  annotation_custom(f, xmin = 1.67, xmax =1.87 , ymin = -4.5, ymax =-0.65) + #wasp
  annotation_custom(s, xmin = 1.85, xmax =1.99 , ymin = -5.5, ymax =-0.25)+ # syrphid
  annotation_custom(d_1, xmin = 2.0, xmax =2.14 , ymin = -5.75, ymax =1) + #diptera
  annotation_custom(beet, xmin = 2.265, xmax =2.485 , ymin = -4.5, ymax =-0.35) #beetle
  #cluster 3
t_3 <-  t_2 + annotation_custom(l, xmin = 3.17, xmax =3.28 , ymin = -5.75, ymax =0.5)+ #needed to colour the rest
  annotation_custom(l, xmin = 3.17, xmax =3.28 , ymin = -5.75, ymax =0.5) +  #lepidoptera
  annotation_custom(b, xmin = 2.55, xmax =2.70 , ymin = -5, ymax =0) + #bee
  annotation_custom(f, xmin = 2.67, xmax =2.87 , ymin = -4.5, ymax =-0.65) + #wasp
  annotation_custom(s, xmin = 2.85, xmax =2.99 , ymin = -5.5, ymax =-0.25)+ # syrphid
  annotation_custom(d_1, xmin = 3.0, xmax =3.14 , ymin = -5.75, ymax =1) + #diptera
  annotation_custom(beet, xmin = 3.265, xmax =3.485 , ymin = -4.5, ymax =-0.35) #beetle
  #cluster 4
t_4 <-  t_3 + annotation_custom(l, xmin = 4.17, xmax =4.28 , ymin = -5.75, ymax =0.5)+ #needed to colour the rest
  annotation_custom(l, xmin = 4.17, xmax =4.28 , ymin = -5.75, ymax =0.5) +  #lepidoptera
  annotation_custom(b, xmin = 3.55, xmax =3.70 , ymin = -5, ymax =0) + #bee
  annotation_custom(f, xmin = 3.67, xmax =3.87 , ymin = -4.5, ymax =-0.65) + #wasp
  annotation_custom(s, xmin = 3.85, xmax =3.99 , ymin = -5.5, ymax =-0.25)+ # syrphid
  annotation_custom(d_1, xmin = 4.0, xmax =4.14 , ymin = -5.75, ymax =1) + #diptera
  annotation_custom(beet, xmin = 4.265, xmax =4.485 , ymin = -4.5, ymax =-0.35) #beetle
  #cluster 5
t_5 <-  t_4 + annotation_custom(l, xmin = 5.17, xmax =5.28 , ymin = -5.75, ymax =0.5)+ #needed to colour the rest
  annotation_custom(l, xmin = 5.17, xmax =5.28 , ymin = -5.75, ymax =0.5) +  #lepidoptera
  annotation_custom(b, xmin = 4.55, xmax =4.70 , ymin = -5, ymax =0) + #bee
  annotation_custom(f, xmin = 4.67, xmax =4.87 , ymin = -4.5, ymax =-0.65) + #wasp
  annotation_custom(s, xmin = 4.85, xmax =4.99 , ymin = -5.5, ymax =-0.25)+ # syrphid
  annotation_custom(d_1, xmin = 5.0, xmax =5.14 , ymin = -5.75, ymax =1) + #diptera
  annotation_custom(beet, xmin = 5.265, xmax =5.485 , ymin = -4.5, ymax =-0.35) #beetle
  #legend
t_6 <-  t_5 + annotation_custom(l, xmin = 5.65, xmax =5.76 , ymin = 84.4, ymax =90.8)+ #lepidoptera
              annotation_custom(b, xmin = 5.65, xmax =5.76 , ymin = 108, ymax =117.5)+ #bee
              annotation_custom(f, xmin = 5.65, xmax =5.76 , ymin = 105, ymax =108.5)+ #wasp
              annotation_custom(s, xmin = 5.65, xmax =5.76 , ymin = 97.5, ymax =102.5)+ #syrphid
              annotation_custom(d_1, xmin = 5.65, xmax =5.76 , ymin = 89, ymax =99) + #diptera
              annotation_custom(beet, xmin = 5.65, xmax =5.76 , ymin = 79.5, ymax =83.5) #beetle
              
gg_table <- ggplot_gtable(ggplot_build(t_6))
gg_table$layout$clip[gg_table$layout$name=="panel"] <- "off"
grid.draw(gg_table)



#Bumblebee image credit to Melissa Broussard
```

