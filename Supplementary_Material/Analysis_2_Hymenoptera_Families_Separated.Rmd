---
output:
  pdf_document: default
  html_document: default

---



```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=14, fig.width=27,fig.pos = "!H",fig.cap= ""}

library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
#library(tidyverse)
library(patchwork) #panel of plots
library(brms)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2.2)),
           axis.text=element_text(size = rel(1.85), color = "black"),
           legend.title=element_text(face="bold",size=rel(2.4)),
           legend.text=element_text(size=rel(1.8)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(2, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.95), face="bold"),
           plot.subtitle = element_text(size=rel(2.7),face="bold")))
}

#decimal places for ggplot

scaleFUN <- function(x) sprintf("%.1f", x)


#Prepare plot with presence absence and interaction frequency
setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github
#Plot nicely PC1
analysis_1 <- readRDS("results_analysis_1_bee_families_presence_absence.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_bee_families_presence_absence.rds")

ce_pc1 <- conditional_effects(analysis_1, effects = "PC1:bee_family",points=T) 

pp1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + ylab("Interaction")+ xlab("")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(face="bold")) + scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"))+ ggtitle("PC1", subtitle = "A")+scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))


ce_pc2 <- conditional_effects(analysis_1, effects = "PC2:bee_family",points=T) 

pp2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(face="bold")) + scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"))+ ggtitle("PC2", subtitle = "B") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))


ce_pc3 <- conditional_effects(analysis_1, effects = "PC3:bee_family",points=T) 

pp3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
 aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(face="bold")) + 
  scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"))+ ggtitle("PC3", subtitle = "C")+ scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))
#Plot nicely PC1
analysis_1 <- readRDS("r_bee_families.rds")
dat_analysis <- readRDS("dat_bee_families.rds")
########################################################################################################################

########################################################################################################################
ce_pc1 <- conditional_effects(analysis_1, effects = "PC1:bee_family",points=T) 

p1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
  aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("Number of visits")+  xlab("High flower N.    Low flower N.\nSmall flowers    Large flowers")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(size=rel(2.95),hjust = 0)) + scale_color_manual(name="Functional groups",
  values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"))+
  scale_y_log10()+ggtitle("D")
#Plot nicely PC2
ce_pc2 <- conditional_effects(analysis_1, effects = "PC2:bee_family",points=T) 

p2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
  aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("Low poll. depend. High poll. depend.")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(size=rel(2.95),hjust = 0)) + 
  scale_color_manual(name="Functional groups",values=c("orange", "black", 
  "limegreen","#E7298A", "cyan4","blueviolet")) + scale_y_log10()+ggtitle("E")

#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1, effects = "PC3:bee_family",points=T)


p3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1), group=bee_family, colour=bee_family)) + geom_point(data = dat_analysis,
  aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("Short styles    Long styles\n Low selfing    High selfing")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(size=rel(2.95),hjust = 0))+ 
  scale_color_manual(name="Functional groups",values=c("orange", 
  "black", "limegreen","#E7298A", "cyan4","blueviolet"))+ scale_y_log10()+ggtitle("F")


combined <- pp1 + pp2 + pp3 + p1 + p2 + p3 & theme(legend.position = "bottom")
combined_1 <- combined + plot_layout(guides = "collect",ncol = 3)

saveRDS(combined_1, "Plot_bee_families.rds")

combined_2 <- readRDS("Plot_bee_families.rds")

combined_2
```

