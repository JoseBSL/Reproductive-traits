---
output:
  pdf_document: default
  html_document: default
classoption: landscape

---


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=22, fig.width=28, fig.align='center'}

library(brms) #modelling
library(cowplot) #panel of plots
library(ggplot2) #plotting
library(patchwork)

# Theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2.2)),
           axis.text=element_text(size = rel(1.9), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.7)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.9, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(3.05),face="bold"),
           plot.subtitle = element_text(face="bold",size=rel(2.7))
     ))
}
#########

#Note the axes are inverted because they were inverted in the pPCA for visualization purposes

setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github


#read data for plotting
data_analysis_2 <- readRDS("data_analysis_2.rds") 

#INTERACTION FREQUENCY
Visits_PCs <- readRDS("results_analysis_2_Visits.rds") #load model

ce_1 <- conditional_effects(Visits_PCs, effects = "PC1",points=T) 
colnames(ce_1[[1]])[3] <- "Interaction"

Visits_PC1 <- ggplot(ce_1[[1]], aes(x = -PC1, y = (estimate__+1))) + geom_point(data = data_analysis_2,aes(x = -PC1, y = Visits),
  size = 3, alpha=0.65, colour="goldenrod3") + geom_line(colour="black",size=1.5) + ylim(0,quantile(data_analysis_2$Visits, 0.95)) +theme_ms()+
  geom_ribbon(aes(ymin=(lower__+1), ymax=(upper__+1)), linetype=2, alpha=0.1,fill="black") + ylab("Sum of visits") + xlab("PC1")+ggtitle("PC1", subtitle = "(a)")+ xlab(NULL)

ce_2 <- conditional_effects(Visits_PCs, effects = "PC2",points=T) 
colnames(ce_2[[1]])[3] <- "Interaction"

Visits_PC2 <- ggplot(ce_2[[1]], aes(x = -PC2, y = (estimate__+1))) + geom_point(data = data_analysis_2,aes(x = -PC2, y = Visits),
  size = 3, alpha=0.65, colour="goldenrod3") + geom_line(colour="black",size=1.5) + ylim(0,quantile(data_analysis_2$Visits, 0.95)) +theme_ms()+
  geom_ribbon(aes(ymin=(lower__+1), ymax=(upper__+1)), linetype=2, alpha=0.1,fill="black") + ylab("") + xlab("PC2")+ggtitle("PC2", subtitle = "(b)")+ xlab(NULL)

ce_3 <- conditional_effects(Visits_PCs, effects = "PC3",points=T) 
colnames(ce_3[[1]])[3] <- "Interaction"

Visits_PC3 <- ggplot(ce_3[[1]], aes(x = -PC3, y = (estimate__+1))) + geom_point(data = data_analysis_2,aes(x = -PC3, y = Visits),
  size = 3.5, alpha=0.65, colour="goldenrod3") + geom_line(colour="black",size=1.5) + ylim(0,quantile(data_analysis_2$Visits, 0.95)) +theme_ms()+
  geom_ribbon(aes(ymin=(lower__+1), ymax=(upper__+1)), linetype=2, alpha=0.1,fill="black") + ylab(NULL) + xlab("PC3") +ggtitle("PC3", subtitle = "(c)")+ xlab(NULL)

#NORMALIZED DEGREE
normalised.degree_PCs <- readRDS("results_analysis_2_normalised.degree_PCs.rds") #load model

ce_1 <- conditional_effects(normalised.degree_PCs, effects = "PC1",points=T) 

normalised.degree_PC1 <- ggplot(ce_1[[1]], aes(x = -PC1, y = (estimate__))) + geom_point(data = data_analysis_2,aes(x = -PC1, y = normalised.degree),
  size = 3.5, alpha=0.65, colour="aquamarine4") + geom_line(colour="black",size=1.5)  +theme_ms()+
  geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.25,fill="black") + ylab("Normalized degree") + xlab("PC1") + ggtitle(NULL, subtitle = "(d)")+ xlab(NULL)

ce_2 <- conditional_effects(normalised.degree_PCs, effects = "PC2",points=T) 

normalised.degree_PC2 <- ggplot(ce_2[[1]], aes(x = -PC2, y = (estimate__))) + geom_point(data = data_analysis_2,aes(x = -PC2, y = normalised.degree),
  size = 3.5, alpha=0.65,colour="aquamarine4") + geom_line(colour="black",size=1.5) +theme_ms()+
  geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.25,fill="black") + ylab(NULL) + xlab("PC2") + ggtitle(NULL, subtitle = "(e)")+ xlab(NULL)


ce_3 <- conditional_effects(normalised.degree_PCs, effects = "PC3",points=T) 

normalised.degree_PC3 <- ggplot(ce_3[[1]], aes(x = -PC3, y = (estimate__))) + geom_point(data = data_analysis_2,aes(x = -PC3, y = normalised.degree),
  size = 3.5, alpha=0.65,colour="aquamarine4") + geom_line(colour="black",size=1.5)  +theme_ms()+
  geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.25,fill="black") + ylab(NULL) + xlab("PC3") + ggtitle(NULL, subtitle = "(f)")+ xlab(NULL)


#SPECIALIZATION
Specialization_PCs <- readRDS("results_analysis_2_Specialization_PCs.rds") #load model

ce_1 <- conditional_effects(Specialization_PCs, effects = "PC1",points=T) 
colnames(ce_1[[1]])[3] <- "Interaction"

Specialization_PC1 <- ggplot(ce_1[[1]], aes(x = -PC1, y = (estimate__))) + 
geom_point(data = data_analysis_2,aes(x = -PC1, y = d),
           size = 3.5, alpha=0.65, colour="darkorange3") + geom_line(colour="black",size=1.5) + coord_cartesian(ylim=c(0,quantile(data_analysis_2$d, 0.95)), 
            clip="off") + 
           theme_ms() +
geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, 
            alpha=0.1,fill="black") + ylab("Specialization (d')") + 
xlab("PC1") + 
ggtitle(NULL, subtitle = "(g)") +  
annotate(geom = "text", x = -1.6, y =-0.3 , 
               label = "High flower N.", size = 8) +
annotate(geom = "text", x = -1.7, y =-0.41 ,
               label = "Small flowers", size = 8) + 
annotate(geom = "text", x = 1.75, y =-0.3 , 
               label = "Low flower N.", size = 8) + 
annotate(geom = "text", x = 1.75, y =-0.41 ,
               label = "Large flowers", size = 8) +
annotate(geom = "text", x = 0.10, y =-0.19 , 
    label = "Flower number - Flower size axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2)) +
xlab(" \n \n  ") 






ce_2 <- conditional_effects(Specialization_PCs, effects = "PC2",points=T) 
colnames(ce_2[[1]])[3] <- "Interaction"

Specialization_PC2 <- ggplot(ce_2[[1]], aes(x = -PC2, y =
(estimate__))) + 
geom_point(data = data_analysis_2,aes(x = -PC2, y = d),
           size = 3.5, alpha=0.65, colour="darkorange3") + geom_line(colour="black",size=1.5) + coord_cartesian(ylim=c(0,quantile(data_analysis_2$d, 0.95)), 
                clip="off") +
theme_ms() +
geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.1,fill="black") + 
ylab(NULL) + 
xlab("PC2") + 
ggtitle(NULL, subtitle = "(h)") + 
xlab(NULL) +
annotate(geom = "text", x = -1.57, y =-0.3 , 
               label = "Low poll. depend.", size = 8) +
annotate(geom = "text", x = -1.5, y =-0.41 ,
               label = "Small floral display", size = 8) + 
annotate(geom = "text", x = 1.75, y =-0.3 , 
               label = "High poll. depend.", size = 8) + 
annotate(geom = "text", x = 1.8, y =-0.41 ,
               label = "Large floral display", size = 8) +
annotate(geom = "text", x = 0.10, y =-0.19 , 
    label = "Pollinator dependence - Floral display axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2))



ce_3 <- conditional_effects(Specialization_PCs, effects = "PC3",points=T) 
colnames(ce_3[[1]])[3] <- "Interaction"

Specialization_PC3 <- ggplot(ce_3[[1]], aes(x = -PC3, y =             (estimate__))) + 
geom_point(data = data_analysis_2,aes(x = -PC3, y = d),
           size = 3.5, alpha=0.65, colour="darkorange3")  +
theme_ms() + 
geom_line(colour="black",size=1.5) +
geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2,    
            alpha=0.1,fill="black") +
ylab(NULL) + 
xlab("PC3") + 
coord_cartesian(ylim=c(0,quantile(data_analysis_2$d, 0.95)), 
                clip="off") +
ggtitle(NULL, subtitle = "(i)") + 
annotate(geom = "text", x = -1.57, y =-0.3 , 
         label = "Short styles", size = 8) +
annotate(geom = "text", x = -1.25, y =-0.41 ,
         label = "High poll. depend.", size = 8) + 
annotate(geom = "text", x = 2.05, y =-0.3 , 
         label = "Long styles", size = 8) + 
annotate(geom = "text", x = 2.4, y =-0.41 ,
         label = "Low poll. depend.", size = 8) +
annotate(geom = "text", x = 0.25, y =-0.19 , 
         label = "Style length - Pollinator dependence axis", 
         size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2)) +
xlab(NULL)



plot_metrics_pcs <- Visits_PC1 + Visits_PC2 + Visits_PC3 + normalised.degree_PC1 + normalised.degree_PC2 + normalised.degree_PC3 +
  Specialization_PC1 + Specialization_PC2+ Specialization_PC3  + plot_layout(ncol = 3) 
  

plot_metrics_pcs


saveRDS(plot_metrics_pcs, "plot_metrics_pcs.rds") 







```

