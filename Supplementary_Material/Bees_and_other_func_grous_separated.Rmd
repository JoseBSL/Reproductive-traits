---
output:
  pdf_document: default
  html_document: default

---



```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=24, fig.width=24}

#LOAD LIBRARIES 
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(tidyverse)
library(patchwork) #panel of plots
library(brms)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2)),
           axis.text=element_text(size = rel(1.8), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.8, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.75),face="bold"),
           plot.subtitle = element_text(face="bold",size=rel(2.2))
     ))
}

#decimal places for ggplot

scaleFUN <- function(x) sprintf("%.1f", x)


#Prepare plot with presence absence and interaction frequency
setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github
#Plot nicely PC1
analysis_1 <- readRDS("results_analysis_1_bee_apis_presence_absence.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_bee_apis_presence_absence.rds")

ce_pc1 <- conditional_effects(analysis_1, effects = "PC1",points=T) 

my_y_title_1 <- expression(paste(bold("(a) "), "All bee species"))


a1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__))) + geom_point(data = dat_analysis,
aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4,  colour="orange") + geom_line(size=1.5,  colour="orange")  + ylab("Interaction")+ xlab("")+
  theme_ms() + theme(legend.position = "none") +scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes")) + labs(title = "PC1", subtitle = my_y_title_1)


ce_pc2 <- conditional_effects(analysis_1, effects = "PC2",points=T) 

my_y_title_1 <- expression(paste(bold("(b) "), "All bee species"))

a2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__))) + geom_point(data = dat_analysis,
aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.4,  colour="orange") + geom_line(size=1.5, colour="orange")  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes")) + labs(title = "PC2", subtitle = my_y_title_1)


ce_pc3 <- conditional_effects(analysis_1, effects = "PC3",points=T) 

my_y_title_1 <- expression(paste(bold("(c) "), "All bee species"))


a3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__))) + geom_point(data = dat_analysis,
 aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4,  colour="orange") + geom_line(size=1.5,  colour="orange")  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))+ labs(title = "PC3", subtitle = my_y_title_1)

#Plot nicely PC1
analysis_1 <- readRDS("results_analysis_1_bee_non_apis_presence_absence.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_bee_non_apis_presence_absence.rds")

my_y_title <- expression(paste(bold("(d) "), italic("Apis mellifera"), " excluded"))

ce_pc1 <- conditional_effects(analysis_1, effects = "PC1",points=T) 

b1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__))) + geom_point(data = dat_analysis,
aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4,  colour="brown4") + geom_line(size=1.5,  colour="brown4")  + ylab("Interaction")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + ggtitle("PC1", subtitle = "(d)")+scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))+
   labs(title = "", subtitle = my_y_title)


ce_pc2 <- conditional_effects(analysis_1, effects = "PC2",points=T) 

my_y_title <- expression(paste(bold("(e) "), italic("Apis mellifera"), " excluded"))

b2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__))) + geom_point(data = dat_analysis,
aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.4,  colour="brown4") + geom_line(size=1.5,  colour="brown4")  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes")) +
 labs(title = "", subtitle =my_y_title)


ce_pc3 <- conditional_effects(analysis_1, effects = "PC3",points=T) 

my_y_title <- expression(paste(bold("(f) "), italic("Apis mellifera"), " excluded"))

b3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__))) + geom_point(data = dat_analysis,
 aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4,  colour="brown4") + geom_line(size=1.5,  colour="brown4")  + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))+
 labs(title = "", subtitle =my_y_title)



analysis_1_just_bees <- readRDS("results_analysis_1_just_bees.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_just_bees.rds")

ce_pc1 <- conditional_effects(analysis_1_just_bees, effects = "PC1",points=T) 
ce_pc1[[1]]$guild <- "bees"

my_y_title_1 <- expression(paste(bold("(g) "), "All bee species"))


c1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("Number of visits")+ xlab("")+
  theme_ms() + theme(legend.position = "none",plot.subtitle=element_text(size=30,face="bold")) +
 labs(title = "", subtitle =my_y_title_1)

#Plot nicely PC2
ce_pc2 <- conditional_effects(analysis_1_just_bees, effects = "PC2",points=T) 
ce_pc1[[1]]$guild <- "bees"

my_y_title_1 <- expression(paste(bold("(h) "), "All bee species"))

c2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none")  + 
  theme(plot.title = element_text(size = 36, face = "bold"),plot.subtitle=element_text(size=30,face="bold"))+
 labs(title = "", subtitle =my_y_title_1)



#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1_just_bees, effects = "PC3",points=T)
ce_pc1[[1]]$guild <- "bees"

my_y_title_1 <- expression(paste(bold("(i) "), "All bee species"))

c3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none",plot.subtitle=element_text(size=30,face="bold")) +
 labs(title = "", subtitle =my_y_title_1)


analysis_1_just_bees_non_apis <- readRDS("results_analysis_1_just_bees_non_apis.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_just_bees.rds")

ce_pc1 <- conditional_effects(analysis_1_just_bees_non_apis, effects = "PC1",points=T) 
ce_pc1[[1]]$guild <- "bees"

my_y_title <- expression(paste(bold("(j) "), italic("Apis mellifera"), " excluded"))

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)

d1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1))) + geom_point(data = dat_analysis, aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.5, color="brown4") + geom_line(size=1.4, color="brown4") +  coord_cartesian(ylim=c(1,100),clip="off") +
ylab("Number of visits") +
theme_ms() + 
theme(legend.position = "none",plot.subtitle=element_text(size=30,face="bold")) +
labs(title = "", subtitle =my_y_title) +
annotate(geom = "text", x = -1.7, y =-32 , label = "High flower N.", size = 8) +
annotate(geom = "text", x = -1.72, y =-42 , label = "Small flowers", size = 8) + 
annotate(geom = "text", x = 1.8, y =-32 , label = "Low flower N.", size = 8) + 
annotate(geom = "text", x = 1.8, y =-42 , label = "Large flowers", size = 8) +
xlab("") +
annotate(geom = "text", x = -0.1, y =-20 , label = "Flower number - Flower size axis", size = 8.5, fontface =2) + xlab("") + theme(panel.border=element_rect(color="black",size=1.2))

#Plot nicely PC2
ce_pc2 <- conditional_effects(analysis_1_just_bees_non_apis, effects = "PC2",points=T) 
ce_pc1[[1]]$guild <- "bees"

my_y_title <- expression(paste(bold("(k) "), italic("Apis mellifera"), " excluded"))

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)

d2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1))) + geom_point(data = dat_analysis, aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.5, color="brown4") + geom_line(size=1.4, color="brown4") + 
coord_cartesian(ylim=c(1,100),clip="off") +
ylab("") + 
theme_ms() + 
theme(legend.position = "none")  +
theme(plot.title = element_text(size = 36, face = "bold"),plot.subtitle=element_text(size=30,face="bold")) + labs(title = "", subtitle = my_y_title) +
annotate(geom = "text", x = -1.7, y =-32 , label = "Low poll. depend.", size = 8) +
annotate(geom = "text", x = -1.65, y =-42 , label = "Small floral display", size = 8) + 
annotate(geom = "text", x = 1.75, y =-32 , label = "High poll. depend.", size = 8) + 
annotate(geom = "text", x = 1.8, y =-42 , label = "Large floral display", size = 8) +
xlab(NULL) +
annotate(geom = "text", x = -0.1, y =-20 , label = "Pollinator dependence - Floral display axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2))


#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1_just_bees_non_apis, effects = "PC3",points=T)
ce_pc1[[1]]$guild <- "bees"

my_y_title <- expression(paste(bold("(l) "), italic("Apis mellifera"), " excluded"))

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)

d3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1))) + geom_point(data = dat_analysis, aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.5, color="brown4") + geom_line(size=1.4, color="brown4") + 
coord_cartesian(ylim=c(1,100),clip="off") +
ylab("") + 
theme_ms() + 
theme(legend.position = "none",plot.subtitle=element_text(size=30,face="bold")) + labs(title = "", subtitle = my_y_title) +
annotate(geom = "text", x = -1.6, y =-32 , label = "Short styles", size = 8) +
annotate(geom = "text", x = -1.2, y =-42 , label = "High poll. depend.", size = 8) + 
annotate(geom = "text", x = 1.95, y =-32 , label = "Long styles", size = 8) + 
annotate(geom = "text", x = 2.3, y =-42 , label = "Low poll. depend.", size = 8) +
xlab(" \n \n  ") +
annotate(geom = "text", x = 0.25, y =-20 , label = "Style length - Pollinator dependence axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2))
  

library(patchwork)

combined <- a1 + a2 + a3 + b1 + b2 + b3 + c1 + c2 + c3 + d1 + d2 + d3 & theme(legend.position = "right")
combined <- combined + plot_layout(guides = "collect",ncol = 3)

combined

setwd("~/Dropbox/PhD/R/Chapter_2")

saveRDS(combined, "Plot_apis_non_apis.rds")


```

