---
#title: \singlespacing \vspace{-2.5cm} \LARGE \textbf{Covariation among reproductive traits in flowering plants determine interactions with floral visitors}

output: 
  pdf_document:
    extra_dependencies: ["float"]
header-includes:
- \usepackage{pdflscape}
- \newcommand{\blandscape}{\begin{landscape}}
- \newcommand{\elandscape}{\end{landscape}}
- \usepackage{float}
- \usepackage{caption}
- \usepackage{setspace}\doublespacing
- \usepackage{soul}
- \floatplacement{figure}{H}
- \usepackage{afterpage}
- \usepackage{placeins}
- \usepackage{graphicx}
- \usepackage{floatpag}


fontsize: 12pt

---

```{r echo=FALSE,warning=FALSE}
knitr::opts_chunk$set(fig.pos = "h", out.extra = "")

```


\captionsetup[figure]{labelformat=empty}
\captionsetup[table]{labelformat=empty}
\captionsetup[table]{font={stretch=1.2}}     


\singlespacing

\vspace{2cm}

# Supplementary information for:

## Covariation among reproductive traits in flowering plants determine interactions with floral visitors

\textbf{Jose B. Lanuza*, Romina Rader, Jamie Stavert, Liam K. Kendall, Manu E. Saunders and Ignasi Bartomeus}

\textbf{*Corresponding author}
**E-mail: barragansljose@gmail.com**

**This pdf includes:**


Appendix S1 (text)

Tables S1 to S5

Figures S1 to S9



\doublespacing


<!--

__Supplementary text__

Description of the traits compiled in this study with an illustrative figure of the main flower morphologies (Supplementary text Fig 1)

\doublespacing
\singlespacing

__Supplementary Tables__

Supplementary Table S1: List of the 28 plant-pollinator studies used to build the plant trait database

Supplementary Table S2: Loadings of the first three axes of trait variation of the phylogenetic informed principal component analysis with the full set of species

Supplementary Table S3: Loadings of the first three axes of trait variation of the phylogenetic informed principal component analysis with the subset of species with data of nectar and pollen quantity 

Supplementary Table S4: Statistical association between the different categorical variables and the fisrt three main axes of trait variation with the full set of species

Supplementary Table S5: Phylogenetic signal of the different quantitative traits

\doublespacing
\singlespacing

__Supplementary Figures__

Supplementary Fig. S1: Percentage of present and missing values of the different plant traits

Supplementary Fig. S2: Phylogenetic informed principal component analysis for the species that did not have missing values

Supplementary Fig. S3: Fitted posterior estimates of the number of visits made by bees including and exluding honey bees on the main axes of trait variation

Supplementary Fig. S4: Regression tree analyses

Supplementary Fig. S5: PC1 and PC3 of the phylogenetically informed principal component analysis with the full set of species

Supplementary Fig. S6: Phylogenetic informed principal component analysis for the subset of species with floral rewards.

Supplementary Fig. S7: Statistical comparison of the different categories of qualitative traits on the main two axes of trait variation with the full set of species

Supplementary Fig. S8: Presence-absence of interaction and visitation rate of the main bee families on the main axes of trait variation

Supplementary Fig. S9:  Plant species level metrics across the three main axes of trait variation

Supplementary Fig. S10: Pearson correlation between the product of flower number-flower size and autonomous selfing level

-->

\newpage

## Appendix S1

__Description of the traits compiled in this study__

Here we describe the different individual traits that have been included in the database:

_Reproductive biology traits_

-	Breeding system: All species were classified in hermaphrodite, dioecious and monoecious species. Intermediate breeding systems or more complex ones were also annotated but all the species were divided into these three main categories for simplicity of the analysis.
 
-	Selfing level: We recorded the selfing level of the different species with both quantitative and qualitative data. The qualitative data was divided in four main categories, high selfers (76% to 100% of selfing), medium selfers (26% to 75%), low selfers (1% to 25%) and none (0%) which was for the species that were unable to self-pollinate. The quantitative column of selfing had a high percentage of missing values (68%) but we were able to solve this by converting the four categories from the qualitative column to numerical. For this, we considered the mean value of the different categories, that is the categories of ‘none’, ‘low’, ‘medium’ and ‘high’ represented 0%, 13%, 50.5% and 88% of selfing, respectively. This reduced the percentage of missing of this column from 68% to 35% and allowed the imputation of this variable.

-	Compatibility system: The different species were divided in three main categories in order to know their ability to self-pollinate. These categories were self-compatible, partially self-compatible and self-incompatible species. The field of selfing level is partly complementary to the compatibility system but is important to note that not all the self-compatible species or partially self-compatible species will self-pollinate.

_Floral traits_

-	Flower symmetry: Depending on the possible number of identical divisions of a flower, plant species were classified into zygomorphic (bilaterally symmetrical with only two identical parts) and actinomorphic (radially symmetrical with more than three identical parts).

-	Flower and inflorescence size: We searched for flower length and flower and inflorescence width (mm) for all species. When possible, we calculated the not found measurements with the help of online images and the software ImageJ. Note that for species with compound flowers (e.g., Asteraceae) or similar floral structures with flower heads with many small flowers we considered the inflorescence as the floral unit. For each species this is indicated in the dataset with the field of "info_level" where the measurement level is specified as capitulum or flower level. Note that for some Asteraceae species information about the disc and ray floret is also provided in the database but these were not included in our analyses. 

-	Flower number per plant: We compiled information about the number of flowers per plant for all species. However, this field was rare to find and we also used online images of the different species in order to calculate rough numbers of flowers per plant. We referenced all the filled fields in order to be able to follow the images that were used for these counts. It is important to note, that these numbers are not pretended to be the exact number of flowers per species but an approximate indicator of the reproductive investment for the different species that allow the macroecological analysis of this field.

-	Ovule number: We searched for the number of ovules per flower for all the different species. The number of ovules of Asteraceae species are considered as the total number of ovules per capitulum. Many species were filled by genus or family level because the number of ovules of some taxonomic groups is considered to be mostly constant (e.g., Lamiaceae, Boraginaceae or Apiaceae).
 
-	Flower morphology: We looked for images and illustrations of the flowers from the different species on the floras and available resources in order to categorize the flower shape. We divided the flowers in 8 main different categories: open, bowl, tube, campanulate, funnelform, papilionaceous, brush and capitulum. However, we ended up groupping all flowers on the following 6  morphological groups for analyses: tube, papilonaceous, open, capitulum, campanulate and brush (Supplementary Information Text Fig. 1).

```{r pressure, echo=FALSE, fig.cap="", out.width = '65%',fig.align='center', fig.cap="\\textbf{Supplementary Information Text Fig. 1.}  Main floral morphologies considered in this study. All species were groupped within these categories for analysis: (a) tube, (b) papilonaceous, (c) open, (d) capitulum, (e) campanulate and (f) brush."}
knitr::include_graphics("../Images/flower_shapes.png")
```


-	Style length: We searched for the length of the style (the pistil excluding the ovary and the stigma) in millimeters for all plant species. When the information about style length was missing, we tried to calculate it from images and illustrations from online resources (e.g., floras). 

- Nectar provision: We recorded the presence and absence of nectar for all species. In addition, we also searched for microlitres and milligrams of nectar per flower and nectar concentration. For species that did not have nectar information but belonged to a family that is considered as ‘nectarless’, this trait was recorded at family level and the species was recorded with ‘absence’ of nectar. This was done exclusively for well documented nectarless taxonomical groups. For the field of microlitres of nectar, we considered single measurements of nectar standing crop. Despite the timing and methodology of the different quantitative measurements of nectar differed across studies, these fields allowed us to have an approximate idea of the reproductive investment of the different plant species.

- Pollen grains per flower: For each species, we searched for the total number of pollen grains per flower. Because this fields was rarely available, we also tried to recover from pollen:ovule ratio information the total number of pollen grains by multiplying it by the average ovule number found for each species.

_Other life history traits_

- Life form, life span and plant height: We divided the different plant species in 4 main categories: herbs, vines, shrubs and trees. Moreover, we also divided the species between short-lived species (annual, biennial and short-lived perennials) and perennial species (long-lived). Finally, we also searched for the average height (m) of the different species and annotated the maximum and minimum height when possible. We conducted the average between the maximum and minimum height to get an approximate average height of the species when the average was not indicated.


\begin{landscape}


```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE,fig.align = "left"}
setwd("~/R_Projects/Reproductive Traits")
library(kableExtra)

#Create data.frame with references

`Number of networks` <- c("6", "2", "3", "1", "1", "1", "1", "2", "1", "1", "8", "16", "6", "2", "4", "1", "3", "1", "1", "1", "1", "1", "1", "1", "3", "1",
                          "1", "1")

#`Network structure` <- c(rep("Web", 22), rep("Metaweb",6))

`Network type` <- c(rep("Weighted web",  18), rep("Unweighted web",  4), "Weighted metaweb", "Unweighted metaweb", "Unweighted metaweb", "Unweighted metaweb", "Unweighted metaweb", "Weighted metaweb")


`First author` <- c("Bartomeus", "Dicks", "Dupont", "Elberling", "Fang", "Inouye", "Lundgren", "Olesen", "Small", "Souza", "Kaiser-Bunbury", "Bartomeus", 
                    "Kaiser-Bunbury", "Kaiser-Bunbury", "Peralta", "Burkle", "Arroyo-Correa", "Bundgaard", "Bek", "Kato", "Kevan", "Ramirez",
                    "Inouye","McMullen", "Primack", "Ramirez", "Robertson", "Traveset")

Year <- c(2008,2002,2003,1999,2008,1988, 2005,2002,1976,2017,2017,2008,2011,2010,2006,2013,2019,2003,2006,2000,1970,1989,1990, 1993, 1983, 1992, 1929, 2013)

#Country <- c("Spain", "England", "Denmark", "Sweden", "China", "Australia", "Greenland", "Mauritius and Azores", #"Canada", "Brasil", "Seychelles", "Spain", "Seychelles",
#"Mauritius", "Argentina", "USA", "New Zealand", "Denmark",  "Denmark", "Japan", "Canada", "Venezuela", "Japan", #"Ecuador", "New Zealand", "Venezuela",
#"USA", "Ecuador")

DOI <- c("https://doi.org/10.1007/s00442-007-0946-1", "https://doi.org/10.1046/j.0021-8790.2001.00572.x", "https://doi.org/10.1111/j.1365-2656.2008.01501.x",
"https://doi.org/10.1111/j.1600-0587.1999.tb00507.x", "https://doi.org/10.1111/1749-4877.12190", "https://doi.org/10.1111/j.1442-9993.1988.tb00968.x",
"https://doi.org/10.1657/1523-0430(2005)037[0514:TDAHCW]2.0.CO;2", "https://doi.org/10.1046/j.1472-4642.2002.00148.x",
"/13960/t4km08d21", "https://doi.org/10.1111/1365-2745.12978", "https://doi.org/10.1038/nature21071", "https://github.com/ibartomeus/BeeFunData",
"https://doi.org/10.1111/j.1365-2745.2010.01732.x", "https://doi.org/10.1016/j.ppees.2009.04.001", "https://doi.org/10.1111/ele.13510",
"https://doi.org/10.1126/science.1232728", "https://doi.org/10.1111/1365-2745.13332", "Unpublished, Master thesis", "Unpublished, Master thesis", "http://hdl.handle.net/2433/156116",
"https://doi.org/10.2307/2258569", "https://doi.org/10.2307/2388282", "http://hdl.handle.net/2433/156099", "https://biostor.org/reference/244737", "https://doi.org/10.1080/0028825X.1983.10428561",
"https://doi.org/10.1111/j.1095-8339.1992.tb00294.x", "https://doi.org/10.5962/bhl.title.11538", "https://doi.org/10.1098/rspb.2012.3040")


references <- data.frame(`First author`, Year, `Number of networks`,`Network type`,   DOI)



colnames(references) <- c("First author", "Year", "Web N.",  "Network type",  "DOI")

library(dplyr)
 references %>%
 arrange(`First author`)%>%
kable("latex", longtable = T, booktabs = T,linesep = "\\addlinespace",
             caption = "\\textbf{Table S1. List of the 28 plant-pollinator studies used to build the plant trait database. Each study is shown with the first author that conducted the study, number of networks or metawebs that contains, type of information that contains (weighted or unweighted),  the structure (web or metaweb), year of publication and digital object identifier or permanent link for each study.}") %>%
  kable_styling(latex_options = c("repeat_header","striped"), font_size = 12, repeat_header_method="replace" ,full_width=F,position = "left") 

```

\end{landscape}


\pagebreak


```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.height=10, fig.width=10, fig.align='center'}


library(dplyr)
library(kableExtra)

setwd("~/R_Projects/Reproductive Traits")

d <- readRDS("Data/RData/table_categorical_tukey_test.rds")

#Again im getting the same error on this rmd so I run it on another one, save the dataframe and plot it here

#Plot table
#Add latex format in markdown

kable(d, longtable = T,"latex" , booktabs = T,linesep = "\\addlinespace", escape=FALSE, caption = "\\textbf{Table S2. Statistical association between the different categorical variables and the first three main axes of trait variation with the full set of species.}") %>%
  kable_styling(latex_options = c("repeat_header","striped"), font_size = 12, full_width=F,position = "center") 


```

\pagebreak


```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.height=10, fig.width=10, fig.align='center'}


library(dplyr)
library(kableExtra)

setwd("~/R_Projects/Reproductive Traits")

PC <- readRDS("Data/RData/phyl_pca_forest.rds")


dat <- PC$L[,c(1:3)]

#Create a row to add total percentage of variance explained by PC

percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

percen <- percentage[1:3]

dat <- rbind(dat, percen)

rownames(dat) <- c("Autonomous selfing", "Flowers per plant", "Flower width", "Style length", "Ovule number", "Plant height", "Explained variation")

dat <- as.data.frame(dat)

dat <- dat %>% mutate(across(is.numeric, ~ round(., 2)))

 kable(dat, longtable = T, booktabs = T,linesep = "\\addlinespace", escape=FALSE,  caption = "\\textbf{Table S3. Loadings of the first three axes of trait variation of the phylogenetic informed principal component analysis with the full set of species.}") %>%
  kable_styling(latex_options = c("repeat_header","striped"), font_size = 12, full_width=F,position = "center") 




```


\pagebreak



```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.height=10, fig.width=10, fig.align='center'}


library(dplyr)
library(kableExtra)

setwd("~/R_Projects/Reproductive Traits")

PC <- readRDS("Data/RData/phyl_pca_forest_nectar_pollen.rds")


dat <- PC$L[,c(1:3)]

#Create a row to add total percentage of variance explained by PC

percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

percen <- percentage[1:3]

dat <- rbind(dat, percen)

rownames(dat) <- c("Autonomous selfing", "Flowers per plant", "Flower width", "Style length", "Ovule number", "Plant height", "Microlitres of Nectar per flower" , "Pollen per flower","Explained variation")

dat <- as.data.frame(dat)

dat <- dat %>% mutate(across(is.numeric, ~ round(., 2)))

kable(dat, longtable = T,"latex", booktabs = T,linesep = "\\addlinespace", escape=FALSE,  caption = "\\textbf{Table S4. Loadings of the first three axes of trait variation of the phylogenetic informed principal component analysis with the subset of species with data of nectar and pollen quantity.}") %>%
  kable_styling(latex_options = c("repeat_header","striped"), font_size = 12, full_width=F,position = "center") 




```



\newpage


```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.height=10, fig.width=10, fig.align='center'}

library(kableExtra)

setwd("~/R_Projects/Reproductive Traits")

#SELFING
selfing <- readRDS("Data/RData/selfing_phylo.rds")
#FLOWER NUMBER
flower_n <- readRDS("Data/RData/flower_n_phylo.rds")
#INFLO WIDTH
inflow_width <- readRDS("Data/RData/inflow_width_phylo.rds")
#FLOWER WIDTH
flower_width <- readRDS("Data/RData/flower_width_phylo.rds")
#FLOWER LENGHT
flower_length <- readRDS("Data/RData/flower_length_phylo.rds")
#STYLE LENGTH
style_n <- readRDS("Data/RData/style_n_phylo.rds")
#OVULE NUMBER
ovule_n <- readRDS("Data/RData/ovule_n_phylo.rds")
#PLANT HEIGHT
plant_height <- readRDS("Data/RData/plant_height_phylo.rds")
#POLLEN
pollen <- readRDS("Data/RData/pollen_phylo.rds")
#Nectar ul
nectar_ul <- readRDS("Data/RData/Nectar_ul_phylo.rds")

#Not included at the end
#Nectar mg
#nectar_mg <- readRDS("Data/RData/Nectar_mg_phylo.rds")
#Nectar concentration
nectar_con <- readRDS("Data/RData/Nectar_concentration_phylo.rds")


#Select two decimals function
specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))
#LABELS
label <- c("Autonomous selfing", "Flower number", "Inflorescence width" ,"Flower width", "Flower length", "Style length", "Ovule number", "Plant height", "Nectar per flower ($\\mu$l)", "Nectar concentration ($\\%$)","Pollen grains per flower")
#LAMBDA
lambda <- c(selfing$lambda , flower_n$lambda, inflow_width$lambda, flower_width$lambda, flower_length$lambda, style_n$lambda, ovule_n$lambda, plant_height$lambda, nectar_ul$lambda, nectar_con$lambda, pollen$lambda)
#P-VALUE
p_value <- c(selfing$P , flower_n$P, inflow_width$P,flower_width$P, flower_length$P, style_n$P, ovule_n$P, plant_height$P,nectar_ul$P,  nectar_con$P, pollen$P)

tabla <- data.frame(label, specify_decimal(lambda,2), specify_decimal(p_value,2))

colnames(tabla) <- c("Functional traits", "Lambda", "P-value")

kable(tabla, "latex", longtable = T, booktabs = T,linesep = "\\addlinespace", escape=FALSE,caption = "\\textbf{Table S5. Phylogenetic signal of the different quantitative traits.}") %>%
  kable_styling(latex_options = c("repeat_header","striped"), font_size = 12, full_width=F,position = "center") 



```


\newpage
\blandscape


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE,fig.width=12, fig.height=6, fig.cap="\\textbf{Fig. S1.} Map with the different locations of the plant-pollinator studies used in this work to explore woldwide patterns at the meso-scale level. Note that for visualization purposes studies from the same authors are shown with the same colour."}


#Create coordinate dataset for plotting

longitude <- c("3.296797",  #1
               "1.575532", #2
               "9.275556", 
               "18.5", #4
               "99.63806", #5
               "148.266667",
               "-52", 
               "-31", "57.43", #8
               "-75.5", #9
               "-57.885", #10
               "55.447778",
               "-6.16895", #12bart
               "55.43333", #13
               "57.733333",
               "-68.015892", #15
               "-89.8968771",
               "171.756111",
               "10.233333",
               "-90.35",
               "-93.8968771",#Robertson
               "-67.4292900",
               "-61.71666666666667",
               "175.756111",
               "-71.3",
               "129.387359", #Kevan
               "135.75385",
               "-93.35",
               "10.219072")  

latitude <- c("42.315336", #1
              "52.762395", #2
              "56.0725",
              "68.35", #4
              "27.90139", #5
              "-36.45", #6
              "71", #7
              "39.4", "-23.25", #8 #modified for visibility of ovelapping
              "45.4", #9
              "-21.701111", #10
              "-7.67",#11 #modified for visibility of ovelapping
              "37.234966", #12bart
              "-4.666667", #13
              "-20.4538",
              "-32.008985", #15
              "39.278958",
              "-43.035889",
              "59.066667",#18 #modified for visibility of ovelapping
              "-0.533333",
              "39.278958", #Robertson 
              "8.9241600",
              "5.5833333",
              "-43.035889",
              "81.8166667",
              "28.288661", #Kevan 
              "35.02107",
              "-0.533333",
              "56.069108") 

id <- c("Bartomeus1", #1
        "Dicks", #2
        "Dupont", 
        "Elberling", #4
        "Fang", #5
        "Inouye1", #6
        "Lundgren", #7
        "Olesen", "Olesen", #8
        "Small", #9
        "Souza", #10
        "Kaiser-Bunbury1", #
        "Bartomeus2", #12
        "Kaiser-Bunbury2", #13
        "Kaiser-Bunbury3", #14
        "Peralta", #15
        "Burkle",
        "Arroyo-Correa",
        "Bundgaard",
        "Traveset",
        "Robertson",
        "Ramirez1",
        "Ramirez2",
        "Primack",
        "Kevan",
        "Kato",
        "Inouye2",
        "McMullen",
        "Baek")

d <- data.frame(longitude, latitude, id)

library("ggplot2")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")

world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)

d$longitude <- as.numeric(d$longitude)
d$latitude <- as.numeric(d$latitude)

sf::sf_use_s2(FALSE)

#these colors come from the library(pals)- labs = c('alphabet')


colors <- c("red4", "#0075DC", "#4C005C", "#4C005C", "#993F00",  "#5EF1F2", 
        "#005C31", "#2BCE48", "black", "lightblue", "darkorange3", "darkorange3","#8F7C00",
        "#8F7C00","#8F7C00", "#9DCC00", "#C20088", "gold1","#FFA8BB","#426600","94FFB5","#003380",  
         "#FF0010","#FF0010", "salmon", "seashell3","greenyellow","mediumaquamarine")

set.seed(12)
ggplot(data = world) +
  geom_sf(fill="antiquewhite", color="grey49") +
  xlab("Longitude") + ylab("Latitude") +
  geom_point(data=d , aes(longitude,latitude,  color=id),  shape=10,
           size = 4.5, stroke=1)+ 
  theme(panel.grid.major = element_line(color = gray(.5), 
linetype = "dashed", size = 0), panel.background = element_rect(fill = "aliceblue"))+
  coord_sf(expand = FALSE) +  scale_y_continuous(breaks = c(-50,0, 50)) +
  scale_x_continuous(breaks = c(-100,0, 100)) +
  theme(legend.key.size = unit(0.6, 'cm'), legend.text = element_text(size=10),
         legend.title = element_text(size=12)) +   scale_colour_manual(values = colors) + labs(colour="Plant-pollinator studies")
  



```


\elandscape

\newpage



```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE,dpi=2000,  fig.cap="\\textbf{Fig. S2.} Percentage of present and missing values of the different plant traits."}

#Set working directory
setwd("~/R_Projects/Reproductive Traits")

########################################################################################################################################################
#SCRIPT FOR DATA IMPUTATION
########################################################################################################################################################
#1) READ TRAIT DATA

#2) CLEAN DATA AND RENAME LEVELS

#3) EXPLORE PATTERNS OF MISSING DATA

#4) CALCULATE PHYLOGENETIC DISTANCE TO CORRECT WITH EIGENVALUES IN THE IMPUTATION

#5) ICLUDE EIGENVALUES IN RAWDATA TO IMPROVE IMPUTATION OURPUT

#6) IMPUTE DATA 

#7) SAVE IMPUTED DATA 
########################################################################################################################################################
#LOAD LIBRARIES
library(readxl) #read excel file (trait data)
library(dplyr) #data manipulation
library(missMDA) #For missing values
library(FactoMineR) #Produce pca biplot with individuals and variables
library(factoextra)
library(ggpubr) 
library(missForest) #random forst imputation
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(ape)
library(PVR) #calculate eigen vectors and add them as a column in the imputation, seems to improve output
library(visdat) #VISUALIZE MISSING DATA
library(naniar)
library(tidyverse)
########################################################################################################################################################
#1) READ TRAIT DATA
########################################################################################################################################################
#load data
trait_data <- read_excel("Data/Trait_data_raw/Trait_data_final.xlsx",na = "NA")
########################################################################################################################################################
#2) A) CLEAN DATA AND B) RENAME LEVELS FOR IMPUTATION 
########################################################################################################################################################
#####
#A) CLEAN DATA
#####
#select just filled rows
trait_data_1 <- trait_data[1:1712,] #It may be a more elegant way but this does the job, 1712 rows of data

str(trait_data_1)
#filter data, select species with flower level info and capitulum
trait_filtered <- filter(trait_data_1, Info_level == "flower" |  Info_level == "capitulum")
levels(as.factor(trait_filtered$Info_level)) #checking levels
#remove NA's and duplicated species|Some spp are repeated once the spp names are standardize with taxize
trait_filtered$Species_all[trait_filtered$Species_all=="NA"]<-NA 
trait_filtered_1 <- trait_filtered[!is.na(trait_filtered$Species_all),]
trait_filtered_2 <- trait_filtered_1[!duplicated(trait_filtered_1$Species_all),]
str(trait_filtered_2)

#Select columns to work with
t <- trait_filtered_2[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system",
                        "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
                        "Flowers_per_plant", "Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
                        "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration",
                        "Pollen_per_flower")]


########################################################################################################################################################
#####
#B) RENAME LEVELS FOR IMPUTATION
#####
#Breeding_system| For the purpose of this study we are not going to consider other complex breeding systems and just focus on 
#Hermaphroditism, dioecy and monoecy, the closest levels are grouped within each category
t$Breeding_system <- as.character(t$Breeding_system)
t$Breeding_system[t$Breeding_system=="androdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="androgynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="andromonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="gynoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="monoecious_dioecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="polygamo-dioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="protandrous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="protogynous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="subdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="submonoecious"] <- "monoecious"
#Change to capital letters| There are already levels with lower case
t$Breeding_system[t$Breeding_system=="monoecious"] <- "Monoecious"
t$Breeding_system[t$Breeding_system=="dioecious"] <- "Dioecious"
t$Breeding_system[t$Breeding_system=="hermaphrodite"] <- "Hermaphrodite"
levels(as.factor(t$Breeding_system))
t$Breeding_system <- as.factor(t$Breeding_system)

#Now 3 levels
#Flower_morphology
t$Flower_morphology <- as.character(t$Flower_morphology)
t$Flower_morphology[t$Flower_morphology=="bowl"] <- "open"
t$Flower_morphology[t$Flower_morphology=="dish"] <- "open"
t$Flower_morphology[t$Flower_morphology=="exposed"] <- "open"
t$Flower_morphology[t$Flower_morphology=="spadix"] <- "spike"
t$Flower_morphology[t$Flower_morphology=="open"] <- "Open"
t$Flower_morphology[t$Flower_morphology=="brush"] <- "Brush"
t$Flower_morphology[t$Flower_morphology=="campanulate"] <- "Campanulate"
t$Flower_morphology[t$Flower_morphology=="capitulum"] <- "Capitulum"
t$Flower_morphology[t$Flower_morphology=="funnelform"] <- "Funnelform"
t$Flower_morphology[t$Flower_morphology=="papilionaceous"] <- "Papilionaceous"
t$Flower_morphology[t$Flower_morphology=="spike"] <- "Spike"
t$Flower_morphology[t$Flower_morphology=="tube"] <- "Tube"
levels(as.factor(t$Flower_morphology))
t$Flower_morphology <- as.factor(t$Flower_morphology)

#Life span
t$lifespan <- as.character(t$lifespan )
t$lifespan[t$lifespan=="annual"] <- "short_lived"
t$lifespan[t$lifespan=="biennial"] <- "short_lived"
t$lifespan[t$lifespan=="short_lived"] <- "Short lived"
t$lifespan[t$lifespan=="perennial"] <- "Perennial"
levels(as.factor(t$lifespan))
t$lifespan <- as.factor(t$lifespan )

########################################################################################################################################################
#3) EXPLORE PATTERNS OF MISSING DATA
########################################################################################################################################################
#Explore patterns of missing data
missing_data <- unlist(lapply(t, function(x) sum(is.na(x))))/nrow(t)
sort(missing_data[missing_data >= 0], decreasing=T)
#nectar values all above 50% except presence/absence
#then, just one cololumn with 68% missing data, then one with 35% and then 20% and 10%. The rest under 5%.
#it is recommended to remove columns over 50% but we are particulary interested in having numeric levels of quantitative selfing 
#we are going to work just with presence/absence of nectar
#we will perform further analysis just with a subset with the quantitative values o nectar (very interesting data and diffciult to obtain)


#We convert cualitative data to quantitative to reduce missing data on this column and hence conduct the imputation 
#use ifelse base r does not work with these NA'S Even with work around. base r does not like the na option of read excel
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("high") & is.na(t$Autonomous_selfing_level_fruit_set), 88, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("medium") & is.na(t$Autonomous_selfing_level_fruit_set), 50.5, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("low") & is.na(t$Autonomous_selfing_level_fruit_set), 13, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("none") & is.na(t$Autonomous_selfing_level_fruit_set), 0, t$Autonomous_selfing_level_fruit_set)

#t$Nectar_ul adding it here just to see how many cells 
#Now we just select presence/absence of nectar
#select columns of interest
t <- t[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system",
         "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
         "Flowers_per_plant", "Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
         "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration",
         "Pollen_per_flower")]





#check missing data now
missing_data <- unlist(lapply(t, function(x) sum(is.na(x))))/nrow(t)*100
sort(missing_data[missing_data >= 0], decreasing=T)


missing_data <- unlist(lapply(t, function(x) nrow(t)-sum(is.na(x))))
sum(missing_data)

#Number of missing values on the datset
#vis_miss(t[,c(6:20)])
#9.9% percentage of missing values]

#Checking number of filled cells/ just selecting variables used in the manuscript; nectar ul should be accounted too and it has been considered but
#not added to run this code

########################################################################################################################################################
#4) CALCULATE PHYLOGENETIC DISTANCE TO CORRECT WITH EIGENVALUES IN THE IMPUTATION
########################################################################################################################################################
#Convert to factor 
cols <- c("Order_all", "Family_all", "Genus_all", "Species_all", "Compatibility_system", "Autonomous_selfing_level", "Flower_morphology",
          "Flower_symmetry", "life_form", "lifespan","Nectar_presence_absence")
t[cols] <- lapply(t[cols], factor)  ## as.factor() could also be used
str(t)


#Impute data considering phylogenetic distance of species
#it improves quality of imputation
#https://doi.org/10.1111/2041-210X.12232 see ref for method comparisons with and without imputation

#Multiple imputation process with phylogeny --> Missforest
#https://doi.org/10.1111/2041-210X.12232
#althought it does not have an option we are going to add it as a column

#Before data imputation I need to calculate the phylo of the species
#remove not found species that do not run with get tree
cols.num <- c("Family_all","Genus_all","Species_all")
t[cols.num] <- sapply(t[cols.num],as.character)
t$Species_all <- gsub("Species_all_", "", t$Species_all)

t <- t[!t$Species_all == "Pinus luchuensis", ]   # remove gymnosperm species

#remove species that are not until species level
#ALL THE SPECIES WITH SP. ARE DELETD
t$Species_geonet <- gsub("M_PL_.*","",t$Species_geonet) #subsitute partial string for nothing
t$Species_geonet <- gsub(" $","", t$Species_geonet, perl=T) #remove trailing spaces
t$Species_geonet <-  sub('sp.1$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp.2$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp$', 'sp.', t$Species_geonet) #PREPARE ALL SP TO SP.
t$Species_geonet <- sub("sp.$", "DELETE", t$Species_geonet) #change all sp. for DELETE
t <- t[- grep("DELETE",  t$Species_geonet),] #remove species with "DELETE"
#CHECK LEVELS
levels(factor(t$Species_all))

#Make these NA's as NA
t$Species_all[t$Species_all=="NA"] <- NA
t$Family_all[t$Family_all=="NA"] <- NA
t$Genus_all[t$Genus_all=="NA"] <- NA
#remove NA's
t <- t[!is.na(t$Family_all),]
t <- t[!is.na(t$Species_all),]
t <- t[!is.na(t$Genus_all),]

#Select just columns with traits
t <- t[c("Breeding_system","Compatibility_system",
                        "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
                        "Flowers_per_plant", "Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
                        "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration",
         "Pollen_per_flower")]


#################################################
#3)SUMMARY OF THE DATA|ALL COLS CONSIDERED!
#################################################
##Number of filled cells
#nrow(t) * 16 - sum(is.na(t))#[1] 20737
##Dimension of the dataset
#nrow(t) * 16#[1] 24096
##Number of missing values
#sum(is.na(t))#[1] 3359
##Percentage of filled cells
#sum(!is.na(t))/(sum(is.na(t))+sum(!is.na(t)))*100#[1] 86.87993
##Percentage of missing values
#sum(is.na(t))/(sum(is.na(t))+sum(!is.na(t)))*100#[1] 13.12007
#
#

#Function to specify number of decimals
specify_decimal <- function(x, k) trimws(format(round(x, k), nsmall=k))


no_missing <- specify_decimal(sum(!is.na(t))/(sum(is.na(t))+sum(!is.na(t)))*100,2)
missing <- specify_decimal(sum(is.na(t))/(sum(is.na(t))+sum(!is.na(t)))*100,2)


colnames(t) <- c("Breeding system","Compatibility system",
         "Autonomous selfing qualitative","Autonomous selfing quantitative", "Flower shape", "Flower symmetry", 
         "Flower number per plant", "Inflorescence width", "Flower width", "Flower length","Style length", "Ovule number", 
         "Life form", "Lifespan","Plant height","Nectar qualitative","Nectar per flower (microlitres)", "Nectar per flower (miligrames)", "Nectar concentration (%)", "Pollen grains per flower")



missing.values <- t %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)


levels <-
  (missing.values  %>% filter(isna == T) %>% arrange(desc(pct)))$key

percentage.plot <- missing.values %>%
  ggplot() +
  geom_bar(aes(x = reorder(key, desc(pct)), 
               y = pct, fill=isna), 
           stat = 'identity', alpha=0.8) +
  scale_x_discrete(limits = levels) + theme_bw()+
  scale_fill_manual(name = "", 
                    values = c('#57a340', '#d24513'), labels = c("Present values", "Missing values")) +
  coord_flip() +
  labs(title = "", x =
         '', y = "")+  scale_y_continuous(labels = function(x) paste0(x*1, "%")) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=1))


percentage.plot


```


\newpage


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE,fig.height=20, fig.width=10,out.width="60%",fig.align='center',fig.cap= "\\textbf{Fig. S3.} Comparison of the phylogenetic informed principal component analysis for the dataset with data imputation and without data imputation. Panel 'a' shows the reproductive spectrum of trait variation for the full dataset with data imputation and panel 'b' shows the reproductive spectrum for the dataset without data imputation where the species with missing trait data were excluded from the analysis."}

setwd("~/R_Projects/Reproductive Traits")

#Load libraries
library(viridis) #COLOUR GGPLOT
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
library(magick)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#Images were made by Paula Martin
#Check her work on https://paulamartinart.com/

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence - Floral display axis ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  
#ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.7,5.05,5.6,7.85,7.3,6.15)), y = -(PCAloadings$PC2*c(4.693,2.5,3.1,6.6,5,5.5)+c(0,0,0,0,0.4,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4.5)
  
 
# plot <- plot + annotate("text", x = #(PCAloadings$PC1*c(4.6,4.95,4.5,6.6,7.3,5.15)), y = #(PCAloadings$PC2*c(3.83,6.4,5.7,7.4,-1,7.45)+c(0,0,0,0,-0.41,0))#,
#                         label =c("Low selfing", "Few flowers", #"Small flowers", "Short styles", "Few ovules", "Short plants" ), #color="black",fontface =2,size=4)
 
 
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

p1 <- all_spp(PC)


#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_complete_cases.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest_complete_cases.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
#PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_complete_cases <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.015, 0.03, 0.07), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.6),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=-v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence - Floral display axis ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() 
      #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = (PCAloadings$PC1*c(4.6,5.2,5,5.25,6.3,6)), y = -(PCAloadings$PC2*c(4,4.75,4,4.5,5,5.5)+c(0,0,0,0,-0.04,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4.5)
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

p2 <- all_complete_cases(PC)

library(patchwork)

p1 / p2 + plot_annotation(tag_levels = c('a'), tag_prefix = '(', tag_sep = '', tag_suffix = ')')  & theme(plot.tag = element_text(size = 24, face="bold"))


```


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=20, fig.width=10,out.width="60%",fig.align='center',fig.cap="\\textbf{Fig. S4.} Comparison of the phylogenetic informed principal component analysis for the subset of species that had information of floral rewards with data imputation and without data imputation. Panel A shows the reproductive spectrum of trait variation for the dataset with data imputation and panel B shows the reproductive spectrum for the dataset excluding species with missing trait data"}
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
phyl_pca_forest_nectar_pollen <- readRDS("Data/RData/phyl_pca_forest_nectar_pollen.rds")
dat_cleaning_7 <- readRDS("Data/RData/data_all_species_PPCA_nectar_pollen.rds")

PC <- phyl_pca_forest_nectar_pollen
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

library(magick)

#Images were made by Paula Martin
PC$S[,1] <- -PC$S[,1]

PC$S[,2] <- -PC$S[,2]

all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density

  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon',bins=8) + 
    scale_fill_continuous(low="green",high="red",guide=FALSE,lim=c(0.01,0.082),breaks = c(0.02, 0.035, 0.082), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.6),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
  plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  
  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence - Floral display ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  
  
  #CHANGE THEME
  
  plot <- plot + theme_bw() 
  
  #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants", "Copious nectar","Copious pollen")
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.85,4.8,4.8,5.5,5.5,5.5,5.8,6.5)), y = -(PCAloadings$PC2*c(4.8,4.4,4.15,5.35,4.2,4.7,5.75,6)+c(0,0,0,0,0,0,0,0)),
                          label = PCAloadings$Variables, color="black",fontface =2,size=4.5)
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

p1 <- all_spp(PC)




#Load data
phyl_pca_forest_nectar_pollen <- readRDS("Data/RData/phyl_pca_forest_nectar_pollen_complete_cases.rds")
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA_nectar_pollen_complete_cases.rds")



PC <- phyl_pca_forest_nectar_pollen
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_spp_complete <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  
  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon',bins=8) + 
    scale_fill_continuous(low="green",high="red",guide=FALSE,lim=c(0.01,0.082),breaks = c(0.02, 0.035, 0.082), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.6),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
  plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  
  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence - Floral display axis ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  
  
  #CHANGE THEME
  
  plot <- plot + theme_bw() 
  
  #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants", "Copious nectar","Copious pollen")
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,4.8,5.4,5,4.2,5.8,3.4)+c(0,0,0,0,0,0,0,0)), y = -(PCAloadings$PC2*c(4.693,3.5,4,4,3,4.15,4.2,6.5)),
                          label = PCAloadings$Variables, color="black",fontface =2,size=4.5)
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

p2 <- all_spp_complete(PC)

library(patchwork)

p1 / p2 + plot_annotation(tag_levels = c('a'), tag_prefix = '(', tag_sep = '', tag_suffix = ')') & 
  theme(plot.tag = element_text(size = 24, face="bold"))

```


\newpage


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=24, fig.width=24,  fig.cap="\\textbf{Fig. S5.} Fitted posterior estimates of the interaction (yes/no) and number of visits made by bees including and exluding honey bees on the main axes of trait variation. The superior panel (plots a, b c, d, e and f) shows the comparison for presence-absence and the lower panel (plots g, h, i, j, k and l) the comparison for visitation rates."} 

library(Rcpp)
library(patchwork)
library(ggplot2)
library(tidyr)
#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2.2)),
           axis.text=element_text(size = rel(2), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.8, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank()
     ))
}


setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github

#This file is produced on otehr Rmd the brms fuucntions didn't work here... Weird segfault error that I wasn't able to solve

plot_apis <- readRDS("Plot_apis_non_apis.rds")

plot_apis

```




\newpage


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10, fig.width=10, fig.cap="\\textbf{Fig. S6.} Phylogenetically informed principal component analysis (pPCA) for all plant species with the first (flower number - flower size axis) and third (style length - pollinator dependence axis) principal component that explained most trait variation."}
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L


#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,3] <- -PC$S[,3]


pc3 <- function(PC, x="PC1", y="PC3") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Style length - Pollinator dependence axis ", "(",(percentage[3]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() #+ annotation_raster(tree_1, xmin = -4.1, xmax = -2.85,ymin = 2.05, ymax = 4.05)+
 #  annotation_raster(style_l_1, xmin = 2.05, xmax = 2.85,ymin = 2.35, ymax = 3.5) +
 # annotation_raster(style_s_1, xmin = -2.6, xmax = -1.9,ymin = -2.65, ymax = -1.7) +
 # annotation_raster(ovule_h_1, xmin = 3.5, xmax = 4.2,ymin = -0.45, ymax = 0.50) +
 # annotation_raster(ovule_l_1, xmin = -4.2, xmax = -3.5,ymin = -0.45, ymax = 0.5) +
 # annotation_raster(selfing_n_1, xmin = -0.75, xmax = 1.2,ymin = 1.8, ymax = 4.5) +
 # annotation_raster(selfing_h_1, xmin = -0.30, xmax = 0.15,ymin = -3.9, ymax = -3.1) +
 # annotation_raster(single_flower_1, xmin = 3.3, xmax = 4.1,ymin = -1.7, ymax = -0.7) +
 # annotation_raster(many_flowers_1, xmin = -4.20, xmax = -3.40,ymin = 0.8, ymax = 1.45) +
 # annotation_raster(large_flower_1, xmin = 3.15, xmax = 4.15,ymin = 1.3, ymax = 2.55) +
 # annotation_raster(flower_small_1, xmin = -3.50, xmax = -2.55,ymin = -2.1, ymax = -1.60) +
 # annotation_raster(herb_1, xmin = 2.6, xmax = 3,ymin = -2.8, ymax = -2) 


    
      #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower number", "Flower Size", "Style length", "Ovule number", "Plant height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5.5,4.8,7.1,5.5)), y = -(PCAloadings$PC2*c(-3.2,4.5,3.75,8.4,5,5.5)+c(0,0,0,0,-0.08,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4.5)
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

pc3(PC)



```

\newpage
\thispagestyle{empty}

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=19, fig.width=13, fig.cap="\\textbf{Fig. S7.} Statistical comparison of the different categories of qualitative traits on the main two axes of trait variation with the full set of species. Categories that differ significantly are denoted with a different letter."}


########################################################################################################################################################
#CORRELATION BETWEEN QUALITATIVE VARIABLES AND PC's
########################################################################################################################################################
#NOTES
#I did not include the qualitative variables when I prepare the data for the PPCA
#So I have to recalculate the ata here with the qualitative variables
########################################################################################################################################################
#LOAD LIBRARIES
library(emmeans)
library(ggplot2)
library(patchwork)
library(dplyr)

theme_ms <- function(base_size=10, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(1.3)),
           axis.text=element_text(size = rel(1.1), color = "black"),
           panel.border=element_rect(color="black",size=1.2),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           legend.position = "none",
           plot.title = element_text(face = "bold",size = rel(1.55)),
           plot.subtitle = element_text(face = "bold",size = rel(1.4))
     ))
}

########################################################################################################################################################
setwd("~/R_Projects/Reproductive Traits")

#LOAD DATA
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")
dat <- read.csv("Data/Csv/all_species_imputed_trait_data_forest_data.csv", row.names = "X")
########################################################################################################################################################
#remove not found species, cannot do PCA with unequal numbers of rows
cols.num <- c("Family_all","Genus_all","Species_all")
dat[cols.num] <- sapply(dat[cols.num],as.character)
dat$Species_all <- gsub("Species_all_", "", dat$Species_all)
########################################################################################################################################################
#3) REMOVE OUTLIERS, OUT OF 2.5-97.5 RANGE WHICH HELPS IMPUTATION PROCESS. SEE ARTICLE FOR REF.
########################################################################################################################################################
dat_cleaning <- dat[,]
#CHECK LEVELS

dat_cleaning_1 <- dat_cleaning %>%
  filter(between(Flowers_per_plant, quantile(Flowers_per_plant, 0.025), quantile(Flowers_per_plant, 0.975)))

dat_cleaning_2 <- dat_cleaning_1 %>%
  filter(between(Corolla_diameter_mean, quantile(Corolla_diameter_mean, 0.025), quantile(Corolla_diameter_mean, 0.975)))

dat_cleaning_3 <- dat_cleaning_2 %>%
  filter(between(Style_length, quantile(Style_length, 0.025), quantile(Style_length, 0.975)))

dat_cleaning_4 <- dat_cleaning_3 %>%
  filter(between(Ovule_number, quantile(Ovule_number, 0.025), quantile(Ovule_number, 0.975)))

dat_cleaning_5 <- dat_cleaning_4 %>%
  filter(between(Plant_height_mean_m, quantile(Plant_height_mean_m, 0.025), quantile(Plant_height_mean_m, 0.975)))


final_d <- dat_cleaning_5[,]

pca_data <- as.data.frame(phyl_pca_forest$S)

d <- cbind(final_d, pca_data)

#Prepare qualitative variables
d$Compatibility_system[d$Compatibility_system=="dioecious"] <- "Unisexual flowers"
d$Compatibility_system[d$Compatibility_system=="monoecious"] <- "Unisexual flowers"
d$Compatibility_system[d$Compatibility_system=="partially_self_compatible"] <- "Partially self compatible"
d$Compatibility_system[d$Compatibility_system=="self_compatible"] <- "Self compatible"
d$Compatibility_system[d$Compatibility_system=="self_incompatible"] <- "Self incompatible"
d$Compatibility_system <- factor(d$Compatibility_system, levels = c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

d$life_form[d$life_form=="herb"] <- "Herb"
d$life_form[d$life_form=="shrub"] <- "Shrub"
d$life_form[d$life_form=="tree"] <- "Tree"
d$life_form[d$life_form=="vine"] <- "Shrub"

d$Flower_symmetry[d$Flower_symmetry=="actinomorphic"] <- "Actinomorphic"
d$Flower_symmetry[d$Flower_symmetry=="zygomorphic"] <- "Zygomorphic"

d$Flower_symmetry[d$Flower_symmetry=="Funnelform"] <- "Campanulate"
d$Flower_symmetry[d$Flower_symmetry=="Spike"] <- "Brush"


d$Flower_morphology[d$Flower_morphology=="Funnelform"] <- "Campanulate"
d$Flower_morphology[d$Flower_morphology=="Spike"] <- "Brush"

d$Nectar_presence_absence[d$Nectar_presence_absence=="yes"] <- "Yes"
d$Nectar_presence_absence[d$Nectar_presence_absence=="no"] <- "No"

#The other qualitative are ok

#All principal components are normally distributed
#Convert to factor before running model
d[sapply(d, is.character)] <- lapply(d[sapply(d, is.character)], as.factor)

#Run model
model1 <- lm(PC1 ~ Breeding_system + Compatibility_system + lifespan + life_form + Flower_morphology + Flower_symmetry + Nectar_presence_absence, d)
model2 <- lm(PC2 ~ Breeding_system + Compatibility_system + lifespan + life_form + Flower_morphology + Flower_symmetry + Nectar_presence_absence, d)

####################################################################################################################################################################################################################################
#1) BREEDING SYSTEM
####################################################################################################################################################################################################################################
model_breeding_1 <- emmeans(model1, "Breeding_system")
breeding_1 <- as.data.frame(model_breeding_1[1:3])
breed1 <- multcomp::cld(model_breeding_1, alpha = 0.10, Letters = LETTERS)


breed_1 <- ggplot(breed1,aes(x= Breeding_system,y= emmean,
               label = .group)) +theme_minimal()+
  geom_point(data = breed1, aes(x = Breeding_system, y = emmean, color = Breeding_system),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Breeding_system),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("forestgreen","orange", "black"))+ labs(title = "PC1",subtitle = "(a) Breeding system")+
  theme(plot.title = element_text(hjust=0.5, size=26, face="bold"), plot.subtitle=element_text(size=16))+
  geom_text(nudge_x = c(0), nudge_y = c(0.5),color   = "black")


model_breeding_2 <- emmeans(model2, "Breeding_system")
breeding_2 <- as.data.frame(model_breeding_2[1:3])
breed2 <- multcomp::cld(model_breeding_2, alpha = 0.10, Letters = LETTERS)

breed_2 <- ggplot(breed2,aes(x= Breeding_system,y= emmean,
             label = .group)) +theme_minimal()+
  geom_point(data = breed2, aes(x = Breeding_system, y = emmean, color = Breeding_system),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Breeding_system),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("forestgreen","orange", "black")) + labs(title = "PC2",subtitle = "(b) Breeding system")+
  theme(plot.title = element_text(hjust=0.5,size=26, face="bold"),plot.subtitle=element_text(size=16))+
  geom_text(nudge_x = c(0), nudge_y = c(0.35),color   = "black")


########################################################################################################################################################
#2) COMPATIBILITY
########################################################################################################################################################
model_com <- emmeans(model1, "Compatibility_system")

d <- as.data.frame(model_com[1:4])
comp1 <- multcomp::cld(model_com, alpha = 0.10, Letters = LETTERS)

comp_1 <- ggplot(comp1,aes(x= Compatibility_system,y= emmean,
  label = .group)) +theme_minimal()+
  geom_point(data = comp1, aes(x = Compatibility_system, y = emmean, color = Compatibility_system),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Compatibility_system),
  width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("cyan4", "deepskyblue2","orange","gray7")) +  labs(title =  "(c) Compatibility system")+
  geom_text(nudge_x = c(0), nudge_y = c(0.45),color   = "black") + theme(axis.text = element_text( size = rel(1)))

model_com <- emmeans(model2, "Compatibility_system")
d <- as.data.frame(model_com[1:4])
comp2 <- multcomp::cld(model_com, alpha = 0.10, Letters = LETTERS)

comp_2 <- ggplot(comp2,aes(x= Compatibility_system,y= emmean,
  label = .group)) +theme_minimal()+
  geom_point(data = comp2, aes(x = Compatibility_system, y = emmean, color = Compatibility_system),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Compatibility_system),
  width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("cyan4", "deepskyblue2","orange","gray7")) +  labs(title =  "(d) Compatibility system")+
  geom_text(nudge_x = c(0), nudge_y = c(0.45),color   = "black") + theme(axis.text = element_text( size = rel(1)))



########################################################################################################################################################
#3) LIFESPAN
########################################################################################################################################################
model_lif_1 <- emmeans(model1, "lifespan")
lif_1 <- as.data.frame(model_lif_1[1:2])
lif_1 <- multcomp::cld(model_lif_1, alpha = 0.10, Letters = LETTERS)

lifespan_1 <- ggplot(lif_1,aes(x= lifespan,y= emmean,
             label = .group)) +theme_minimal()+
  geom_point(data = lif_1, aes(x = lifespan, y = emmean, color = lifespan),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = lifespan),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("sienna4","forestgreen")) +  labs(title =  "(e) Lifespan")+
  geom_text(nudge_x = c(0), nudge_y = c(0.35),color   = "black")



model_lif_2 <- emmeans(model2, "lifespan")
lif_2 <- as.data.frame(model_lif_2[1:2])
lif_2 <- multcomp::cld(model_lif_2, alpha = 0.10, Letters = LETTERS)

lifespan_2 <- ggplot(lif_2,aes(x= lifespan,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = lif_2, aes(x = lifespan, y = emmean, color = lifespan),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = lifespan),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("sienna4","forestgreen"))+  labs(title =  "(f) Lifespan")+
  geom_text(nudge_x = c(0), nudge_y = c(0.32),color   = "black")



########################################################################################################################################################
# 4) LIFE FORM
########################################################################################################################################################

model_lif_1 <- emmeans(model1, "life_form")
lif_1 <- as.data.frame(model_lif_1[1:3])
lif_1 <- multcomp::cld(model_lif_1, alpha = 0.10, Letters = LETTERS)

lifeform_1 <- ggplot(lif_1,aes(x= life_form,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = lif_1, aes(x = life_form, y = emmean, color = life_form),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = life_form),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("forestgreen", "darkorange2","gray7"))+ labs(title  = "(g) Life form")+
  geom_text(nudge_x = c(0), nudge_y = c(0.5),color   = "black")


model_lif_2 <- emmeans(model2, "life_form")
lif_2 <- as.data.frame(model_lif_2[1:3])
lif_2 <- multcomp::cld(model_lif_2, alpha = 0.10, Letters = LETTERS)

lifeform_2 <- ggplot(lif_2,aes(x= life_form,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = lif_2, aes(x = life_form, y = emmean, color = life_form),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = life_form),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("forestgreen", "darkorange2","gray7")) + labs(title =  "(h) Life form")+
  geom_text(nudge_x = c(0), nudge_y = c(0.5),color   = "black")


########################################################################################################################################################
# 5) FLOWER MORPHOLOGY
########################################################################################################################################################
model_flo_1 <- emmeans(model1, "Flower_morphology")
flo_1 <- as.data.frame(model_flo_1[1:6])
flo_1 <- multcomp::cld(model_flo_1, alpha = 0.10, Letters = LETTERS)

shape_1 <- ggplot(flo_1,aes(x= Flower_morphology,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = flo_1, aes(x = Flower_morphology, y = emmean, color = Flower_morphology),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Flower_morphology),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("blue","cyan4", "red","forestgreen","purple","gold"))+labs(title  = "(i) Flower shape")+
  geom_text(nudge_x = c(0), nudge_y = c(0.6),color   = "black")



model_flo_2 <- emmeans(model2, "Flower_morphology")
flo_2 <- as.data.frame(model_flo_2[1:6])
flo_2 <- multcomp::cld(model_flo_2, alpha = 0.10, Letters = LETTERS)

shape_2 <- ggplot(flo_2,aes(x= Flower_morphology,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = flo_2, aes(x = Flower_morphology, y = emmean, color = Flower_morphology),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Flower_morphology),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("blue","cyan4", "red","forestgreen","purple","gold"))+labs(title  = "(j) Flower shape")+
   geom_text(nudge_x = c(0), nudge_y = c(0.4),color   = "black")


########################################################################################################################################################
#6) FLOWER SYMMETRY
########################################################################################################################################################
model_flo_sym_1 <- emmeans(model1, "Flower_symmetry")
flo_sym_1 <- as.data.frame(model_flo_sym_1[1:2])
flo_sym_1 <- multcomp::cld(model_flo_sym_1, alpha = 0.10, Letters = LETTERS)

symmetry_1 <-ggplot(flo_sym_1,aes(x= Flower_symmetry,y= emmean,
                 label = .group)) +theme_minimal()+
  geom_point(data = flo_sym_1, aes(x = Flower_symmetry, y = emmean, color = Flower_symmetry),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Flower_symmetry),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("sienna2","purple"))+labs(title =  "(k) Flower symmetry")+ geom_text(nudge_x = c(0), nudge_y = c(0.4),color   = "black")



model_flo_sym_2 <- emmeans(model2, "Flower_symmetry")
flo_sym_2 <- as.data.frame(model_flo_sym_2[1:2])
flo_sym_2 <- multcomp::cld(model_flo_sym_2, alpha = 0.10, Letters = LETTERS)

symmetry_2 <- ggplot(flo_sym_2,aes(x= Flower_symmetry,y= emmean,
                     label = .group)) +theme_minimal()+
  geom_point(data = flo_sym_2, aes(x = Flower_symmetry, y = emmean, color = Flower_symmetry),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Flower_symmetry),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("sienna2","purple"))+labs(title = "(l) Flower symmetry")+ geom_text(nudge_x = c(0), nudge_y = c(0.35),color   = "black")


########################################################################################################################################################
#7) NECTAR
########################################################################################################################################################
model_nec <- emmeans(model1, "Nectar_presence_absence")

model_nec_1 <- emmeans(model1, "Nectar_presence_absence")
nec_1 <- as.data.frame(model_nec_1[1:2])
nec_1 <- multcomp::cld(model_nec_1, alpha = 0.10, Letters = LETTERS)

nectar_1 <- ggplot(nec_1,aes(x= Nectar_presence_absence,y= emmean,
                     label = .group)) +theme_minimal()+
  geom_point(data = nec_1, aes(x = Nectar_presence_absence, y = emmean, color = Nectar_presence_absence),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Nectar_presence_absence),
                width =  0.25,size =  0.8)+ylab("Least square mean")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("black","grey"))+labs(title = "(m) Nectar")+ geom_text(nudge_x = c(0), nudge_y = c(0.35),color   = "black")



model_nec_2 <- emmeans(model2, "Nectar_presence_absence")
nec_2 <- as.data.frame(model_nec_2[1:2])
nec_2 <- multcomp::cld(model_nec_2, alpha = 0.10, Letters = LETTERS)


nectar_2 <-ggplot(nec_2,aes(x= Nectar_presence_absence,y= emmean,
                     label = .group)) +theme_minimal()+
  geom_point(data = nec_2, aes(x = Nectar_presence_absence, y = emmean, color = Nectar_presence_absence),size   = 4) +
  geom_errorbar(aes(ymin  =  lower.CL,ymax  =  upper.CL,  color = Nectar_presence_absence),
                width =  0.25,size =  0.8)+ylab("")+xlab("")+ theme(legend.position = "none")+ theme_ms()+
  scale_color_manual(values=c("black","grey"))+labs(title = "(n) Nectar")+ geom_text(nudge_x = c(0, 0), nudge_y = c(0.2, 0.2),color   = "black")


#PLOT!

breed_1 + breed_2+ comp_1+ comp_2+ lifespan_1+ lifespan_2+ lifeform_1+ lifeform_2+ shape_1+ shape_2+
symmetry_1+ symmetry_2+ nectar_1+ nectar_2 + plot_layout(ncol = 2)


```


\blandscape

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=14, fig.width=27,fig.pos = "!H",fig.cap="\\textbf{Fig. S8.} Interaction (yes/no) and visitation rate of the main bee families on the main axes of trait variation. Fitted posterior estimates of the presence-absence of interaction (plots a, b and c) and visitation rate (plots e, f and g) of Andrenidae, Apidae, Colletidae, Halictidae and Megachilidae across PC1, PC2 and PC3. For visualization purposes, the response variable of number of visits was log-transformed (Y-axis of lower panel)."}


library(Rcpp)
library(patchwork)
library(ggplot2)
library(tidyr)
#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2.2)),
           axis.text=element_text(size = rel(2), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.8, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank()
     ))
}


setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github

#This file is produced on otehr Rmd the brms fuucntions didn't work here... Weird segfault error that I wasn't able to solve

plot <- readRDS("Plot_bee_families.rds")

plot

```


\elandscape



\blandscape


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=18, fig.width=26, fig.cap="\\textbf{Fig. S9.} Association between the main axes of trait variation (showed on different columns) and the distinct plant species level network metrics (showed on different rows). The x-axis shows the most illustrative trait extremes of the trait continuum. Note that the plots are coloured by the different network metrics.", fig.pos= "h"}

#library(brms) #modelling
library(cowplot) #panel of plots
library(ggplot2) #plotting
library(patchwork)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(3.5)),
           axis.text=element_text(size = rel(2.75), color = "black"),
           legend.title=element_text(face="bold"),
           legend.text=element_text(),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(0.4, 'lines'),
           panel.border=element_rect(color="black",size=3),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank()
     ))
}
#########

setwd("~/Dropbox/PhD/R/Chapter_2") 

#read plot generated in other rmd, bms and stan are giving trouble here... This file is created in Species_Level_Metric_Pcs

plot_metrics_pcs <- readRDS("plot_metrics_pcs.rds") 

plot_metrics_pcs

```

\elandscape

