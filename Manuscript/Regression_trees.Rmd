---
title: "Untitled"
output: html_document
---
# Regression trees

\blandscape

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=4.25, fig.width=12,fig.cap= "**Figure 4** Contribution of traits in plant's network roles. Regression tree analysis of number of visits (log-transformed), normalized degree and specialization for the subset of species with quantitative data for pollen and nectar traits. The superior value inside the node indicates the mean value of the different species-level metric and the lower value, the percentage of species that are considered in each node. Thus, the top node has the mean value of the named trait for the 100% of species. Each node has a yes/no question and when the condition is fulfilled, the branch turns to the ‘yes’ direction and when not, to the ‘no’ direction. This rationale is followed in all the regression trees as indicated in the first branch division of the topmost node of each tree."}

########################################################################################################################################################
#SCRIPT TO CALCULATE THE REGRESSION TREE OF NECTAR AND PLOT IT
########################################################################################################################################################
#READ NETWORK VISITATION DATA (VISITS AGGREGATED PER PLANT SPECIES)

library(rpart.plot)
library(rpart)

setwd("~/R_Projects/Reproductive Traits")

v_df <- readRDS("Data/RData/log_visits_subset_nectar_pollen_tree.rds")
nd_df <-  readRDS("Data/RData/normalized_degree_subset_nectar_pollen_tree.rds")
d_df <- readRDS("Data/RData/specialization_subset_nectar_pollen_tree.rds")

#Set correct colnames for plotting
colnames(v_df) <- c("Visits", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")

colnames(nd_df) <- c("Normalized degree", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")

colnames(d_df) <- c("Specialization", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")



set.seed(2)
tree1 <- rpart(Visits~., data=v_df,  cp=0.009000,minbucket=50) 

set.seed(2)
tree2 <- rpart(`Normalized degree`~., data=nd_df, cp=0.005000,minbucket=50) 

set.seed(2)
tree3 <- rpart(Specialization~., data=d_df, cp=0.0050000,minbucket=50) 
par(mfrow=c(1,3))


rpart.plot(tree1, box.palette="GnOr", main="(a) Number of visits", cex.main=1.75,tweak = 1.25,type = 2) 
rpart.plot(tree2, box.palette="GnOr", main="(b) Normalized degree", cex.main=1.75,tweak = 1.25,type = 2)
rpart.plot(tree3, box.palette="GnOr", main="(c) Specialization", cex.main=1.75,tweak = 1.25,type = 2)


```

\elandscape

# Methods

Second, to better understand complex trait relationships, we used regression trees. Regression trees are recursive algorithms which can detect complex relationships among predictors and allow identification of the relevance of specific trait combinations on explaining species roles within the network of interaction. We focused exclusively on quantitative traits because almost all categorical traits were statistically associated with the first two axes of trait variation (Table S2). We conducted this analysis using the *rpart* function from the *rtrees* package [@therneau2015] with method *'anova'* with a minimum of 50 observations per terminal node and we used the *rpart.plot* package [@milborrow2015] to plot the regression trees. We considered the species level indices as response variables (number of visits, normalized degree and specialization) and we performed one regression tree per metric using the different quantitative traits as predictors. We calculated two regression trees per plant species-level metric, one for the full set of species and another for the subset of species for which we had pollen and nectar traits. Because pollen and nectar traits are essential to understand plant-pollinator interactions [@heinrich1972; @johnson2008; @vaudo2015], we focused in the main text on the regression trees that included floral rewards. Indeed, we found that nectar and pollen traits were among the best traits for explaining the different species-level metrics (Fig. S6).

# Results

When we further investigated the combination of traits that drive plant network roles, we found that the regression tree for number of visits was best explained by plant height, nectar concentration and style length (Fig. 4a; root node error = 1%). Specifically, species taller than 3.9m had the highest number of visits, while species that were shorter than 3.9m and had a nectar concentration lower than 16% had the lowest number of visits. Normalized degree was best explained by nectar concentration, pollen grains per flower, plant height, flower width and autonomous selfing (Fig. 4b; root node error = 2%). Species with a nectar concentration over 49% had the highest levels of normalized degree, whereas species with nectar concentration lower than 49%, more than 21,000 pollen grains per flower and height less than 0.78m had the lowest normalized degree. Finally, specialization was best explained by plant height, ovule number, pollen grains per flower and autonomous selfing (Fig. 4c; root node error = 7%). Overall, plant species with the highest specialization were shorter than 1.3m, had more than 14,000 pollen grains per flower and autonomously self-pollinated less than 11% of their fruits. In contrast, species taller or equal than 5.1m and with lower than 14 ovules per flower had the lowest specialization values.

# Supplemetary material


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=15, fig.width=12,fig.cap="\\textbf{Fig. S6.} Regression tree analyses. Comparison of the regression tree analyses between the full set of species and the subset of species with floral rewards for each plant species level metric. "}

########################################################################################################################################################
#SCRIPT TO CALCULATE THE REGRESSION TREE OF NECTAR AND PLOT IT
########################################################################################################################################################
#READ NETWORK VISITATION DATA (VISITS AGGREGATED PER PLANT SPECIES)

library(rpart.plot)
library(rpart)

setwd("~/R_Projects/Reproductive Traits")

v_df_all <- readRDS("Data/RData/log_visits_all_tree.rds")
nd_df_all <-  readRDS("Data/RData/normalized_degree_all_tree.rds")
d_df_all <- readRDS("Data/RData/specialization_all_tree.rds")

#run  regression trees of the 3 metrics
set.seed(1)
tree_1 <- rpart(Visits~., data=v_df_all, cp=0.0054559,minbucket=50)

set.seed(1)
tree_2 <- rpart(`Normalized degree`~., data=nd_df_all, cp=0.0084459,minbucket=50) 

set.seed(1)
tree_3 <- rpart(Specialization~., data=d_df_all, cp=0.0072192 , minbucket=50) #10


#NECTAR AND POLEN DATA
v_df <- readRDS("Data/RData/log_visits_subset_nectar_pollen_tree.rds")
nd_df <-  readRDS("Data/RData/normalized_degree_subset_nectar_pollen_tree.rds")
d_df <- readRDS("Data/RData/specialization_subset_nectar_pollen_tree.rds")

#Set correct colnames for plotting
colnames(v_df) <- c("Visits", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule number","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen grains per flower")

colnames(nd_df) <- c("Normalized degree", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule number","Plant height (m)",  "Microlitres of nectar",   "Nectar concentration (%)","Pollen grains per flower")

colnames(d_df) <- c("Specialization", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule number","Plant height (m)",  "Microlitres of nectar",   "Nectar concentration (%)","Pollen grains per flower")



set.seed(2)
tree1 <- rpart(Visits~., data=v_df,  cp=0.009000,minbucket=50) 

set.seed(2)
tree2 <- rpart(`Normalized degree`~., data=nd_df, cp=0.005000,minbucket=50) 

set.seed(2)
tree3 <- rpart(Specialization~., data=d_df, cp=0.0050000,minbucket=50) 


par(mfrow=c(3,2))

rpart.plot(tree_1, box.palette="GnOr", main="A Interaction frequency for all species", cex.main=1.85,tweak = 1.10) 
rpart.plot(tree1, box.palette="GnOr", main="B Interaction frequency for subset with floral rewards", cex.main=1.85,tweak = 1.10) 


rpart.plot(tree_2, box.palette="GnOr", main="C Normalized degree for all species", cex.main=1.85,tweak = 1.10)
rpart.plot(tree2, box.palette="GnOr", main="D Normalized degree for subset with floral rewards", cex.main=1.85,tweak = 1.10)

rpart.plot(tree_3, box.palette="GnOr", main="E Specialization for all species", cex.main=1.85,tweak = 1.10) 
rpart.plot(tree3, box.palette="GnOr", main="F Specialization for subset with floral rewards", cex.main=1.85,tweak = 1.10)

```

