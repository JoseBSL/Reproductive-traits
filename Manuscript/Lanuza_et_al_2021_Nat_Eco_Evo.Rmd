---
title: \singlespacing \vspace{-1.6cm} \LARGE Trade-offs among plant reproductive traits determine interactions with floral visitors

#author: 
#  - Jose B. Lanuza^1,2^*
#  - Romina Rader^1^
#  - Jamie Stavert^3^
#  - Liam K. Kendall^4^
#  - Manu E. Saunders^1^
#  - Ignasi Bartomeus^2^

# may use lua filters for affiliations etc: see https://stackoverflow.com/a/52919256

# date: '`r Sys.Date()`'

output:
  bookdown::pdf_document2:
    fig_caption: yes
    fig_width: 7
    fig_height: 7
    df_print: kable
    keep_tex: yes
    number_sections: no
    extra_dependencies: ["float"]
    toc: no
    fig_crop: no
    includes:
      in_header: header.tex
    
documentclass: article
# classoption: twocolumn, landscape, etc
papersize: a4
pagestyle: plain  # plain, empty, headings
geometry: margin=1in
linestretch: 2
fontfamily: mathpazo
fontsize: 12pt

bibliography: 
  - references.bib
  - knitcitations.bib
# zotero: "My shared Zotero group"
csl: ecology.csl
# csl: https://www.zotero.org/styles/ecology
notes-after-punctuation: false
link-citations: yes
linkcolor: RoyalBlue
urlcolor: RoyalBlue
links-as-notes: false
subparagraph: yes

header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}
- \usepackage{titlesec}
- \titlespacing{\title}{0pt}{\parskip}{-\parskip}
- \usepackage[style=nature]{biblatex}
- \usepackage[labelformat = empty]{caption}
- \usepackage{pdflscape}

---

\vspace{-1.7cm}
\singlespacing
\large 
\textbf{Jose B. Lanuza$^{1,2}*$, Romina Rader$^{1}$, Jamie Stavert$^{3}$, Liam K. Kendall$^{4}$, Manu E. Saunders$^{1}$ and Ignasi Bartomeus$^{2}$}

\vspace{0.3cm}


\normalsize

__Plant life-history strategies are constrained by cost-benefit trade-offs that determine plant form and function. However, despite recent advances in the understanding of trade-offs for vegetative and physiological traits, little is known about plant reproductive economics and how they constrain plant life-history strategies and shape interactions with floral visitors. Here, we investigate plant reproductive trade-offs and how these drive interactions with floral visitors using a dataset of 17 reproductive traits for 1,506 plant species from 28 plant-pollinator studies across 18 countries. We tested whether a plant’s reproductive strategy predicts its interactions with floral visitors and if the different reproductive traits predict the plant’s role within the pollination network. We found that over half of all plant reproductive trait variation was explained by two independent axes that encompassed plant form and function. Specifically, the first axis indicated the presence of a trade-off between flower number and flower size, while the second axis indicated a pollinator dependency trade-off. Plant reproductive trade-offs helped explain partly the presence or absence of interactions with floral visitors, but not differences in visitation rate. However, we did find important differences in the interaction level among floral visitor guilds on the different axes of trait variation. Finally, we found that plant size and floral rewards were the most important traits in the understanding of the plant species network role. Our results highlight the importance of plant reproductive trade-offs in determining plant life-history strategies and plant-pollinator interactions in a global context.__

\small
\vspace{-0.5cm}

\noindent\rule{\textwidth}{1pt}


^1^ School of Environmental and Rural Science, University of New England, Armidale, New South Wales 2350, Australia. ^2^ Estación Biológica de Doñana (EBD-CSIC), E-41092 Seville, Spain. ^3^ Department of Conservation | Te Papa Atawhai, Auckland, New Zealand. ^4^ Centre for Environmental and Climate Science, Lund University, Sölvegatan 37, S-223 62 Lund, Sweden. `*` e-mail: barragansljose@gmail.com


\doublespacing
\vspace{5mm}
\normalsize


```{r setup, include=FALSE, cache=FALSE, message = FALSE}

library("knitr")

### Chunk options: see http://yihui.name/knitr/options/ ###
## Text results
opts_chunk$set(echo = FALSE, warning = TRUE, message = TRUE)

## Code decoration
opts_chunk$set(tidy = TRUE, comment = NA, highlight = TRUE)

## Cache
# opts_chunk$set(cache = 2, cache.path = "output/cache/")

## Plots
opts_chunk$set(fig.path = "output/figures/")

```


```{r knitcitations, cache = FALSE}
library(knitcitations)
cleanbib()   
cite_options(citation_format = "pandoc")

```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```


Despite the astonishing diversity of floral structures among flowering plants [@barrett2002; @schiestl2013] and their importance in shaping plant-pollinator interactions [@fenster2004; @dellinger2020], a unified framework that explores plant reproductive trade-offs is currently lacking [@roddy2021]. In addition, macroecological studies that investigate plant reproductive traits are scarce [@baude2016; @munoz2016; @grossenbacher2017; @moeller2017] and consequently, there is poor understanding of how reproductive traits drive interactions with floral visitors at large scales [@sargent2008; @rech2016; @salguero2016; @ruger2018]. Linking the plant's position in trait-space with the different pollinator groups could help to improve our understanding of plant-pollinator associations [@dehling2016]. Further, there is increasing interest in understanding drivers of plant-pollinator interactions using trait-based approaches [@fenster2004; @rosas2014] and trait-matching analyses [@stang2009; @bartomeus2016]. However, despite the generalist nature of most plant-pollinator interactions [@waser1996; @olesen2002], reproductive traits have been overlooked beyond highly specialised pollination systems [@dellinger2020]. Overall, it is unclear how specific plant reproductive biology traits shape plant-pollinator interactions [@tur2013; @devaux2014].



Species can optimise their fitness through various life-history traits, yet trade-offs among those traits constrain the range of potential strategies that a species can use. With the recent availability of large trait databases (e.g., TRY @kattge2011 and COMPADRE @salguero2015), plant ecological strategies are being increasingly examined, and are facilitating the identification of global patterns and constraints in plant form and function [@salguero2016; @diaz2016; @bruelheide2018; @carmona2021]. However, most studies have focused on vegetative traits such as leaf [@wright2004], wood [@chave2009], or root [@laughlin2021] trade-offs with little or no attention given to reproductive traits [@evojtko2020; @roddy2021] which are critical to plant life strategies that shape interactions with pollinators and ultimately determine plant reproductive success. For instance, short lived versus perennial species tend to have low versus high levels of outcrossing, respectively, [@barrett2003; @moeller2017] and outcrossing levels are positively correlated with flower size [@goodwillie2010]. In addition, the presence of costly rewards (e.g., pollen or nectar) and showy flowers or floral displays can only be understood through consideration of plant species’ reliance upon animal pollination (pollinator dependence) and its role in attracting pollinators [@ollerton2011; @rodger2021]. However, it is still unknown to what extent these different reproductive compromises determine plant-pollinator interactions.

Several studies have identified links between plant traits and plant-pollinator network properties [@bartomeus2013; @olito2015; @rowe2020]. Moreover, plant traits can define species’ network roles (e.g., specialists vs generalists) [@lazaro2013; @tur2013]. For example, plant species that occupy reproductive trait space extremes are more likely to exhibit higher levels of specialisation and be more reliant on the trait-matching with pollinators [@junker2013; @coux2016]. Morphological matching between plant and floral visitors often determines plant-pollinator interactions, and can thus strongly influence interaction network structure [@stang2009; @ibanez2012]. Remarkably, the combination of traits have shown to increase the predictive power of the network interactions [@eklof2013]. Therefore, considering the different plant reproductive trade-offs which represent the species reproductive strategy within the network [@dehling2016] could progress our understanding of plant-pollinator interactions. Further, we know little if those patterns generally studied at the community level are representative of wider macroecological scales.

Here, we aim to explore the potential trade-offs among reproductive traits and how these influence plant-pollinator interactions. First, we identify the major axes of reproductive trait variation and trade-offs that determine plant form and function. Second, we investigate how plant species’ position in trait-space influence interactions with floral visitors. Finally, we investigate how both the main axes of trait variation, and individual traits, influence plant species’ roles within networks using a set of complementary interaction network metrics (i.e., interaction strength, normalized degree and specialization).

# RESULTS 

**Plant strategies.** The phylogenetically informed principal component analysis (pPCA) captured by the first two and three axes 51.8% and 70.97% of trait variation, respectively (Fig. 1 and Supplementary Fig. S5) and had a phylogenetic correlation ($\lambda$) of 0.76. The first principal component (PC1) represented 26.72% of the trait variation and indicated a trade-off between flower number and flower size. We refer to this axis as the ‘flower number - flower size trade-off’, as already described in previous studies [@sargent2007; @kettle2011]. Hence, one end of the spectrum comprised species with high investment in flower number and plant height but small flower size, short style length and low ovule number. The other end of this spectrum comprised species that were short in height and invested in large flowers, long styles, many ovules, but few flowers. The main contributing traits to PC1 were plant height, flower number, ovule number and flower size (loadings > |0.5|; Supplementary Table S3) but style length also contributed moderately to PC1 (loading = -0.33). The second principal component (PC2) represented 25.05% of the trait variation and indicated a trade-off between low and high pollinator dependence. We refer to this axis as the ‘pollinator dependence trade-off’. The main driver of trait variation on PC2 was autonomous selfing (loading = 0.85) but the other traits (except ovule number) also made moderate contributions (loadings from 0.27 to 0.4; Supplementary Table S3). We found that high pollinator dependence was associated with larger and a higher number of flowers, greater plant height and longer styles. In contrast, species with high levels of autonomous selfing tended to have fewer and smaller flowers, had shorter styles and were shorter in height. Further, PC3 explained a considerable amount of trait variability (19.17%) and the main contributors to this axis were style length (loading = -0.66) and the degree of autonomous selfing (loading = -0.51). The remaining traits, apart from ovule number, were moderately correlated to changes on PC3 (loadings from -0.23 to -0.46; Supplementary Table S3). Thus, because style length was correlated with all traits on PC3 and was the main driver of trait variation, we refer to this axis as the ‘style length trade-off’. Further, the pPCA with the subset of species that had nectar and pollen quantity data showed that nectar quantity (microlitres of nectar per flower) was positively associated with flower size, style length and ovule number (PC1, 23.40%); and pollen quantity (pollen grains per flower) was positively correlated with flower number and plant height and negatively associated with autonomous selfing (PC2, 21.67%; Supplementary Fig. S6). This pPCA explained similar variance with the first two principal components (45.07%) and similar associations of traits despite some variability in the loadings (Supplementary Table S4).


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10,fig.align='center',fig.width=10,fig.cap= "\\textbf{Fig. 1 | Plant life-history strategies.} Phylogenetically informed principal component analysis (pPCA) of 1,236 plant species from 28 plant-pollinator network studies. The solid arrows indicate the direction of the different quantitative traits (flower number, plant height, style length, flower size, ovule number and level of autonomous selfing) across the two main axes of trait variation. The length of the arrows indicate the weight of the variables on each principal component and the dashed lines show the opposed direction of trait variation. The icons at both ends of arrows and dashed lines illustrate the extreme form of the trait continuum."}

setwd("~/R_Projects/Reproductive Traits")

#Load libraries
library(viridis) #COLOUR GGPLOT
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
library(magick)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#Images were made by Paula Martin
#Check her work on https://paulamartinart.com/

tree <- image_read("Images/PPCA_Plot/Tree.png")
tree_1 <- as.raster(tree)

style_l <- image_read("Images/PPCA_Plot/Style_Long.png")
style_l_1 <- as.raster(style_l)

style_s <- image_read("Images/PPCA_Plot/Style_Short.png")
style_s_1 <- as.raster(style_s)

ovule_h <- image_read("Images/PPCA_Plot/Ovule_High.png")
ovule_h_1 <- as.raster(ovule_h)

ovule_l <- image_read("Images/PPCA_Plot/Ovule_Low.png")
ovule_l_1 <- as.raster(ovule_l)

selfing_n <- image_read("Images/PPCA_Plot/Selfing_None.png")
selfing_n_1 <- as.raster(selfing_n)

selfing_h <- image_read("Images/PPCA_Plot/selfing.png")
selfing_h_1 <- as.raster(selfing_h)

single_flower <- image_read("Images/PPCA_Plot/Single_Flower.png")
single_flower_1 <- as.raster(single_flower)

many_flowers <- image_read("Images/PPCA_Plot/Inflorescencia.png")
many_flowers_1 <- as.raster(many_flowers)
#many_flowers_1 <- image_rotate(many_flowers, 45)


large_flower <- image_read("Images/PPCA_Plot/flower_big.png")
large_flower_1 <- as.raster(large_flower)

flower_small <- image_read("Images/PPCA_Plot/flower_short.png")
flower_small_1 <- as.raster(flower_small)

herb <- image_read("Images/PPCA_Plot/herb.png")
herb_1 <- as.raster(herb)

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - flower size trade-off ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence trade-off ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() + annotation_raster(tree_1, xmin = -4.1, xmax = -2.85,ymin = 2.05, ymax = 4.05)+
     annotation_raster(style_l_1, xmin = 2.25, xmax = 3.05,ymin = 2.55, ymax = 3.7) +
    annotation_raster(style_s_1, xmin = -2.6, xmax = -1.9,ymin = -2.65, ymax = -1.7) +
    annotation_raster(ovule_h_1, xmin = 3.5, xmax = 4.2,ymin = -0.45, ymax = 0.50) +
    annotation_raster(ovule_l_1, xmin = -4.2, xmax = -3.5,ymin = -0.45, ymax = 0.5) +
    annotation_raster(selfing_n_1, xmin = -0.75, xmax = 1.2,ymin = 2, ymax = 4.7) +
    annotation_raster(selfing_h_1, xmin = -0.30, xmax = 0.15,ymin = -3.9, ymax = -3.1) +
    annotation_raster(single_flower_1, xmin = 3.3, xmax = 4.1,ymin = -1.7, ymax = -0.7) +
    annotation_raster(many_flowers_1, xmin = -4.20, xmax = -3.40,ymin = 0.8, ymax = 1.45) +
    annotation_raster(large_flower_1, xmin = 3.15, xmax = 4.15,ymin = 1.3, ymax = 2.55) +
    annotation_raster(flower_small_1, xmin = -3.50, xmax = -2.55,ymin = -2, ymax = -1.50) +
    annotation_raster(herb_1, xmin = 2.6, xmax = 3,ymin = -2.8, ymax = -2) 


    
      #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.7,5.05,5.6,7.85,7.3,6.15)), y = -(PCAloadings$PC2*c(4.693,2.5,3.1,6.6,5,5.5)+c(0,0,0,0,0.4,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4)
  
 
 plot <- plot + annotate("text", x = (PCAloadings$PC1*c(4.6,4.95,4.5,6.6,7.3,5.15)), y = (PCAloadings$PC2*c(3.83,6.4,5.7,7.4,-1,7.45)+c(0,0,0,0,-0.41,0)),
                         label =c("Low selfing", "Few flowers", "Small flowers", "Short styles", "Few ovules", "Short plants" ), color="black",fontface =2,size=4)
 
 
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

plot_grid(all_spp(PC))



```

We found that most categorical traits were statistically associated with the first two axes of trait variation (Fig. 2 and Supplementary Table S2). Flower symmetry, which was only associated with PC2 (Sum of squares = 8.51, F-value = 14.72, _P_ < 0.01 ), and nectar provision, which was independent of PC1 and PC2 (PC1: Sum of squares = 0.37, F-value = 0.29 , _P_ = 0.59; PC2:  Sum of squares = 0.83, F-value = 1.43, _P_ = 0.23) showed lack of statistical association. In addition, we found (with a Tukey test) statistical differences between the different levels of categorical traits in the trait space (Supplementary Fig. S7). Regarding self compatibility, we found larger differences on PC2 (i.e., species with unisexual flowers that were self incompatible were statistically differentiated from species with partial or full self compatibility; Supplementary Fig. S7a and Fig. S7b). Life forms differed statistically across both axes of trait variation and followed a gradient of larger life forms (trees and shrubs) with higher pollinator dependence to smaller ones (herbs) with lower pollinator dependence (Supplementary Fig. S7c and Fig. S7d). Consequently, lifespan also followed this gradient but perennial and short lived species only differed statistically on PC2 (Supplementary Fig. S7e and Fig. S7f). Species with unisexual flowers (monoecious and dioecious) were clustered on both extremes of the first two principal components and had the highest pollinator dependence and highest number of flowers (Supplementary Fig. S7g and Fig. S7h). Moreover, we found that the campanulate and capitulum flower shapes were differentiated from tube, papilionaceous, open and brush shapes in the trait space. The former morphologies had larger flowers and greater pollinator dependence, while the latter had higher flower number and greater autonomous selfing (Supplementary Fig. S7i and Fig. S7j). Regarding flower symmetry, zygomorphic flowers were associated with lower levels of pollinator dependence, whereas actinomorphic flowers had higher levels of pollinator dependence (Supplementary Fig. S7k and Fig. S7l).


\blandscape

\vspace*{-28mm}


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=12, fig.width=18,fig.cap= "**Fig. 2 | Location of the different qualitative traits on the trait space.** The panel is composed by the traits that showed statistical association with the first two axes of trait variation: compatibility system (a), life form (b), lifespan (c), breeding system (d), flower shape (e) and flower symmetry (f)."}

#Set working directory
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
#library(phytools)
#library(ape) #for phylogenetic distance
#library(dplyr) #data processing
#library(rtrees) #for phylogenetic distancelibrary(MASS)
#library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
#library(cowplot)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(0.55, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank(),
            plot.title = element_text(size = rel(1.65), face="bold")
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_for_rmd_plot_ppca_QUALITATIVE.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")

#CALL the output PC for simplicity
PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots
Compatibility <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$Compatibility <- dat_cleaning_5$Compatibility_system
  dat$Compatibility <- as.character(dat$Compatibility)
  dat$Compatibility[dat$Compatibility=="dioecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="monoecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="partially_self_compatible"] <- "Partially self compatible"
  dat$Compatibility[dat$Compatibility=="self_compatible"] <- "Self compatible"
  dat$Compatibility[dat$Compatibility=="self_incompatible"] <- "Self incompatible"
  dat$Compatibility <- factor(dat$Compatibility, levels = c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Compatibility),size=1.75)+scale_color_manual(values=c("cyan4", "deepskyblue2","orange","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.185, 0.13)) +ggtitle("(a)") 
  
  
  plot
  
}

#Compatibility(PC)

#############################################################################################################################################################
#Life form
#############################################################################################################################################################
#Load plots
Life_form <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Life form` <- dat_cleaning_5$life_form
  dat$`Life form` <- as.character(dat$`Life form`)
  dat$`Life form`[dat$`Life form`=="herb"] <- "Herb"
  dat$`Life form`[dat$`Life form`=="shrub"] <- "Shrub"
  dat$`Life form`[dat$`Life form`=="tree"] <- "Tree"
  dat$`Life form`[dat$`Life form`=="vine"] <- "Shrub"
  
  dat$`Life form` <- factor( dat$`Life form`, levels = c("Herb", "Shrub", "Tree"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Life form`),size=1.75)+scale_color_manual(values=c("forestgreen", "darkorange2","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("(b)") 
  
  plot
  
}

#Life_form(PC)


#############################################################################################################################################################
#Life span
#############################################################################################################################################################
#Load plots
Life_span <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
    dat$Lifespan <- dat_cleaning_5$lifespan
    dat$Lifespan <- as.character(dat$Lifespan)

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Lifespan),size=1.75)+scale_color_manual(values=c("sienna4","forestgreen"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.102, 0.1)) + ggtitle("(c)") 
  
  plot
  
}

#Life_span(PC)


#############################################################################################################################################################
#Flower symmetry
#############################################################################################################################################################
#Load plots
Flower_sym <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower symmetry` <- dat_cleaning_5$Flower_symmetry
  dat$`Flower symmetry` <- as.character(dat$`Flower symmetry`)
  dat$`Flower symmetry`[dat$`Flower symmetry`=="actinomorphic"] <- "Actinomorphic"
  dat$`Flower symmetry`[dat$`Flower symmetry`=="zygomorphic"] <- "Zygomorphic"
  

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower symmetry`),size=1.75)+scale_color_manual(values=c("sienna2","purple"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.165, 0.1)) + ggtitle("(f)") 
  
  plot
  
}

#Flower_sym(PC)


#############################################################################################################################################################
#Flower shape
#############################################################################################################################################################
#Load plots
Flower_sha <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower shape` <- dat_cleaning_5$Flower_morphology
  dat$`Flower shape` <- as.character(dat$`Flower shape`)
  dat$`Flower shape`[dat$`Flower shape`=="Funnelform"] <- "Campanulate"
  dat$`Flower shape`[dat$`Flower shape`=="Spike"] <- "Brush"

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower shape`),size=1.75)+scale_color_manual(values=c("blue","cyan4", "red","forestgreen","purple","gold"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.13, 0.18)) + ggtitle("(e)") 
  
  plot
  
}

#Flower_sha(PC)


#############################################################################################################################################################
#Breeding system
#############################################################################################################################################################
#Load plots
Breeding_syst <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Breeding system` <- dat_cleaning_5$Breeding_system
  dat$`Breeding system` <- as.character(dat$`Breeding system`)
  dat$`Breeding system` <- factor(dat$`Breeding system`, levels=c("Hermaphrodite","Monoecious" ,"Dioecious"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Breeding system`),size=1.75)+scale_color_manual(values=c("forestgreen","orange", "black"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.163, 0.115)) + ggtitle("(d)") 
  
  plot
  
}

#Breeding_syst(PC)

#############################################################################################################################################################
#Nectar
#############################################################################################################################################################
#Load plots
#Nectar <- function(PC, x="PC1", y="PC2") {
#  # PC being a prcomp object
#  data <- data.frame(PC$S)
#  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
#  dat <- data.frame(x = data[,x], y = data[,y])
#  
#  #######
#  #DENSITY FUNCTION
#  #######
#  get_density <- function(x, y, ...) {
#    dens <- MASS::kde2d(x, y, ...)
#    ix <- findInterval(x, dens$x)
#    iy <- findInterval(y, dens$y)
#    ii <- cbind(ix, iy)
#    return(dens$z[ii])
#  }
#  
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$Nectar <- dat_cleaning_5$Nectar_presence_absence
#  dat$Nectar[dat$Nectar=="yes"] <- "Presence"
#  dat$Nectar[dat$Nectar=="no"] <- "Absence"
#  plot <- plot + geom_point(data=dat, aes(-x, -y, #colour=Nectar),size=1.75)+scale_color_manual(values=c("black","grey"))
#  
#  ########
#  #ADD ARROWS 
#  ########
#  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
#  mult <- min(
#    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
#    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
#  )
#  datapc <- transform(datapc,
#                      v1 = .75 * mult * (get(x)),
#                      v2 = .75 * mult * (get(y))
#  )
#  # add arrows
#  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, #yend=-v2),size=1, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
#  
#  #Add axis with perctentage
#  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
#
#  
#  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
#  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.6, #arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
#  
#  #ADD LABELS
#  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
#  
#  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
#  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = #-(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
#                          label = PCAloadings$Variables, color="black",size=3)
#  
#  #CHANGE THEME
#  #CHANGE THEME
#  
#  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("G)") 
#  
#  plot
#  
#}
#
# #plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flower_sym(PC),Nectar(PC), ncol=2,nrow=4,  align = "hv")

#  plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flowe#r_sym(PC),ncol=3,nrow=2,  align = "hv")

library(patchwork)
Compatibility(PC) + Life_form(PC) + Life_span(PC) + Breeding_syst(PC) + Flower_sha(PC) + Flower_sym(PC) + plot_layout(ncol=3)


```

\elandscape

\vspace{5mm}

**Phylogenetic signal of traits.** We found a strong phylogenetic signal (*P* < 0.01) in all quantitative traits (Supplementary Table S5). The traits that showed the highest phylogenetic signal were ovule number ($\lambda$ = 1), pollen grains per flower ($\lambda$ = 1) and plant height ($\lambda$ = 0.96), followed by flower length ($\lambda$ = 0.75), flower width ($\lambda$ = 0.73), number of flowers per plant ($\lambda$ = 0.69) and nectar concentration ($\lambda$ = 0.65). The traits that showed a moderate phylogenetic signal were inflorescence width ($\lambda$ = 0.57), style length ($\lambda$ = 0.49) and autonomous selfing ($\lambda$ = 0.34). Finally, microliters of nectar per flower showed the lowest phylogenetic signal of all traits ($\lambda$ = 0.14). 

**Visitation patterns.** The main axes of trait variation explained partly presence-absence interactions between plant and floral visitors (conditional $R^{2}$ = 0.26; marginal $R^{2}$ = 0.20) but little of the overall visitation rates (conditional $R^{2}$ = 0.31; marginal $R^{2}$ = 0.06). However, we found relevant trends across the different floral visitor guilds on both presence-absence and visitation interactions (Fig. 3). On the pollinator dependence trade-off, all floral visitor guilds interacted more frequently with plant species with higher pollinator dependence (PC2; Fig. 3b and Fig. 3e). For presence-absence interactions we found that all Diptera, Coleoptera and non-bee-Hymenoptera guilds interacted more frequently with plants with high flower number and small flowers (flower number - flower size trade-off, PC1; Fig. 3a) but bees and Lepidoptera interacted slightly more frequently with plant species with low flower number but large flowers. For presence-absence interactions on PC3 (style length trade-off; Fig. 3c), we found that bees interacted clearly more with plant species with long styles and high selfing and the rest of the guilds interacted slightly more with plant species with short styles and low selfing. In addition, all guilds other than Syrphids and Lepidoptera (i.e., all Hymenoptera, non-syrphid-Diptera and Coleoptera) showed greater visitation rates on species with small numerous flowers (PC1; Fig. 3d). On the style length trade-off, bees, Lepidoptera and non-bee-Hymenoptera showed greater visitation rates on plant species with larger styles and higher levels of selfing; while syrphids, non-syrphid-Diptera and Coleoptera showed higher visitation rates on species with shorter styles and lower selfing (Fig. 3f). 

The additional model for both presence-absence of interactions (marginal $R^{2}$ = 0.29; conditional $R^{2}$ = 0.19) and visitation rate (marginal $R^{2}$ = 0.30; conditional $R^{2}$ = 0.03) for the most represented families of bees showed that the family Apidae was the main driver of the observed patterns. The contrasting differences between presence-absence and visitation rate for bees on PC1 (Fig. 3a and Fig. 3d) were driven by the family Andrenidae, which interacted more frequently on presence-absence interactions with plant species with low number of large flowers (Supplementary Fig. S8). 


\blandscape

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=14, fig.width=27,fig.cap= "**Fig. 3 | Interaction (yes/no) and visitation rates across the three main axes of trait variation per floral visitor guild.** Fitted posterior estimates of the presence/absence of interaction (a, b and c) and number of visits (d, e and f) made by the different floral visitors guilds in relation to PC1, PC2 and PC3. PC1 represents the flower number - flower size trade-off, PC2 represents the pollinator dependence trade-off and PC3, the style length trade-off. For visualization purposes, due to large differences between the visitation rates of bees and the rest of guilds, the number of visits was log-transformed (Y-axis of lower panel)."}

#LOAD LIBRARIES 
#library(phytools)
#library(ape) #for phylogenetic distance
#library(dplyr) #data processing
#library(rtrees) #for phylogenetic distancelibrary(MASS)
#library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
#library(tidyverse)
library(patchwork) #panel of plots
#library(brms)
#library(cmdstanr)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2)),
           axis.text=element_text(size = rel(1.8), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(2, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.75),face="bold"),
           plot.subtitle = element_text(face="bold",size=rel(2))
     ))
}


setwd("~/R_Projects/Reproductive Traits")


p1 <- readRDS("Main_Figures/figure_3_1.rds")
p2 <- readRDS("Main_Figures/figure_3_2.rds")
p3 <- readRDS("Main_Figures/figure_3_3.rds")
pp1 <- readRDS("Main_Figures/figure_3_4.rds")
pp2 <- readRDS("Main_Figures/figure_3_5.rds")
pp3 <- readRDS("Main_Figures/figure_3_6.rds")

library(patchwork)

combined <- pp1 + pp2 + pp3 + p1 + p2 + p3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect",ncol = 3)

```

\elandscape

**Plant species functional roles.** The variance of the different plant species-level network metrics was poorly explained by the three main axes of trait variation (Supplementary Fig. S9; interaction frequency ~ PCs, conditional $R^{2}$ = 0.11, marginal $R^{2}$ = 0.02; normalized degree ~ PCs, conditional $R^{2}$ = 0.24, marginal $R^{2}$ = 0.02; and, specialization ~ PCs, conditional $R^{2}$ = 0.37, marginal$R^{2}$ = 0.03). Overall, the most notable trends were found on PC1 and PC3 for interaction frequency and specialization. On the flower number - flower size trade-off (PC1), interaction frequency was higher for plant species with more flowers but was lower for plant species with larger flowers (Supplementary Fig. S9a). On PC1, specialization showed the opposite trend (Supplementary Fig. S9g). On the style length trade-off (PC3), interaction frequency was lower for plants with shorter styles and lower autonomous selfing and higher for species with longer styles and higher autonomous selfing (Supplementary Fig. S9c). Again, specialization showed the opposite trend to interaction frequency (Supplementary Fig. S9i).

When we further investigated the combination of traits that drive plant network roles, we found that the regression tree for visitation frequency was best explained by plant height, nectar concentration and style length (Fig. 4a). Specifically, species taller than 3.9m had the highest interaction frequency, while species that were shorter than 3.9m and had a nectar concentration lower than 16% had the lowest interaction frequency. Normalized degree was best explained by nectar concentration, pollen grains per flower, plant height, flower width and autonomous selfing (Fig. 4b). Species with a nectar concentration over 49% had the highest levels of normalized degree, whereas species with nectar concentration lower than 49%, more than 21,000 pollen grains per flower and height less than 0.78m had the lowest normalized degree. Finally, specialization was best explained by plant height, ovule number, pollen grains per flower and autonomous selfing (Fig. 4c). Overall, plant species with the highest specialization were shorter than 1.3m, had more than 14,000 pollen grains per flower and autonomously self-pollinated less than 11% of their fruits. In contrast, species taller or equal than 5.1m and with lower than 14 ovules per flower had the lowest specialization values.


\blandscape

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=4.25, fig.width=12,fig.cap= "**Fig. 4 | Contribution of traits in plant's network roles.** Regression tree analysis of interaction frequency (log-transformed), normalized degree and specialization for the subset of species with quantitative data for pollen and nectar traits. The superior value inside the node indicates the mean value of the different species-level metric and the lower value, the percentage of species that are considered in each node. Thus, the top node has the mean value of the named trait for the 100% of species. Each node has a yes/no question and when the condition is fulfilled, the branch turns to the ‘yes’ direction and when not, to the ‘no’ direction. This rationale is followed in all the regression trees as indicated in the first branch division of the topmost node of each tree."}

########################################################################################################################################################
#SCRIPT TO CALCULATE THE REGRESSION TREE OF NECTAR AND PLOT IT
########################################################################################################################################################
#READ NETWORK VISITATION DATA (VISITS AGGREGATED PER PLANT SPECIES)

library(rpart.plot)
library(rpart)

setwd("~/R_Projects/Reproductive Traits")

v_df <- readRDS("Data/RData/log_visits_subset_nectar_pollen_tree.rds")
nd_df <-  readRDS("Data/RData/normalized_degree_subset_nectar_pollen_tree.rds")
d_df <- readRDS("Data/RData/specialization_subset_nectar_pollen_tree.rds")

#Set correct colnames for plotting
colnames(v_df) <- c("Visits", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")

colnames(nd_df) <- c("Normalized degree", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")

colnames(d_df) <- c("Specialization", "Aut. selfing", "Flowers per plant", "Flower width", "Style length (mm)",
                      "Ovule n.","Plant height (m)",  "Microlitres of nectar",  "Nectar concentration (%)","Pollen g. per flower")



set.seed(2)
tree1 <- rpart(Visits~., data=v_df,  cp=0.009000,minbucket=50) 

set.seed(2)
tree2 <- rpart(`Normalized degree`~., data=nd_df, cp=0.005000,minbucket=50) 

set.seed(2)
tree3 <- rpart(Specialization~., data=d_df, cp=0.0050000,minbucket=50) 
par(mfrow=c(1,3))


rpart.plot(tree1, box.palette="GnOr", main="(a) Interaction frequency", cex.main=1.45,tweak = 1.25,type = 2) 
rpart.plot(tree2, box.palette="GnOr", main="(b) Normalized degree", cex.main=1.45,tweak = 1.25,type = 2)
rpart.plot(tree3, box.palette="GnOr", main="(c) Specialization", cex.main=1.45,tweak = 1.25,type = 2)


```

\elandscape


# DISCUSSION

This study demonstrates that plant species exhibit clear trade-offs among their vegetative and reproductive traits and that these trade-offs determine interactions with floral visitors. These trade-offs are differentiated along three axes of trait variation: (i) flower number - flower size, (ii) pollinator dependence and (iii) style length. These reproductive trade-offs helped partly explain the presence of floral visitor interactions, but not their visitation rates. However, floral visitor guilds formed distinct relationships with the main axes of trait variation. Moreover, we found that the plant species functional roles within pollination networks were best explained by plant size and floral reward related traits.

Over half of all plant trait variation was captured by the flower number - flower size and pollinator dependence trade-offs. Trait variation on these two axes was associated with the ‘fast-slow continuum’ in plant [@salguero2016] and animal [@healy2019] life-history strategies, as indicated by the different floral and reproductive biology traits associated with plant height, life form and lifespan. The ‘slow’ part of this continuum (i.e., tall trees and shrubs) included plant species with many flowers, few ovules, higher pollinator dependence, frequent occurrence of self-incompatibility and more complex breeding systems (e.g., monoecious and dioecious species). In contrast, plant species that employed the ‘fast’ strategy (i.e., short herbs), had fewer flowers, more ovules, frequent occurrence of self-compatibility and lower pollinator dependence. Further, on the first two axes of trait variation, we found additional support for the previously described positive association between higher outcrossing rate and larger floral display [@goodwillie2010]. The positive correlation between larger floral display and higher pollinator dependence in our dataset further confirmed this trend (see Supplementary Fig. S10).

Despite the low predictive power of the main trait variation axes for broad-level interaction patterns (presence-absence of interactions and visitation rate), we found changes in the interaction patterns among and within floral visitor guilds across these axes that suggest plant life-history strategies influence plant-pollinator interactions. For example, all floral visitor guilds visited plant species with higher pollinator dependence more frequently, and high pollinator dependence was associated with large floral displays and greater pollen quantities (Fig. 1 and Supplementary Fig. S6). This trend is consistent with previous studies that show plant species with higher reproductive investment tend to be visited by pollinators more frequently [@hegland2005; @lazaro2013; @kaiser2014]. In regard to the flower number - flower size and style length trade-offs, different pollinator guilds showed contrasting visitation rates across the continuum of trait variation, which could be associated with different pollination syndromes at a macroecological scale. For instance, bees and syrphid flies were clearly associated with opposing life-strategies on PC1 and PC3 (Fig. 3) suggesting possible niche partitioning [@palmer2003; @phillips2020] between these two guilds. However, despite floral rewards not being included in the main analysis because there was insufficient data available, floral reward related traits were among the best at characterising species functional roles (Fig. 4). More detailed exploration of reproductive trade-offs in conjunction with floral rewards is needed to help elucidate plant-pollinator associations. In any case, it is worth noting that other local factors such as species relative abundances, surely explain part of the observed variability [@vazquez2007; @encinas2012; @bartomeus2016] that reproductive trade-offs do not.

To conclude, we provide the first description of plant reproductive trade-offs using a large global dataset of plant traits. We identified the major reproductive strategies of flowering plants and how these strategies influence interactions with different floral visitor guilds. Although the explained variation that we found in the first two axes is lower than previous studies of vegetative traits [@diaz2016; @carmona2021] it is consistent with the largest and most recent study that has characterised plant life strategies with vegetative and reproductive traits [@salguero2016]. Future work needs to integrate the reproductive compromises that we have identified with vegetative and physiological trade-offs to create a more comprehensive spectrum of plant trait variation. Further, the varying level of phylogenetic signal among traits deserves further attention to understand evolutionary changes on mating and flower morphology in response to pollinators [@gervasi2017; @mackin2021]. Finally, including plant-pollinator networks from unrepresented areas of the world and a more complete description of plant reproductive trade-offs is essential for a better understanding of the global patterns in plant-pollinator interactions.

# MATERIALS AND METHODS

**Plant-pollinator network studies.** We selected 28 studies from 18 different countries that constituted a total of 64 plant-pollinator networks. These studies recorded plant-pollinator interactions in natural systems and were selected so that we had broad geographical representation. Although these studies differ in sampling effort and methodology, all studies provided information about plant-pollinator interactions (weighted and non-weighted), which we used to build a database of plant species that are likely to be animal pollinated. Many of these networks are freely available either as published studies [@olesen2007; @fortuna2010; @carvalheiro2014] or available in online archives (e.g., The Web of Life [@fortuna2010] and Mangal [@poisot2016]). In total, our network dataset (see Supplementary Table S1) constituted 60 weighted (interaction frequency) and 4 unweighted (presence/absence of the interaction) networks, each sampled at a unique location and year, as well as eight meta-webs where interactions were pooled across several locations and multiple years. 

**Taxonomy of plants and pollinators.** All species names, genera, families and orders were retrieved and standardized from the taxonomy data sources NCBI (https://www.ncbi.nlm.nih.gov/taxonomy) for plants and ITIS (https://www.itis.gov/) for pollinators, using the R package _taxize_ [@chamberlain2020] version _0.9.99_. We filled the ‘not found’ searches manually using http://www.theplantlist.org/ and http://www.mobot.org/ for plants and http://www.catalogueoflife.org/ for floral visitors.

**Functional traits.** We selected 20 different functional traits based on their relevance to plant reproduction and data availability (Table 1). These included twelve quantitative and eight categorical traits belonging to three broader trait groupings (13 floral, 4 reproductive biology and 3 vegetative, Supplementary Information). For each plant species, we undertook an extensive literature and online search across a wide range of resources (plant databases, online floras, books, journals and images). From a total of 30,120 cells (20 columns × 1,506 species) we were able to fill 24,341 cells (80.8% of the dataset, see Supplementary Fig. S1 for missing values information for each trait).

**Phylogenetic Distance.** We calculated the phylogenetic distance between different plant species using the function *get_tree* from the package _rtrees_ (https://github.com/daijiang/rtrees), which downloads phylogenetic distances from the extended R implementation of the Open Tree of Life [@smith2018; @jin2019].

\singlespacing


```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE, fig.height=1, fig.width=14}
setwd("~/R_Projects/Reproductive Traits")


library(kableExtra)

library(dplyr)
library(readxl) #read excel file (trait data)
library(dplyr) #data manipulation
library(visdat) #VISUALIZE MISSING DATA
library(naniar)
library(tidyverse)
########################################################################################################################################################
#1) READ TRAIT DATA
########################################################################################################################################################
#load data
trait_data <- read_excel("Data/Trait_data_raw/Trait_data_final.xlsx",na = "NA")
########################################################################################################################################################
#2) A) CLEAN DATA AND B) RENAME LEVELS FOR IMPUTATION 
########################################################################################################################################################
#####
#A) CLEAN DATA
#####
#select just filled rows
trait_data_1 <- trait_data[1:1712,] #It may be a more elegant way but this does the job, 1712 rows of data

#filter data, select species with flower level info and capitulum
trait_filtered <- filter(trait_data_1, Info_level == "flower" |  Info_level == "capitulum")
#remove NA's and duplicated species|Some spp are repeated once the spp names are standardize with taxize
trait_filtered$Species_all[trait_filtered$Species_all=="NA"]<-NA 
trait_filtered_1 <- trait_filtered[!is.na(trait_filtered$Species_all),]
trait_filtered_2 <- trait_filtered_1[!duplicated(trait_filtered_1$Species_all),]

#Select columns to work with
t <- trait_filtered_2[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system",
                        "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
                        "Flowers_per_plant","Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
                        "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration","Pollen_per_flower")]

########################################################################################################################################################
#####
#B) RENAME LEVELS FOR IMPUTATION
#####
#Breeding_system| For the purpose of this study we are not going to consider other complex breeding systems and just focus on 
#Hermaphroditism, dioecy and monoecy, the closest levels are grouped within each category
t$Breeding_system <- as.character(t$Breeding_system)
t$Breeding_system[t$Breeding_system=="androdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="androgynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="andromonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="gynoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="monoecious_dioecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="polygamo-dioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="protandrous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="protogynous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="subdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="submonoecious"] <- "monoecious"
#Change to capital letters| There are already levels with lower case
t$Breeding_system[t$Breeding_system=="monoecious"] <- "Monoecious"
t$Breeding_system[t$Breeding_system=="dioecious"] <- "Dioecious"
t$Breeding_system[t$Breeding_system=="hermaphrodite"] <- "Hermaphrodite"
t$Breeding_system <- as.factor(t$Breeding_system)

#Now 3 levels
#Flower_morphology
t$Flower_morphology <- as.character(t$Flower_morphology)
t$Flower_morphology[t$Flower_morphology=="bowl"] <- "open"
t$Flower_morphology[t$Flower_morphology=="dish"] <- "open"
t$Flower_morphology[t$Flower_morphology=="exposed"] <- "open"
t$Flower_morphology[t$Flower_morphology=="spadix"] <- "spike"
t$Flower_morphology[t$Flower_morphology=="open"] <- "Open"
t$Flower_morphology[t$Flower_morphology=="brush"] <- "Brush"
t$Flower_morphology[t$Flower_morphology=="campanulate"] <- "Campanulate"
t$Flower_morphology[t$Flower_morphology=="capitulum"] <- "Capitulum"
t$Flower_morphology[t$Flower_morphology=="funnelform"] <- "Funnelform"
t$Flower_morphology[t$Flower_morphology=="papilionaceous"] <- "Papilionaceous"
t$Flower_morphology[t$Flower_morphology=="spike"] <- "Spike"
t$Flower_morphology[t$Flower_morphology=="tube"] <- "Tube"
t$Flower_morphology <- as.factor(t$Flower_morphology)

#Life span
t$lifespan <- as.character(t$lifespan )
t$lifespan[t$lifespan=="annual"] <- "short_lived"
t$lifespan[t$lifespan=="biennial"] <- "short_lived"
t$lifespan[t$lifespan=="short_lived"] <- "Short lived"
t$lifespan[t$lifespan=="perennial"] <- "Perennial"
t$lifespan <- as.factor(t$lifespan )

########################################################################################################################################################
#3) EXPLORE PATTERNS OF MISSING DATA
########################################################################################################################################################

#We convert cualitative data to quantitative to reduce missing data on this column and hence conduct the imputation 
#use ifelse base r does not work with these NA'S Even with work around. base r does not like the na option of read excel
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("high") & is.na(t$Autonomous_selfing_level_fruit_set), 88, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("medium") & is.na(t$Autonomous_selfing_level_fruit_set), 50.5, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("low") & is.na(t$Autonomous_selfing_level_fruit_set), 13, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("none") & is.na(t$Autonomous_selfing_level_fruit_set), 0, t$Autonomous_selfing_level_fruit_set)

#t$Nectar_ul adding it here just to see how many cells 
#Now we just select presence/absence of nectar
#select columns of interest
t <- t[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system","Autonomous_selfing_level",
         "Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", "Flowers_per_plant", "Floral_unit_width",
         "Corolla_diameter_mean", "Corolla_length_mean", "Style_length", "Ovule_number", "life_form", "lifespan",
         "Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration","Pollen_per_flower")]


########################################################################################################################################################
#4) CALCULATE PHYLOGENETIC DISTANCE TO CORRECT WITH EIGENVALUES IN THE IMPUTATION
########################################################################################################################################################
#Convert to factor 
cols <- c("Order_all", "Family_all", "Genus_all", "Species_all", "Compatibility_system", "Autonomous_selfing_level", "Flower_morphology",
          "Flower_symmetry", "life_form", "lifespan","Nectar_presence_absence")
t[cols] <- lapply(t[cols], factor)  ## as.factor() could also be used


cols.num <- c("Family_all","Genus_all","Species_all")
t[cols.num] <- sapply(t[cols.num],as.character)
t$Species_all <- gsub("Species_all_", "", t$Species_all)

t <- t[!t$Species_all == "Pinus luchuensis", ]   # remove gymnosperm species

#remove species that are not until species level
#ALL THE SPECIES WITH SP. ARE DELETD
t$Species_geonet <- gsub("M_PL_.*","",t$Species_geonet) #subsitute partial string for nothing
t$Species_geonet <- gsub(" $","", t$Species_geonet, perl=T) #remove trailing spaces
t$Species_geonet <-  sub('sp.1$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp.2$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp$', 'sp.', t$Species_geonet) #PREPARE ALL SP TO SP.
t$Species_geonet <- sub("sp.$", "DELETE", t$Species_geonet) #change all sp. for DELETE
t <- t[- grep("DELETE",  t$Species_geonet),] #remove species with "DELETE"
#CHECK LEVELS

#Make these NA's as NA
t$Species_all[t$Species_all=="NA"] <- NA
t$Family_all[t$Family_all=="NA"] <- NA
t$Genus_all[t$Genus_all=="NA"] <- NA
#remove NA's
t <- t[!is.na(t$Family_all),]
t <- t[!is.na(t$Species_all),]
t <- t[!is.na(t$Genus_all),]



missing.values <- t %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

n_of_records <- subset(missing.values, isna=="FALSE")
Trait <- c("Plant height (m)", "Flower width (mm)", "Flower length (mm)", "Inflorescence width (mm)", "Style length (mm)", "Ovules per flower",
           "Flowers per plant", "Nectar ($\\mu$l)", "Nectar (mg)", "Nectar concentration ($\\%$)", "Pollen grains per flower", "Autonomous selfing (fruit set)")

Trait1 <- c("Lifepan", "Life form", "Flower shape", "Flower symmetry", "Nectar", "Autonomous selfing", "Compatibility system", "Breeding system", " ", " ", " ", " ")

T.cat <- linebreak(c("Short-lived \n Perennial", "Herb \n Shrub \n Tree", "Brush \n Campanulate \n Capitulum \n Open \n Papilionaceous \n Tube",  "Actinomorphic \n Zygomorphic",
           "Presence \n Absence", "None \n Low \n Medium \n High", "Self-incomp. \n Part. self-comp. \n Self-comp.", "Hermaphrodite \n Monoecious \n Dioecious"," ", " ", " ", " "),align = c("l"))

Type <- linebreak(c("Vegetative", "Floral", "Floral", "Floral", "Floral", "Floral", "Floral","Floral","Floral","Floral","Floral","Reproductive \n biology"),align = c("c"))

Type_1 <- linebreak(c("Vegetative", "Vegetative", "Floral", "Floral", "Floral", "Reproductive \n biology", "Reproductive \n biology", "Reproductive \n biology","","","",""),align = c("c"))


dat <- data.frame(Type, Trait,Type_1, Trait1, T.cat)

Number_of_records_quantitative <- c(n_of_records$num.isna[n_of_records$key=="Plant_height_mean_m"], n_of_records$num.isna[n_of_records$key=="Corolla_diameter_mean"],
  n_of_records$num.isna[n_of_records$key=="Corolla_length_mean"], n_of_records$num.isna[n_of_records$key=="Floral_unit_width"],
  n_of_records$num.isna[n_of_records$key=="Style_length"], n_of_records$num.isna[n_of_records$key=="Ovule_number"],
  n_of_records$num.isna[n_of_records$key=="Flowers_per_plant"], n_of_records$num.isna[n_of_records$key=="Nectar_ul"],
  n_of_records$num.isna[n_of_records$key=="Nectar_mg"], n_of_records$num.isna[n_of_records$key=="Nectar_concentration"], n_of_records$num.isna[n_of_records$key=="Pollen_per_flower"],
  n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level_fruit_set"]) 


Number_of_records_categorical <- c(n_of_records$num.isna[n_of_records$key=="lifespan"], n_of_records$num.isna[n_of_records$key=="life_form"],
                                   n_of_records$num.isna[n_of_records$key=="Flower_morphology"], n_of_records$num.isna[n_of_records$key=="Flower_symmetry"],
                                   n_of_records$num.isna[n_of_records$key=="Nectar_presence_absence"], n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level"],
                                   n_of_records$num.isna[n_of_records$key=="Compatibility_system"], n_of_records$num.isna[n_of_records$key=="Breeding_system"],
                                   rep("",4))

dat <- data.frame(Type, Trait,Type_1, Trait1, T.cat)


colnames(dat) <- c("Type","Traits", "Type", "Traits", "Categories")


kbl(dat, booktabs = T, linesep = "\\addlinespace", escape = FALSE, align = c("c","l","c","c","l","l","c"),caption = "\\textbf{Table 1 | Quantitative and categorical traits used in this study.}") %>%
kable_styling(full_width = F,font_size = 10) %>%
add_header_above(c("Quantitative traits" = 2,"Categorical traits" = 3),bold=T)  %>%
    column_spec(c(1,3), bold = T) %>% row_spec(0, bold=T) 



```


\doublespacing

**Data Imputation.** Trait missing values were imputed with the function _missForest_ [@stekhoven2012] which allows imputation of data sets with continuous and categorical variables. We accounted for the phylogenetic distance among species on the imputation process by including the eigenvectors of a principal component analysis of the phylogenetic distance (PCoA) which has been shown to improve the performance of _missForest_ [@penone2014]. To extract the eigenvectors, we used the function _PVRdecomp_ from the package _PVR_ [@santos2018] based on a previous conceptual framework that considers phylogenetic eigenvectors [@diniz-filho2012]. Although the variable of autonomous selfing had a high percentage of missing values (68%), we were able to solve this by back transforming the qualitative column of autonomous selfing to numerical. The categories of ‘none’, ‘low’, ‘medium’ and ‘high’ were converted to representative percentages of each category 0%, 13%, 50.5% and 88% respectively. This reduced the percentage of missing values for this column from 68% to 35% and allowed the imputation of this variable. However, we were unable to include nectar and pollen traits on the imputation process because of the high percentage of missing values (Supplementary Fig. S1). Hence, the imputed dataset had 1,506 species, seven categorical and eight numerical variables and 5.79% of missing values. Further, we conducted an additional imputation process on the subset of species with data for pollen per flower and microliters of nectar. This subset comprised 755 species, 8.01% missing values and all traits but milligrams of nectar (~50% of missing values) were included in the imputation process.

**Plant strategies.** We explored the trade-offs between different quantitative plant functional traits with a phylogenetically informed Principal Component Analysis (pPCA). We did not include the quantitative variables of flower length and inflorescence width because they were highly and moderately correlated to flower width respectively (Pearson’s correlation = 0.72, _P_ < 0.01 and Pearson’s correlation = 0.36, _P_ < 0.01), and thus we avoided overemphasizing flower size on the spectrum of trait variation. Although qualitative traits were not included in the dimensionality reduction analysis, we also investigated the association of the different qualitative traits with the main axes of trait variation. Prior to the analyses, we excluded outliers and standardized the data. Due to the high sensitivity of dimensionality reduction to outliers, we excluded values within the 2.5th–97.5th percentile range [@legendre2012], and thus our final dataset had 1,236 species. Then, we log transformed the variables to reduce the influence of outliers and z-transformed (X= 0, SD=1) so that all variables were within the same numerical range. We performed the pPCA using the function _phyl.pca_ from the package _phytools_ [@revell2012] (version _0.7-70_) with the method lambda ($\lambda$) that calculates the phylogenetic correlation between 0 (phylogenetic independence) and 1 (shared evolutionary history) and we implemented the mode covariance because values for each variables were on the same scale following transformation [@abdi2010]. Moreover, to corroborate that our imputation of missing values did not affect our results, we conducted a pPCA on the full dataset without missing values (see Supplementary Fig. S2). We found little difference between the explained variance with the imputed dataset (51.08%) and the dataset without missing values (52.87%). In addition, the loadings on each principal component had a similar contribution and correlation patterns, with the exception of plant height which showed slight variations between the imputed and non-imputed dataset. Finally, we conducted an additional phylogenetic informed principal component analysis for the subset of species with pollen and nectar quantity. For this, we included all quantitative traits considered in the main pPCA plus pollen grains and microlitres of nectar per flower. 

**Phylogenetic signal of traits.** We calculated the phylogenetic signal of the different quantitative traits on the imputed dataset with the full set of species (N = 1,506) with the package _phytools_ [@revell2012] version _0.7-70_ and we used Pagel’s $\lambda$ as a measurement of the phylogenetic signal. However, for pollen and nectar traits, phylogenetic signal was calculated only on the subset of species that had quantitative information for these traits (N = 755).

**Network analyses.** Analyses were conducted on the subset of 60 weighted networks sampled in a unique flowering season and site, which included 556 plant and 1,126 pollinator species. These networks were analysed in their qualitative (presence-absence) and quantitative (interaction frequency) form. First, we analysed the binary version of these weighted networks with presence-absence information that assumes equal weight across interactions. Second, we analysed the untransformed weighted networks with interaction frequency that accounts for the intensity of the interaction. Although floral visitors are not always pollinators and interaction frequency does not consider each pollinator species efficiency [@ballantyne2015], interaction frequency can provide valuable information of the contribution of floral visitors to pollination [@vazquez2005; @vazquez2012]. In total, our network dataset (excluding meta-webs and non-weighted networks) included 2,256 interactions of bees with plants, 1,768 non-syrphid-Diptera interactions, 845 syrphids interactions, 437 Lepidoptera interactions, 432 Coleoptera interactions and 362 non-bee-Hymenoptera interactions. Sampling methods varied across networks but this was accounted for in analyses by considering them in the random effects of the modelling process. All analyses were conducted in R version _4.0.3_. 

**Visitation patterns.** We used Bayesian modelling (see below for details) to explore the effect of floral visitor groups and the main axes of trait variation (pPCA with imputed dataset) on both qualitative (presence/absence) and quantitative (visitation rate) floral interactions per plant species. For this, we divided floral visitors into six main guilds that differ in life form, behaviour and are likely to play a similar ecological role: (i) bees (Hymenoptera-Anthophila), (ii) non-bee-Hymenoptera (Hymenoptera-non-Anthophila), (iii) syrphids (Diptera-Syrphidae), (iv) non-syrphid-Diptera (Diptera-non-Syrphidae), (v) Lepidoptera and (vi) Coleoptera. Moreover, because the guild of bees was the most represented group with 2,256 records and had the highest frequency of visits of all groups, we also explored the presence-absence of interaction and visitation rate of the main bee families (Andrenidae, Apidae, Colletidae, Halictidae and Megachilidae) on the trait space. In addition, we found that _Apis mellifera_ was the floral visitor with the largest proportion of records counted (7.55% of the total). This finding is consistent with previous research showing that _A. mellifera_ was the most frequent floral visitor in a similar dataset of 80 plant-pollinator networks in natural ecosystems [@hung2018]. Hence, to control for the effect of _A. mellifera_ on the observed visitation patterns of bees, we conducted an analogous analysis with presence-absence of interaction and visitation rate excluding _A. mellifera_. We found that _A. mellifera_, was partly driving some of the observed trends on PC1 (Supplementary Fig. S3). However, we did not detect major differences on PC2 and PC3.

We implemented Bayesian generalized linear mixed models using the R package _brms_ [@burkner2017] (version _2.14.6_). We modelled the frequency of visits as a function of the main axes of plant trait variation and their interactions with floral visitor functional groups (Visits ~ PC1 x FGs + PC2 x FGs + PC3 x FGs). Because we were interested in possible differences in the visitation patterns among floral visitors groups to plants with different strategies, we included interactions between the main axes of trait variation (PC1, PC2 and PC3) and the floral visitor guilds. In this model, we added a nested random effect of networks nested within the study system to capture the variation in networks among studies and within networks. Moreover, we included the phylogenetic covariance matrix as a random factor due to the possible shared evolutionary histories of species and therefore lack of independence across them. We specified this model with a zero inflated negative binomial distribution and weakly informative priors from the brms function. We run this model for 3,000 iterations and with previous 1,000 warm up iterations. We set delta ($\Delta$) to 0.99 to avoid divergent transitions and visualized the posterior predictive checks with the function *pp_check* using the _bayesplot_ package [@gabry2019] (version _1.7.2_).

**Plant species functional roles.** We investigated whether different quantitative traits determined plant species functional roles using Bayesian modelling and regression trees. For this, we selected simple and complementary species-level network metrics commonly applied in bipartite network studies [@dormann2008] with a straightforward ecological interpretation relevant to our research goals. The different plant species-level metrics were: (i) sum of visits per plant species; (ii) normalized degree, calculated as the number of links per plant species divided by the total possible number of partners; and (iii) specialization (d’) [@bluthgen2006], which measures the deviation of an expected random choice of the available interaction partners and ranges between 0 (maximum generalization) and 1 (maximum specialization). Normalized degree and specialization were calculated with the _specieslevel_ function from the R package _bipartite_ [@dormann2008] (version _2.15_). 

First, we modelled the distinct plant species metrics (sum of visits, normalized degree and plant specialization) as a function of the three main axes of trait variation (plant species level metric ~ PC1 + PC2 + PC3). For each response variable (i.e., each plant species level metric), we used different distribution families (zero inflated negative binomial for the sum of visits, weibull for normalized degree and zero one inflated beta for specialization). Finally, we used the same random factors, model settings and conducted the same posterior predictive checks for each model as detailed above in the ‘visitation patterns section’. 

Second, to better understand these complex trait relationships, we used regression trees. Regression trees are recursive algorithms which can detect complex relationships among predictors and allow identification of the relevance of specific trait combinations on species functional roles. We focused exclusively on quantitative traits because almost all categorical traits were statistically associated with the first two axes of trait variation (Supplementary Table S2). We conducted this analysis using the _rpart_ package [@therneau2015] version _4.1-15_ with method _‘anova’_ with a minimum of 50 observations per terminal node and we used the _rpart.plot_ package [@milborrow2015] version _3.0.9_ to plot the regression trees. We considered the species level indices as response variables (interaction frequency, normalized degree and specialization) and we performed one regression tree per metric using the different quantitative traits as predictors. We calculated two regression trees per plant species-level metric, one for the full set of species and another for the subset of species for which we had pollen and nectar traits. We focused on regression trees that included floral rewards because they consistently showed pollen and nectar traits as being the best for explaining the different species-level metrics (see Supplementary Fig. S4). 

# References

<div id ="refs"></div>

# Acknowledgements

This is study was supported by the project SAFEGUARD (101003476 H2020-SFS-2019-2). We thank all researchers that made their data available for our analysis. We thank Bryony Wilcox, Greg Bible, Mercedes Sanchez-Lanuza and David Ragel for their help with data collection. We also thank Jason Tylianakis for his comments on the manuscript before submission. JBL thanks the University of New England for the funding provided to carry out this work.


