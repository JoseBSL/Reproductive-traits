---
title: "Untitled"
output:
  pdf_document: default
  html_document: default
---
```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10,fig.width=40,fig.align = 'center'}
#WORLDPLOT WITH BREEDING SYSTEMS

#Load Libraries
library(readxl)
library(ggplot2)
library(dbplyr)
library(scatterpie)
library(reshape2)
library(effsize)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(egg)
library(magrittr)
library(multipanelfigure)
library(grid)
# READ LONG FORMAT DATA
setwd("~/R_Projects/Reproductive Traits")
Long_format_metawebs <- readRDS("Data/RData/Long_format_metawebs.RData")

#SUBSET UNIQUE CASES PER NETWORK
Long_format_subset <-  unique(Long_format_metawebs[,c("Plant_species","Id")])
#It seems to work fine
#and the total number of species makes sense, a bit more than the total unique cases for all the networks


#READ TRAIT DATA IN ORDER TO MERGE
data <- read.csv("Data/Data_processing/all.csv", stringsAsFactors = F)
data <- data[,c(1,4,6,7,8,15,27)]
levels(as.factor(data$Breeding_system))
#Filter data for columns of interest
data_filtered <- subset(data, Info_level=="flower"|Info_level=="capitulum"|Info_level=="inflorescence"|Info_level=="NA")
#Rename column to merge
colnames(data_filtered)[1] <- "Plant_species"
#Convert to factor 
data_filtered <- as.data.frame(data_filtered, stringsAsFactors = TRUE)

#Merge the two dataframes (trait data and the unique cases per network)
all_species_per_network <- merge(Long_format_subset, data_filtered,  by=c("Plant_species","Id"), all = T )

#Group breeding system per metaweb or web
all_summary_breeding_system <- dcast(all_species_per_network,Id~Breeding_system,value.var = "Breeding_system")

#Cleaning NA and one unfinished network
all_summary_breeding_system <- all_summary_breeding_system[-c(6,30),]

#Removing ".csv" from the Id to megere with coordinates
all_summary_breeding_system$Id <- gsub("\\..*","",all_summary_breeding_system$Id)

#Now merge with metadata to add coordinates to plot it
metadata <- read.csv("Data/Data_processing/metadata.csv", stringsAsFactors = F)
str(metadata)
metadata_sub <- metadata[,c(1:6,11)]
metadata_sub <- metadata_sub[ , -c(1)]
metadata_sub <- metadata_sub[order(metadata_sub$Id_number),] 
#Fix some coordinates manually, this locations have more than one
#fore representation purposes I will use just one
metadata_sub[6,3] <- "1.575532"
metadata_sub[6,4] <- "52.762395"
metadata_sub[7,3] <- "9.1"
metadata_sub[7,4] <- "56.1"
metadata_sub[29,3] <- "-6.16895"
metadata_sub[29,4] <- "37.234966"
metadata_sub <- metadata_sub[-14,]
colnames(metadata_sub)[1] <- "Id"

#Merge coordinates and data 
data_merged <- merge(metadata_sub, all_summary_breeding_system)

data_merged[,c(3,4,6:19)] <- sapply(data_merged[,c(3,4,6:19)],as.numeric)
sapply(data_merged, class)
data_merged$Id <- as.factor(data_merged$Id)
str(data_merged)
#Prepare data for plotting
data_merged$Hermaphroditism <- data_merged$hermaphrodite
data_merged$Dioecy <- data_merged$androdioecious + data_merged$androgynodioecious + data_merged$dioecious+
  data_merged$gynodioecious + data_merged$monoecious_dioecious + data_merged$`polygamo-dioecious`+
  data_merged$subdioecious

data_merged$Monoecy <- data_merged$andromonoecious + data_merged$gynomonoecious + data_merged$monoecious
+ data_merged$submonoecious

data_merged_sub <- data_merged[, c(1:6, 20:22)]
#Plot data
world <- map_data('world')

data_merged_sub_ord <- data_merged_sub[order(data_merged_sub$Id_number),]
#Move coordinates manually to see all points (Improving plot visualization)
#Manual jitter
data_merged_sub_ord$Id_number <- seq(1, length(data_merged_sub_ord$Id_number))
#Fixing New Zealand pies
data_merged_sub_ord[19,4] <- -28
data_merged_sub_ord[19,3] <- 168
data_merged_sub_ord[20,4] <- -52
data_merged_sub_ord[20,3] <- 180
data_merged_sub_ord[21,4] <- -48
data_merged_sub_ord[21,3] <- 158

#Fixing Galapagos pies
data_merged_sub_ord[18,4] <- -7
data_merged_sub_ord[18,3] <- -105

data_merged_sub_ord[27,4] <- 6
data_merged_sub_ord[27,3] <- -105

#Fixing Mauritius pies
data_merged_sub_ord[13,4] <- -12
data_merged_sub_ord[13,3] <- 72
data_merged_sub_ord[17,4] <- -28
data_merged_sub_ord[17,3] <- 72

#Fixing Denmark pies
data_merged_sub_ord[3,4] <- 72
data_merged_sub_ord[4,4] <- 60
data_merged_sub_ord[7,4] <- 50

#Fixing Venezuela pies

data_merged_sub_ord[22,3] <- -45
data_merged_sub_ord[22,4] <- 10
data_merged_sub_ord[23,3] <- -45
data_merged_sub_ord[23,4] <- 25

#Fixing Japan pies

data_merged_sub_ord[11,3] <- 154
data_merged_sub_ord[14,3] <- 145
data_merged_sub_ord[14,4] <- 20

#Fixing Spain pies

data_merged_sub_ord[28,3] <- -20
data_merged_sub_ord[28,4] <- 28

data_merged_sub_ord[1,3] <- -20
data_merged_sub_ord[1,4] <- 52
data_merged_sub_ord[2,3] <- -30
data_merged_sub_ord[2,4] <- 40

#Fixing Argentina pies

data_merged_sub_ord[5,3] <- -90

#Fixing Brazil pies

data_merged_sub_ord[26,3] <- -30

#Fixing Sweden pies

data_merged_sub_ord[8,3] <- 40
data_merged_sub_ord[8,4] <- 78

#Fixing Denmark pies

data_merged_sub_ord[3,3] <- 0
data_merged_sub_ord[3,4] <- 80
data_merged_sub_ord[4,3] <- 15
data_merged_sub_ord[4,4] <- 80
data_merged_sub_ord[7,3] <- 45
data_merged_sub_ord[7,4] <- 60


#Fixing UK pies

data_merged_sub_ord[6,3] <- -8
data_merged_sub_ord[6,4] <- 67

#Fixing Australia

data_merged_sub_ord[12,3] <- 120

#Fixing China pie

data_merged_sub_ord[10,3] <- 90
data_merged_sub_ord[10,4] <- 0

#Fixing USA pie

data_merged_sub_ord[24,3] <- -60

#Fixing Canada pie
data_merged_sub_ord[25,3] <- -42
data_merged_sub_ord[25,4] <- 52
data_merged_sub_ord[15,3] <- -71
data_merged_sub_ord[15,4] <- 92

#Fixing Greenland pie

data_merged_sub_ord[16,4] <- 92
data_merged_sub_ord[9,4] <- 92

#network size fix

p1 <- ggplot(world, aes(long, lat)) +
  geom_map(map=world, aes(map_id=region), fill="white", color="grey", size=0.35) +
  coord_quickmap()+ylab("Latitude")+ xlab("Longitude")+coord_equal() + coord_sf( ylim = c(-60, 100), expand = FALSE) +  geom_scatterpie(aes(x=longitude, y=latitude,group=Id), 
 data = data_merged_sub_ord, cols = colnames(data_merged_sub_ord[,c(7:9)]),alpha=.8)+ 
  scale_fill_manual(breaks = colnames(data_merged_sub_ord[,c(7:9)]),
 labels = c("Hermaphroditism", "Dioecy", "Monoecy"),values = c("Hermaphroditism" = "#4DAF4A",
 "Monoecy" = "#984EA3","Dioecy" = "orange")) +labs(title = "Breeding system",subtitle = "",
  caption = "",fill = NULL) + theme(legend.position = c(0.15, 0.010),legend.justification = c(1, 0),legend.text=element_text(size=5),legend.key.size = unit(0.16, "cm")) +
  geom_segment(data = data_merged_sub_ord,aes(x = 168, y = -34, xend = 172, yend = -43),color = "black", size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 179, y = -46, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 164, y = -48, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = 6, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) +  #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = -7, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) + #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -12), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -28), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y = 10, xend = -61, yend = 5.5), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y =25 , xend = -67, yend = 8.9), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = 148, y = 35, xend = 135.8, yend = 35), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 140, y = 22, xend = 129, yend = 28), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -15.5, y = 32, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -15, y = 50, xend = 3, yend = 43), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -24, y = 40, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -84, y = -32, xend = -68, yend = -32), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -36, y = -21, xend = -58, yend = -21), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 34, y = 78, xend = 18.5, yend = 68), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 0, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 15, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -8, y = 61, xend = 1.5, yend = 52), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 39, y = 60, xend = 9, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 126, y = -36, xend = 148, yend = -36), color = "black", size = 0.3, alpha = 0.8) + #AUS
  geom_segment(data = data_merged_sub_ord, aes(x = 90, y = 6, xend = 100, yend = 28), color = "black", size = 0.3, alpha = 0.8) + #CHINA
  geom_segment(data = data_merged_sub_ord, aes(x = -66, y = 39, xend = -89, yend = 39), color = "black", size = 0.3, alpha = 0.8) + #USA
  geom_segment(data = data_merged_sub_ord, aes(x = -48, y = 52, xend = -75, yend = 45), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -71, y = 86, xend = -71, yend = 81), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -52, y = 86, xend = -52, yend = 71), color = "black", size = 0.3, alpha = 0.8) + #GREENLAND
  geom_segment(data = data_merged_sub_ord, aes(x = -20, y = 86, xend = -20, yend = 74), color = "black", size = 0.3, alpha = 0.8)

#Load Libraries
library(readxl)
library(ggplot2)
library(dbplyr)
library(scatterpie)
library(reshape2)
# READ LONG FORMAT DATA

setwd("~/R_Projects/Reproductive Traits")

Long_format_metawebs <- readRDS("Data/RData/Long_format_metawebs.RData")

#SUBSET UNIQUE CASES PER NETWORK
Long_format_subset <-  unique(Long_format_metawebs[,c("Plant_species","Id")])
#It seems to work fine
#and the total number of species makes sense, a bit more than the total unique cases for all the networks


#READ TRAIT DATA IN ORDER TO MERGE
data <- read.csv("Data/Data_processing/all.csv", stringsAsFactors = F)
data <- data[,c(1,4,6,7,8,22,27)]
levels(as.factor(data$Breeding_system))
#Filter data for columns of interest
data_filtered <- subset(data, Info_level=="flower"|Info_level=="capitulum"|Info_level=="inflorescence"|Info_level=="NA")
#Rename column to merge
colnames(data_filtered)[1] <- "Plant_species"
#Convert to factor 
data_filtered <- as.data.frame(data_filtered, stringsAsFactors = TRUE)

#Merge the two dataframes (trait data and the unique cases per network)
all_species_per_network <- merge(Long_format_subset, data_filtered,  by=c("Plant_species","Id"), all = T )

#Group breeding system per metaweb or web
all_summary_compatibility_system <- dcast(all_species_per_network,Id~Compatibility,value.var = "Compatibility")

#Cleaning NA and one unfinished network
all_summary_compatibility_system <- all_summary_compatibility_system[,c(1,5:8)]

all_summary_compatibility_system$partially_self_compatible <- as.numeric(all_summary_compatibility_system$partially_self_compatible) + as.numeric(all_summary_compatibility_system$self_compatible_self_incompatible) 
all_summary_compatibility_system <- all_summary_compatibility_system[ , -4]
#Removing ".csv" from the Id to megere with coordinates
all_summary_compatibility_system$Id <- gsub("\\..*","",all_summary_compatibility_system$Id)

#Now merge with metadata to add coordinates to plot it
metadata <- read.csv("Data/Data_processing/metadata.csv", stringsAsFactors = F)
str(metadata)
metadata_sub <- metadata[,c(1:6,11)]
metadata_sub <- metadata_sub[ , -c(1)]
metadata_sub <- metadata_sub[order(metadata_sub$Id_number),] 
#Fix some coordinates manually, this locations have more than one
#fore representation purposes I will use just one
metadata_sub[6,3] <- "1.575532"
metadata_sub[6,4] <- "52.762395"
metadata_sub[7,3] <- "9.1"
metadata_sub[7,4] <- "56.1"
metadata_sub[29,3] <- "-6.16895"
metadata_sub[29,4] <- "37.234966"
metadata_sub <- metadata_sub[-14,]
colnames(metadata_sub)[1] <- "Id"

#Merge coordinates and data 
data_merged <- merge(metadata_sub, all_summary_compatibility_system)

data_merged$Id <- as.factor(data_merged$Id)
str(data_merged)

#I have done this in other code for other reasons
#I'm going to maintain it
data_merged_sub <- data_merged
#Plot data
world <- map_data('world')

data_merged_sub_ord <- data_merged_sub[order(data_merged_sub$Id_number),]
#Move coordinates manually to see all points (Improving plot visualization)
#Manual jitter
data_merged_sub_ord$Id_number <- seq(1, length(data_merged_sub_ord$Id_number))
#Fixing New Zealand pies
data_merged_sub_ord[19,4] <- -28
data_merged_sub_ord[19,3] <- 168
data_merged_sub_ord[20,4] <- -52
data_merged_sub_ord[20,3] <- 180
data_merged_sub_ord[21,4] <- -48
data_merged_sub_ord[21,3] <- 158

#Fixing Galapagos pies
data_merged_sub_ord[18,4] <- -7
data_merged_sub_ord[18,3] <- -105

data_merged_sub_ord[27,4] <- 6
data_merged_sub_ord[27,3] <- -105

#Fixing Mauritius pies
data_merged_sub_ord[13,4] <- -12
data_merged_sub_ord[13,3] <- 72
data_merged_sub_ord[17,4] <- -28
data_merged_sub_ord[17,3] <- 72

#Fixing Denmark pies
data_merged_sub_ord[3,4] <- 72
data_merged_sub_ord[4,4] <- 60
data_merged_sub_ord[7,4] <- 50

#Fixing Venezuela pies

data_merged_sub_ord[22,3] <- -45
data_merged_sub_ord[22,4] <- 10
data_merged_sub_ord[23,3] <- -45
data_merged_sub_ord[23,4] <- 25

#Fixing Japan pies

data_merged_sub_ord[11,3] <- 154
data_merged_sub_ord[14,3] <- 145
data_merged_sub_ord[14,4] <- 20

#Fixing Spain pies

data_merged_sub_ord[28,3] <- -20
data_merged_sub_ord[28,4] <- 28

data_merged_sub_ord[1,3] <- -20
data_merged_sub_ord[1,4] <- 52
data_merged_sub_ord[2,3] <- -30
data_merged_sub_ord[2,4] <- 40

#Fixing Argentina pies

data_merged_sub_ord[5,3] <- -90

#Fixing Brazil pies

data_merged_sub_ord[26,3] <- -30

#Fixing Sweden pies

data_merged_sub_ord[8,3] <- 40
data_merged_sub_ord[8,4] <- 78

#Fixing Denmark pies

data_merged_sub_ord[3,3] <- 0
data_merged_sub_ord[3,4] <- 80
data_merged_sub_ord[4,3] <- 15
data_merged_sub_ord[4,4] <- 80
data_merged_sub_ord[7,3] <- 45
data_merged_sub_ord[7,4] <- 60


#Fixing UK pies

data_merged_sub_ord[6,3] <- -8
data_merged_sub_ord[6,4] <- 67

#Fixing Australia

data_merged_sub_ord[12,3] <- 120

#Fixing China pie

data_merged_sub_ord[10,3] <- 90
data_merged_sub_ord[10,4] <- 0

#Fixing USA pie

data_merged_sub_ord[24,3] <- -60

#Fixing Canada pie
data_merged_sub_ord[25,3] <- -42
data_merged_sub_ord[25,4] <- 52
data_merged_sub_ord[15,3] <- -71
data_merged_sub_ord[15,4] <- 92

#Fixing Greenland pie

data_merged_sub_ord[16,4] <- 92
data_merged_sub_ord[9,4] <- 92

data_merged_sub_ord[,c(3,4,7:9)] <- sapply(data_merged_sub_ord[,c(3,4,7:9)],as.numeric)
str(data_merged_sub_ord)

#network size fix


p2 <- ggplot(world, aes(long, lat)) +
  geom_map(map=world, aes(map_id=region), fill="white", color="grey", size=0.35) +
  coord_quickmap()+ylab("Latitude")+ xlab("Longitude")+coord_equal() + coord_sf( ylim = c(-60, 100), expand = FALSE) +  geom_scatterpie(aes(x=longitude, y=latitude,group=Id), 
 data = data_merged_sub_ord, cols = colnames(data_merged_sub_ord[,c(7:9)]),alpha=.8)+ 
  scale_fill_manual(breaks = colnames(data_merged_sub_ord[,c(7:9)]),
 labels = c("Partially self compatible", "Self compatible", "Self incompatible"),values = c("partially_self_compatible" = "#4DAF4A","self_compatible" = "#984EA3","self_incompatible" = "orange")) +labs(title = "Compatibility system",subtitle = "", caption = "",fill = NULL) + theme(legend.position = c(0.18, 0.010),legend.justification = c(1, 0),legend.text=element_text(size=5),
  axis.ticks = element_blank(),legend.key.size = unit(0.16, "cm")) +
  geom_segment(data = data_merged_sub_ord,aes(x = 168, y = -34, xend = 172, yend = -43),color = "black", size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 179, y = -46, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 164, y = -48, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = 6, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) +  #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = -7, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) + #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -12), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -28), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y = 10, xend = -61, yend = 5.5), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y =25 , xend = -67, yend = 8.9), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = 148, y = 35, xend = 135.8, yend = 35), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 140, y = 22, xend = 129, yend = 28), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -15.5, y = 32, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -15, y = 50, xend = 3, yend = 43), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -24, y = 40, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -84, y = -32, xend = -68, yend = -32), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -36, y = -21, xend = -58, yend = -21), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 34, y = 78, xend = 18.5, yend = 68), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 0, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 15, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -8, y = 61, xend = 1.5, yend = 52), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 39, y = 60, xend = 9, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 126, y = -36, xend = 148, yend = -36), color = "black", size = 0.3, alpha = 0.8) + #AUS
  geom_segment(data = data_merged_sub_ord, aes(x = 90, y = 6, xend = 100, yend = 28), color = "black", size = 0.3, alpha = 0.8) + #CHINA
  geom_segment(data = data_merged_sub_ord, aes(x = -66, y = 39, xend = -89, yend = 39), color = "black", size = 0.3, alpha = 0.8) + #USA
  geom_segment(data = data_merged_sub_ord, aes(x = -48, y = 52, xend = -75, yend = 45), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -71, y = 86, xend = -71, yend = 81), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -52, y = 86, xend = -52, yend = 71), color = "black", size = 0.3, alpha = 0.8) + #GREENLAND
  geom_segment(data = data_merged_sub_ord, aes(x = -20, y = 86, xend = -20, yend = 74), color = "black", size = 0.3, alpha = 0.8)

#Load Libraries
library(readxl)
library(ggplot2)
library(dbplyr)
library(scatterpie)
library(reshape2)
# READ LONG FORMAT DATA
setwd("~/R_Projects/Reproductive Traits")

Long_format_metawebs <- readRDS("Data/RData/Long_format_metawebs.RData")

#SUBSET UNIQUE CASES PER NETWORK
Long_format_subset <-  unique(Long_format_metawebs[,c("Plant_species","Id")])
#It seems to work fine
#and the total number of species makes sense, a bit more than the total unique cases for all the networks


#READ TRAIT DATA IN ORDER TO MERGE
data <- read.csv("Data/Data_processing/all.csv", stringsAsFactors = F)
data <- data[,c(1,4,6,7,8,51,27)]
levels(as.factor(data$Breeding_system))
#Filter data for columns of interest
data_filtered <- subset(data, Info_level=="flower"|Info_level=="capitulum"|Info_level=="inflorescence"|Info_level=="NA")
#Rename column to merge
colnames(data_filtered)[1] <- "Plant_species"
#Convert to factor 
data_filtered <- as.data.frame(data_filtered, stringsAsFactors = TRUE)

#Merge the two dataframes (trait data and the unique cases per network)
all_species_per_network <- merge(Long_format_subset, data_filtered,  by=c("Plant_species","Id"), all = T )

#Group breeding system per metaweb or web
all_summary_life_form <- dcast(all_species_per_network,Id~life_form,value.var = "life_form")
#Cleaning NA and one unfinished network
all_summary_life_form <- all_summary_life_form[-c(6,30),-c(6)]
#Removing ".csv" from the Id to megere with coordinates
all_summary_life_form$Id <- gsub("\\..*","",all_summary_life_form$Id)

#Now merge with metadata to add coordinates to plot it
metadata <- read.csv("Data/Data_processing/metadata.csv", stringsAsFactors = F)
str(metadata)
metadata_sub <- metadata[,c(1:6,11)]
metadata_sub <- metadata_sub[ , -c(1)]
metadata_sub <- metadata_sub[order(metadata_sub$Id_number),] 
#Fix some coordinates manually, this locations have more than one
#fore representation purposes I will use just one
metadata_sub[6,3] <- "1.575532"
metadata_sub[6,4] <- "52.762395"
metadata_sub[7,3] <- "9.1"
metadata_sub[7,4] <- "56.1"
metadata_sub[29,3] <- "-6.16895"
metadata_sub[29,4] <- "37.234966"
metadata_sub <- metadata_sub[-14,]
colnames(metadata_sub)[1] <- "Id"

#Merge coordinates and data 
data_merged <- merge(metadata_sub, all_summary_life_form)


data_merged$Id <- as.factor(data_merged$Id)
str(data_merged)

#I have done this in other code for other reasons
#I'm going to maintain it
data_merged_sub <- data_merged
#Plot data
world <- map_data('world')

data_merged_sub_ord <- data_merged_sub[order(data_merged_sub$Id_number),]
#Move coordinates manually to see all points (Improving plot visualization)
#Manual jitter
data_merged_sub_ord$Id_number <- seq(1, length(data_merged_sub_ord$Id_number))
#Fixing New Zealand pies
data_merged_sub_ord[19,4] <- -28
data_merged_sub_ord[19,3] <- 168
data_merged_sub_ord[20,4] <- -52
data_merged_sub_ord[20,3] <- 180
data_merged_sub_ord[21,4] <- -48
data_merged_sub_ord[21,3] <- 158

#Fixing Galapagos pies
data_merged_sub_ord[18,4] <- -7
data_merged_sub_ord[18,3] <- -105

data_merged_sub_ord[27,4] <- 6
data_merged_sub_ord[27,3] <- -105

#Fixing Mauritius pies
data_merged_sub_ord[13,4] <- -12
data_merged_sub_ord[13,3] <- 72
data_merged_sub_ord[17,4] <- -28
data_merged_sub_ord[17,3] <- 72

#Fixing Denmark pies
data_merged_sub_ord[3,4] <- 72
data_merged_sub_ord[4,4] <- 60
data_merged_sub_ord[7,4] <- 50

#Fixing Venezuela pies

data_merged_sub_ord[22,3] <- -45
data_merged_sub_ord[22,4] <- 10
data_merged_sub_ord[23,3] <- -45
data_merged_sub_ord[23,4] <- 25

#Fixing Japan pies

data_merged_sub_ord[11,3] <- 154
data_merged_sub_ord[14,3] <- 145
data_merged_sub_ord[14,4] <- 20

#Fixing Spain pies

data_merged_sub_ord[28,3] <- -20
data_merged_sub_ord[28,4] <- 28

data_merged_sub_ord[1,3] <- -20
data_merged_sub_ord[1,4] <- 52
data_merged_sub_ord[2,3] <- -30
data_merged_sub_ord[2,4] <- 40

#Fixing Argentina pies

data_merged_sub_ord[5,3] <- -90

#Fixing Brazil pies

data_merged_sub_ord[26,3] <- -30

#Fixing Sweden pies

data_merged_sub_ord[8,3] <- 40
data_merged_sub_ord[8,4] <- 78

#Fixing Denmark pies

data_merged_sub_ord[3,3] <- 0
data_merged_sub_ord[3,4] <- 80
data_merged_sub_ord[4,3] <- 15
data_merged_sub_ord[4,4] <- 80
data_merged_sub_ord[7,3] <- 45
data_merged_sub_ord[7,4] <- 60


#Fixing UK pies

data_merged_sub_ord[6,3] <- -8
data_merged_sub_ord[6,4] <- 67

#Fixing Australia

data_merged_sub_ord[12,3] <- 120

#Fixing China pie

data_merged_sub_ord[10,3] <- 90
data_merged_sub_ord[10,4] <- 0

#Fixing USA pie

data_merged_sub_ord[24,3] <- -60

#Fixing Canada pie
data_merged_sub_ord[25,3] <- -42
data_merged_sub_ord[25,4] <- 52
data_merged_sub_ord[15,3] <- -71
data_merged_sub_ord[15,4] <- 92

#Fixing Greenland pie

data_merged_sub_ord[16,4] <- 92
data_merged_sub_ord[9,4] <- 92

data_merged_sub_ord[,c(3,4,7:10)] <- sapply(data_merged_sub_ord[,c(3,4,7:10)],as.numeric)
str(data_merged_sub_ord)


p3 <- ggplot(world, aes(long, lat)) +
  geom_map(map=world, aes(map_id=region), fill="white", color="grey") +
  coord_quickmap()+ylab("Latitude")+ xlab("Longitude")+coord_equal() + coord_sf( ylim = c(-60, 100), expand = FALSE) +  geom_scatterpie(aes(x=longitude, y=latitude,group=Id), 
                     data = data_merged_sub_ord, cols = colnames(data_merged_sub_ord[,c(7:10)]),alpha=.8)+ 
  scale_fill_manual(breaks = colnames(data_merged_sub_ord[,c(7:10)]),
                    labels = c("Herb", "Shrub", "Tree", "Vine"),values = c("herb" = "#4DAF4A",
                                                                           "shrub" = "#984EA3","tree" = "orange", "vine" = "lightblue")) +labs(title = "Life form",subtitle = "",
                                                                                                                                               caption = "",fill = NULL) + theme(legend.position = c(0.12, 0.009),legend.justification = c(1, 0),
                                                                                                                                                                                 axis.ticks = element_blank(),legend.key.size = unit(0.2, "cm")) +
  geom_segment(data = data_merged_sub_ord,aes(x = 168, y = -34, xend = 172, yend = -43),color = "black", size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 179, y = -46, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = 164, y = -48, xend = 172, yend = -43), color = "black",size = 0.3, alpha = 0.8) + #NZ
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = 6, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) +  #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = -99, y = -7, xend = -90, yend = 0), color = "black", size = 0.3, alpha = 0.8) + #GALAPAGOS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -12), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = 57, y = -20.5, xend = 66, yend = -28), color = "black", size = 0.3, alpha = 0.8) + #MAURITIUS
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y = 10, xend = -61, yend = 5.5), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = -51, y =25 , xend = -67, yend = 8.9), color = "black", size = 0.3, alpha = 0.8) + #VENEZUELA
  geom_segment(data = data_merged_sub_ord, aes(x = 148, y = 35, xend = 135.8, yend = 35), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 140, y = 22, xend = 129, yend = 28), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -15.5, y = 32, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -15, y = 50, xend = 3, yend = 43), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -24, y = 40, xend = -6, yend = 37), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -84, y = -32, xend = -68, yend = -32), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = -36, y = -21, xend = -58, yend = -21), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 34, y = 78, xend = 18.5, yend = 68), color = "black", size = 0.3, alpha = 0.8) + 
  geom_segment(data = data_merged_sub_ord, aes(x = 0, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 15, y = 74.5, xend = 10, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = -8, y = 61, xend = 1.5, yend = 52), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 39, y = 60, xend = 9, yend = 56), color = "black", size = 0.3, alpha = 0.8) +
  geom_segment(data = data_merged_sub_ord, aes(x = 126, y = -36, xend = 148, yend = -36), color = "black", size = 0.3, alpha = 0.8) + #AUS
  geom_segment(data = data_merged_sub_ord, aes(x = 90, y = 6, xend = 100, yend = 28), color = "black", size = 0.3, alpha = 0.8) + #CHINA
  geom_segment(data = data_merged_sub_ord, aes(x = -66, y = 39, xend = -89, yend = 39), color = "black", size = 0.3, alpha = 0.8) + #USA
  geom_segment(data = data_merged_sub_ord, aes(x = -48, y = 52, xend = -75, yend = 45), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -71, y = 86, xend = -71, yend = 81), color = "black", size = 0.3, alpha = 0.8) + #CANADA
  geom_segment(data = data_merged_sub_ord, aes(x = -52, y = 86, xend = -52, yend = 71), color = "black", size = 0.3, alpha = 0.8) + #GREENLAND
  geom_segment(data = data_merged_sub_ord, aes(x = -20, y = 86, xend = -20, yend = 74), color = "black", size = 0.3, alpha = 0.8)

grid.arrange(p1, p2, p3, nrow=3)

 #grid.draw(arrangeGrob(ggplotGrob(p1),ggplotGrob(p2),nrow=2))
#mylegend
 dev.off()

```

