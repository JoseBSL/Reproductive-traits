---
title: "Untitled"
output: pdf_document
---


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10, fig.width=6}
setwd("~/R_Projects/Reproductive Traits")
library(dplyr)
library(ggplot2)
library(viridis)
library(grid)
library(cowplot)
library(gridExtra)

#PREPARE DATA
#read unscaled trait data in order to visualize better the clusters
d <- read.csv("Data/Csv/all_species_imputed_trait_data.csv")
#read trait data with clusters
#I'll select the column of clusters and include it on the non standardize trait data
hclust_d_5 <- read.csv("Data/Csv/imputed_trait_data_hclust_5_clusters.csv") #5 clusters
#No add the cluster columns (it has the same order)
d$Clusters <- as.factor(hclust_d_5$Clusters)

#select columns of interest
t <- d[c("Breeding_system","IMPUTED_Compatibility","Autonomous_selfing_level",
                        "Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", "Flowers_per_plant", "Flowers_per_inflorescence",
                        "Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean", "STYLE_IMPUTED", "OVULES_IMPUTED", "life_form", "lifespan",
                        "IMPUTED_plant_height_mean_m", "Clusters")]



#GENERATE PLOTS
########################################################################################################################################
#Breeding system
########################################################################################################################################
breeding <- ggplot(t, aes(Clusters, Breeding_system)) +
  geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
  theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Breeding system")+
  geom_hline(yintercept=c(1.5,2.5),color="black",linetype="longdash")
########################################################################################################################################
#Compatibility
########################################################################################################################################
t$IMPUTED_Compatibility <- as.character(t$IMPUTED_Compatibility)
t$IMPUTED_Compatibility[t$IMPUTED_Compatibility=="monoecious"] <- "Unisexual flowers"
t$IMPUTED_Compatibility[t$IMPUTED_Compatibility=="dioecious"] <- "Unisexual flowers"
t$IMPUTED_Compatibility[t$IMPUTED_Compatibility=="self_incompatible"] <- "Self incompatible"
t$IMPUTED_Compatibility[t$IMPUTED_Compatibility=="self_compatible"] <- "Self compatible"
t$IMPUTED_Compatibility[t$IMPUTED_Compatibility=="partially_self_compatible"] <- "Partially self compatible"

Compatibility <- ggplot(t, aes(Clusters, IMPUTED_Compatibility)) +
  geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
  theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Compatibility system")+
  geom_hline(yintercept=c(1.5,2.5,3.5),color="black",linetype="longdash")
########################################################################################################################################
#Autonomous_selfing_level
########################################################################################################################################
t$Autonomous_selfing_level <- as.character(t$Autonomous_selfing_level)
t$Autonomous_selfing_level[t$Autonomous_selfing_level=="none"] <- "None"
t$Autonomous_selfing_level[t$Autonomous_selfing_level=="medium"] <- "Medium"
t$Autonomous_selfing_level[t$Autonomous_selfing_level=="low"] <- "Low"
t$Autonomous_selfing_level[t$Autonomous_selfing_level=="high"] <- "High"
t$Autonomous_selfing_level <- factor(t$Autonomous_selfing_level, levels = c("None", "Low", "Medium", "High"))

Selfing <- ggplot(t, aes(Clusters, Autonomous_selfing_level)) +
  geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
  theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Selfing level")+
  geom_hline(yintercept=c(1.5,2.5,3.5),color="black",linetype="longdash")
#######################################################################################################################################
#Flower_morphology
#######################################################################################################################################

t$Flower_morphology <- as.character(t$Flower_morphology)
t$Flower_morphology[t$Flower_morphology=="Funnelform"] <- "Tube"
t$Flower_morphology[t$Flower_morphology=="Spike"] <- "Brush"

Flower_morphology <-  ggplot(t, aes(Clusters, Flower_morphology)) +
  geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
  theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Flower shape")+
  geom_hline(yintercept=c(1.5,2.5,3.5,4.5,5.5),color="black",linetype="longdash")
#######################################################################################################################################
#Flower_symmetry
#######################################################################################################################################
t$Flower_symmetry <- as.character(t$Flower_symmetry)
t$Flower_symmetry[t$Flower_symmetry=="zygomorphic"] <- "Zygomorphic"
t$Flower_symmetry[t$Flower_symmetry=="actinomorphic"] <- "Actinomorphic"

Flower_symmetry <-  ggplot(t, aes(Clusters, Flower_symmetry)) +
   geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
   theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Flower symmetry")+
  geom_hline(yintercept=c(1.5),color="black",linetype="longdash")
#######################################################################################################################################
 #life_form
#######################################################################################################################################
t$life_form <- as.character(t$life_form)
t$life_form[t$life_form=="vine"] <- "Herb"
t$life_form[t$life_form=="herb"] <- "Herb"
t$life_form[t$life_form=="shrub"] <- "Shrub"
t$life_form[t$life_form=="tree"] <- "Tree"

life_form <-  ggplot(t, aes(Clusters,life_form )) +
   geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
   theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x=NULL,y=NULL,subtitle = "Life form")+
  geom_hline(yintercept=c(1.5,2.5),color="black",linetype="longdash")
#######################################################################################################################################
 #lifespan
#######################################################################################################################################
lifespan<- ggplot(t, aes(Clusters,lifespan )) +
   geom_jitter(aes(color = Clusters), size = 0.4)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))+
   theme_classic()+ theme_classic()+theme(legend.position = "none")+labs(x="Plant Functional groups",y=NULL,subtitle = "Life span")+
  geom_hline(yintercept=c(1.5),color="black",linetype="longdash")


library(cowplot)
 #Plant height
 p1 <- ggplot(t, aes(x = Clusters, y = log(IMPUTED_plant_height_mean_m)))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Plant height)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 #Flower size
 p2 <- ggplot(t, aes(x = Clusters, y = log(Floral_unit_width)))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Flower size)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 #Ovule number
 p3 <- ggplot(t, aes(x = Clusters, y = log(OVULES_IMPUTED)))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Ovules per flower)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 #Style length
 p4 <- ggplot(t, aes(x = Clusters, y = log(STYLE_IMPUTED)))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Style length)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 #Flowers per plant
 p5 <- ggplot(t, aes(x = Clusters, y = log(Flowers_per_plant)))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Flowers per plant)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 #Flowers per plant
 p6 <- ggplot(t, aes(x = Clusters, y = Autonomous_selfing_level_fruit_set))+ geom_violin(aes(color = Clusters, fill = Clusters), 
 binaxis='y', stackdir='center')  +theme_classic()+ ylab("log(Selfing)")+geom_boxplot(width=0.1)+
 theme(legend.position = "none")
 

 



#Load libraries
#LOAD LIBRARIES
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.3)),
            axis.text=element_text(size = rel(2), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(0.9, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_for_rmd_plot_ppca.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots
all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$Clusters <- dat_cleaning_5$Clusters
 dat$Clusters <- as.factor(dat_cleaning_5$Clusters)
  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Clusters),size=2)+ scale_color_manual(values =  c("#00AFBB", "#E69F00", "#FC4E07","#000000", "#009E73"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
 # plot <- plot + xlab(paste("PC1 ", "(",(percentage[1]),")","%", sep = "")) #XLAB
  #plot <- plot + ylab(paste("PC2 ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  #plot <- plot + theme(panel.grid.minor = element_blank(),panel.grid.major = element_blank(),
   #                    panel.border = element_rect(linetype = "solid", colour = "black", size=1))
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,5.35,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,5,5,7,5.8,6.5)),
                          label = PCAloadings$Variables, color="black",size=5)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.07, 0.11)) +ggtitle("") +xlab("")+ylab("")
  
  
  plot
  
}

p1 <- plot_grid(all_spp(PC))

#p3 <- PCbiplot(PC)

p2 <- plot_grid(breeding,Compatibility,Flower_morphology,Flower_symmetry,life_form,lifespan,
        nrow = 3,ncol=2,align = 'h')

plot_grid(p1,p2,ncol=1)

#top <- plot_grid(p1,p2,p3,p4,p5,p6, nrow = 2,ncol=3,align = 'v')

#plot_grid(top,bottom,nrow = 2)



```

