---
header-includes:
    - \usepackage{setspace}\doublespacing
output:
  pdf_document: default
  html_document: default
---

\setlength{\abovedisplayskip}{25pt}
\setlength{\belowdisplayskip}{25pt}
\setlength{\abovedisplayshortskip}{25pt}
\setlength{\belowdisplayshortskip}{25pt}

```{r, echo = F}
library(knitr)
if(is_latex_output()) {
  plot_default <- knit_hooks$get("plot")
  knit_hooks$set(plot = function(x, options) { 
    x <- c(plot_default(x, options), "\\vspace{25pt}")
  })
}
```

# Model 1 

```brm(visits ~ autonomous_selfing_level + (1|net_id) + (1|gr(phylo, cov = A))```


This model uses both quantitative and qualitative data of selfing levels which is grouped in 4 categories: "high", "medium", "low" and "none". The response variable is the integer of visits. Note that the quantitative measurement that we use is autonomous fruit production and is grouped as follows: 0=none, >0-25=low, >25-75=medium; >75-100=high.

Check now the fit of the model:

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=3.5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")

#Model fit
pp_check(m1) + xlim(-100,2000)+ylim(0,0.02)


```

The fit seems right, check now estimates, se and credible intervals:

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=3.5, fig.height=2, fig.align='center'}
setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")
c_e <- conditional_effects(m1)
p1 <- plot(c_e, points=T,plot = FALSE)[[1]]

#Estimates, se and ci
d <- p1[[1]][,c(1,7:10)]
kable(d, "latex") %>%  kable_styling(position = "center")


```

Plot output: 

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")

c_e <- conditional_effects(m1)
p1 <- plot(c_e, points=T,plot = FALSE)[[1]]

#ylim500
ggplot(data=p1[[1]], aes(x = autonomous_selfing_level, y = visits,color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=lower__, ymax=upper__), width=.1, color="black")+
  geom_point(data=p1[[1]], mapping=aes(x=autonomous_selfing_level, y=estimate__), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none")

```

\newpage

Set ylim max to 500 in order to improve visualization Some data points not shown.

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")

c_e <- conditional_effects(m1)
p1 <- plot(c_e, points=T,plot = FALSE)[[1]]

#ylim500
ggplot(data=p1[[1]], aes(x = autonomous_selfing_level, y = visits,color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=lower__, ymax=upper__), width=.1, color="black")+
  geom_point(data=p1[[1]], mapping=aes(x=autonomous_selfing_level, y=estimate__), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none") + ylim(0,500)

```

Try now to logit estimates, credible intervals and points, maybe improves visualization?

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")

c_e <- conditional_effects(m1)
p1 <- plot(c_e, points=T,plot = FALSE)[[1]]

#Prepare example with selfing level
all_df_2 <- all_df_2 %>%
  mutate(autonomous_selfing_level = fct_relevel(autonomous_selfing_level, levels=c("high", "medium", "low", "none")))
all_df_2$autonomous_selfing_level <- as.factor(all_df_2$autonomous_selfing_level)

#Log
ggplot(data=p1[[1]], aes(x = autonomous_selfing_level, y = log(visits),color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=log(lower__), ymax=log(upper__)), width=.1, color="black")+
  geom_point(data=p1[[1]], mapping=aes(x=autonomous_selfing_level, y=log(estimate__)), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none")


```

So far we haven't found big differences between groups. Also note that we have a greater number of low and none self species. This could be discussed. Keep in mind.

Now IÂ´m going to exclude the dioecious and monoecioues species that were considered as non-selfers.


\newpage

# Model 2 Excluding species with flowers with separated sexes

```brm(visits ~ autonomous_selfing_level + (1|net_id) + (1|gr(phylo, cov = A))```

Check now the fit of the model:

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=3.5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_data_m1.1_visits_self_all.RData")

#Model fit
pp_check(m1) + xlim(-100,2000)+ylim(0,0.02)
```

Again, the fit seems right, check now estimates, se and credible intervals:

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=3.5, fig.height=2, fig.align='center'}
setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1_visits_self_all.RData")
load("Data/RData/brms_data_m1_visits_self_all.RData")
c_e <- conditional_effects(m1.1)
p1 <- plot(c_e, points=T,plot = FALSE)[[1]]

#Estimates, se and ci
d <- p1[[1]][,c(1,7:10)]
kable(d, "latex") %>%  kable_styling(position = "center")

```

Plot output: 

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_data_m1.1_visits_self_all.RData")

c_e.1 <- conditional_effects(m1.1)
p1.1 <- plot(c_e.1, points=T,plot = FALSE)[[1]]

#ylim500
ggplot(data=p1.1[[1]], aes(x = autonomous_selfing_level, y = visits,color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1.1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=lower__, ymax=upper__), width=.1, color="black")+
  geom_point(data=p1.1[[1]], mapping=aes(x=autonomous_selfing_level, y=estimate__), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none")

```


\newpage

Set ylim max to 500 in order to improve visualization Some data points not shown.

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_data_m1.1_visits_self_all.RData")

c_e.1 <- conditional_effects(m1.1)
p1.1 <- plot(c_e.1, points=T,plot = FALSE)[[1]]

#ylim500
ggplot(data=p1.1[[1]], aes(x = autonomous_selfing_level, y = visits,color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1.1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=lower__, ymax=upper__), width=.1, color="black")+
  geom_point(data=p1.1[[1]], mapping=aes(x=autonomous_selfing_level, y=estimate__), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none") + ylim(0,500)

```


Logit estimates, credible intervals and points

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE, fig.width=5, fig.height=2, fig.align='center'}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)

setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_data_m1.1_visits_self_all.RData")

c_e.1 <- conditional_effects(m1.1)
p1.1 <- plot(c_e.1, points=T,plot = FALSE)[[1]]

#Prepare example with selfing level
all_df_2 <- all_df_2 %>%
  mutate(autonomous_selfing_level = fct_relevel(autonomous_selfing_level, levels=c("high", "medium", "low", "none")))
all_df_2$autonomous_selfing_level <- as.factor(all_df_2$autonomous_selfing_level)

#Log
ggplot(data=p1.1[[1]], aes(x = autonomous_selfing_level, y = log(visits),color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_2,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1.1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=log(lower__), ymax=log(upper__)), width=.1, color="black")+
  geom_point(data=p1.1[[1]], mapping=aes(x=autonomous_selfing_level, y=log(estimate__)), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none")


```


Including or excluding dioecious and monoecious species does not make a very big differences in the models. 

BAYES R2 Model 1 including all species

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)
setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_m1_visits_self_all.RData")

bayes_R2(m1)
p1[[1]]
```

BAYES R2 Model 1 without monoecious and dioecious species

```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)
setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.1_visits_self_all.RData")
load("Data/RData/brms_m1_visits_self_all.RData")
bayes_R2(m1.1)
p1.1[[1]]

```

Because the qualitative data can add some noise to the analysis now I'm going to exclude it and just consider species that have quantitative information of the auntonomous selfing level. 

#MODEL 3 JUST QUANTITATIVE DATA BUT GROUPED IN 4 CATEGORIES NONE, LOW, MEDIUM, HIGH.

Two distributions fit the data: **Negative binomial** and **skew gaussian** with logit transformation of visits and because for the negative binomial I have to to log transform the data in order to improve visualization. I'm going to keep from now on with a **skew gaussian** with the logit of visits (the output is quite similar).


```{r, echo=FALSE, message=FALSE, cache=FALSE,  warning=FALSE}
library(brms)
library(ggplot2)
library(tidybayes)
library(tidyverse)
library(kableExtra)
setwd("~/R_Projects/Reproductive traits") 
load("Data/RData/brms_m1.2.1_visits_self_all.RData")
load("Data/RData/brms_data_m1.2.1_visits_self_all.RData")

c_e.1.2.1 <- conditional_effects(m1.2.1)
p1.2.1 <- plot(c_e.1.2.1, points=T,plot = FALSE)[[1]]

ggplot(data=p1.2.1[[1]], aes(x = autonomous_selfing_level, y = log(visits),color = ordered(autonomous_selfing_level))) +
  geom_point(data = all_df_4,alpha = 1/4) + 
  scale_fill_brewer(palette = "Greys") +
  scale_color_brewer(palette = "Set2") + theme_bw() +
  geom_errorbar(data=p1.2.1[[1]],mapping=aes(x=autonomous_selfing_level, ymin=lower__, ymax=upper__), width=.1, color="black")+
  geom_point(data=p1.2.1[[1]], mapping=aes(x=autonomous_selfing_level, y=estimate__), color="black") + ylab("Visits") + xlab("Selfing level")+
  theme(legend.position = "none")

bayes_R2(m1.2.1)

p1.2.1[[1]]

```
