---
title: "Trade-offs among plant floral and reproductive traits determine interactions with floral visitors"

author:
  - Jose B. Lanuza^1,2^*
  - Romina Rader^1^
  - Jamie Stavert^3^
  - Liam K. Kendall^4^
  - Manu E. Saunders^1^
  - Ignasi Bartomeus^2^

# may use lua filters for affiliations etc: see https://stackoverflow.com/a/52919256

# date: '`r Sys.Date()`'

output:
  bookdown::pdf_document2:
    fig_caption: yes
    fig_width: 7
    fig_height: 7
    df_print: kable
    keep_tex: yes
    number_sections: no
    extra_dependencies: ["float"]
    toc: no
    fig_crop: no
    includes:
      in_header: header.tex
    
documentclass: article
# classoption: twocolumn, landscape, etc
papersize: a4
pagestyle: plain  # plain, empty, headings
geometry: margin=1in
linestretch: 2
fontfamily: mathpazo
fontsize: 12pt

bibliography: 
  - references.bib
  - knitcitations.bib
# zotero: "My shared Zotero group"
csl: ecology.csl
# csl: https://www.zotero.org/styles/ecology

link-citations: yes
linkcolor: RoyalBlue
urlcolor: RoyalBlue
links-as-notes: false

header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}

---

<!--# Insert author affiliations below -->

\small
\doublespacing

^1^ School of Environmental and Rural Science, University of New England, Armidale, New South Wales 2350, Australia

^2^ Estación Biológica de Doñana (EBD-CSIC), E-41092 Seville, Spain

^3^ Department of Conservation | Te Papa Atawhai, Auckland, New Zealand

^4^ Centre for Environmental and Climate Science, Lund University, Sölvegatan 37, S-223 62 Lund, Sweden


`*` Corresponding author: barragansljose@gmail.com

\normalsize
\singlespacing


__Plant life strategies are often delimited by vegetative and physiological traits but little is known about how floral and reproductive traits drive these strategies, and in turn shape plant interactions with floral visitors. Here, we compiled 13 floral, 4 reproductive and 3 vegetative traits for 1,506 plant species from 28 plant-pollinator network studies across 18 different countries. We investigated the associations among these traits, pollinator visitation and the functional role of plant species within the networks (interaction frequency, normalized degree and specialization). We found that 51.8% of trait variation was explained by two independent axes that encompassed plant form and function. Specifically, the first axis indicated the presence of a trade-off between flower number and flower size (PC1, 26.72%). The second axis indicated a trade-off for the level of pollinator dependency (PC2, 25.08%). Although the main axes of trait variation did not fully explain pollinator visitation rates, different plant life strategies were associated with visitation rates and pollinator functional groups. Overall, the main traits that determined plant species’ functional roles were height, nectar concentration, pollen grains per flower, number of ovules, style length, selfing level and flower width. Our results highlight the need to consider plant reproductive and floral traits to improve understanding of plant life strategies and plant-pollinator interactions at broader spatial scales.__

\doublespacing
\vspace{5mm}
\bleft

```{r setup, include=FALSE, cache=FALSE, message = FALSE}

library("knitr")

### Chunk options: see http://yihui.name/knitr/options/ ###
## Text results
opts_chunk$set(echo = FALSE, warning = TRUE, message = TRUE)

## Code decoration
opts_chunk$set(tidy = TRUE, comment = NA, highlight = TRUE)

## Cache
# opts_chunk$set(cache = 2, cache.path = "output/cache/")

## Plots
opts_chunk$set(fig.path = "output/figures/")

```


```{r knitcitations, cache = FALSE}
library(knitcitations)
cleanbib()   
cite_options(citation_format = "pandoc")

```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H')
```

There is an astonishing diversity of floral structures and plant reproductive strategies among flowering plants (Barrett, 2002; Schiestl & Johnson, 2013), which have long been of interest to pollination biologists in terms of their relevance to plant-pollinator interactions. However, most studies that have explored reproductive (e.g., mating and compatibility systems) and floral trait (e.g., flower size or nectar provision) variation have concentrated on the individual or community level and thus, broader macroecological patterns remain poorly investigated (Carvalheiro et al., 2014; Baude et al., 2016; Munoz et al., 2016; Moeller et al., 2017; Grossenbacher et al., 2017). Indeed, studies depicting species’ life history strategies generally focus on vegetative traits and rarely consider reproductive traits (Salguero-Gómez et al., 2016; Rüger et al., 2018). As a consequence, a unified framework that explores the compromises among floral traits and their relevance to plant life strategies is currently lacking (Roddy et al., 2021). At the same time, there is growing interest in the determinants of plant-pollinator interactions via trait-based approaches (Fenster et al., 2004) and trait-matching analyses (Bartomeus et al., 2016). However, floral traits have been overlooked beyond highly specialised plant-pollinator systems (Dellinger, 2020; Roddy et al., 2021) and the role of plant reproductive biology remains little explored in plant-pollinator interactions (but see Tur et al., 2013 and Devaux et al., 2014).

With the recent availability of large trait databases, plant ecological strategies are increasingly being examined (e.g., TRY, Kattge et al., 2011 and COMPADRE, Salguero‐Gómez et al., 2015), and are facilitating the identification of global patterns and constraints of plant form and function (Salguero‐Gómez et al., 2015; Díaz et al., 2016; Carmona et al., 2021). However, the main focus has been on vegetative traits such as leaf (Wright et al., 2004) or wood (Chave et al., 2009) trade-offs with little or no attention given to reproductive and floral traits (E‐Vojtkó et al., 2020), also critical to plant form and function. For instance, short lived versus perennial species tend to have low versus high levels of outcrossing, respectively (Barrett, 2003; Moeller et al., 2017). Further, outcrossing levels are positively correlated with flower size (Goodwillie et al., 2010). In addition, the presence of costly rewards (e.g., pollen or nectar) and showy flowers or floral displays can only be understood through consideration of plant species’ reliance upon animal pollination (pollinator dependence) and their role in attracting pollinators (Ollerton et al., 2011). Hence, exploring plant life strategies with reproductive and floral trade-offs, in conjunction with their pollinator dependence, is necessary for a balanced understanding of plant economics.

Several studies have identified links between plant traits and plant-pollinator network properties (Lázaro et al., 2008; Bartomeus, 2013; Carvalheiro et al., 2014). Moreover, plant traits can also define species' network roles (e.g., specialists vs generalists). For example, species that occupy trait space extremes are more likely to exhibit higher specialization and be more reliant on trait-matching (Junker et al., 2013; Coux et al., 2016). This morphological matching between plant and floral visitors can determine plant-pollinator interactions, and thus shape their interaction network structure (Stang et al., 2009; Ibanez, 2012). Despite the increasing knowledge of the relevance of traits on the species network roles, little is known about how plant reproductive and floral traits determine plant species’ network roles at a macroecological scale. 

Here, we explore the potential trade-offs among plant floral and reproductive traits and how these influence the structure of plant-pollinator networks. First, we identify the major axes of floral and reproductive trait variation and trade-offs that determine plant form and function. Second, we investigate how plant species’ position in trait-space influences interaction strength with different guilds of floral visitors. Finally, we investigate how the main axes of trait variation and individual traits influence plant species roles within networks using complementary interaction network metrics (i.e., interaction strength, normalized degree and specialization).

# RESULTS 

**Plant strategies**

The phylogenetically informed principal component analysis (pPCA) captured by the first two and three axes 51.8% and 70.97% of trait variation, respectively (Figure 1 and Figure S5) and had a phylogenetic correlation (**lambda**) of 0.76. The first principal component (PC1) represented 26.72% of the trait variation and indicated a trade-off between flower number and flower size. We refer to this axis as the ‘flower number - flower size trade-off as already described in previous studies (Sargent et al., 2007; Kettle et al., 2011). Hence, one end of the spectrum comprised species with high investment in flower number and plant height but small flower size, short style length and low ovule number. The other end of this spectrum comprised species that were short in height and invested in large flowers, long styles, many ovules, but few flowers. The main contributing traits to PC1 were plant height, flower number, ovule number and flower size (loadings > |0.5|; Table S3) but style length also contributed moderately on PC1 (loading = -0.33). The second principal component (PC2) represented 25.05% of the trait variation and indicated a trade-off between low and high pollinator dependence. We refer to this axis as the ‘pollinator dependence trade-off’. The main driver of trait variation on PC2 was autonomous selfing (loading = 0.85) but the other traits (except ovule number) also made moderate contributions (loadings from 0.27 to 0.4; Table S3). We found that high pollinator dependence was associated with larger and higher numbers of flowers, greater plant height and longer styles. In contrast, species with high levels of autonomous selfing tended to have fewer and smaller flowers, had shorter styles and were shorter in height. Further, PC3 explained a considerable amount of trait variability (19.17%) and the main contributors to this axis were style length (loading = -0.66) and the degree of autonomous selfing (loading = -0.51). The remaining traits, apart from ovule number, were moderately correlated to changes on PC3 (loadings from -0.23 to -0.46; Table S3). Thus, because style length was correlated with all traits on PC3 and was the main driver of variation, we refer to this axis as the ‘style length trade-off’. Further, the pPCA with the subset of species that had nectar and pollen quantity data showed that nectar quantity (microlitres of nectar per flower) was positively associated with flower size, style length and ovule number (PC1, 23.40%); and pollen quantity (pollen grains per flower) was positively correlated with flower number and plant height and negatively associated with autonomous selfing (PC2, 21.67%; Figure S6). This pPCA explained similar variance with the first two principal components (45.07%) and similar associations of traits despite some variability in the loadings (Table S4).

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10, fig.width=10,fig.pos = "t",fig.cap= "**Fig. 1 |** Life history strategies for 1,236 plant species from 28 plant-pollinator networks studies across the first two axes of trait variation from a phylogenetically informed principal component analysis (pPCA). The solid arrows indicate the direction of the different quantitative traits (flower number, plant height, style length, flower size, ovule number and level of autonomous selfing) in the 2-d plane. The length of the arrows indicate the weight of the variables on each principal component and the labelled icons at their end represent the extreme form of the trait continuum. The dashed lines show the opposed direction of trait variation and the non-labelled icons at their end illustrate the opposing extreme of the continuum."}

setwd("~/R_Projects/Reproductive Traits")

#Load libraries
library(viridis) #COLOUR GGPLOT
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
library(magick)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#Images were made by Paula Martin
#Check her work on https://paulamartinart.com/

tree <- image_read("Images/PPCA_Plot/Tree.png")
tree_1 <- as.raster(tree)

style_l <- image_read("Images/PPCA_Plot/Style_Long.png")
style_l_1 <- as.raster(style_l)

style_s <- image_read("Images/PPCA_Plot/Style_Short.png")
style_s_1 <- as.raster(style_s)

ovule_h <- image_read("Images/PPCA_Plot/Ovule_High.png")
ovule_h_1 <- as.raster(ovule_h)

ovule_l <- image_read("Images/PPCA_Plot/Ovule_Low.png")
ovule_l_1 <- as.raster(ovule_l)

selfing_n <- image_read("Images/PPCA_Plot/Selfing_None.png")
selfing_n_1 <- as.raster(selfing_n)

selfing_h <- image_read("Images/PPCA_Plot/selfing.png")
selfing_h_1 <- as.raster(selfing_h)

single_flower <- image_read("Images/PPCA_Plot/Single_Flower.png")
single_flower_1 <- as.raster(single_flower)

many_flowers <- image_read("Images/PPCA_Plot/Inflorescencia.png")
many_flowers_1 <- as.raster(many_flowers)
#many_flowers_1 <- image_rotate(many_flowers, 45)


large_flower <- image_read("Images/PPCA_Plot/flower_big.png")
large_flower_1 <- as.raster(large_flower)

flower_small <- image_read("Images/PPCA_Plot/flower_short.png")
flower_small_1 <- as.raster(flower_small)

herb <- image_read("Images/PPCA_Plot/herb.png")
herb_1 <- as.raster(herb)

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - flower size trade-off ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Pollinator dependence trade-off ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() + annotation_raster(tree_1, xmin = -4.1, xmax = -2.85,ymin = 2.05, ymax = 4.05)+
     annotation_raster(style_l_1, xmin = 2.25, xmax = 3.05,ymin = 2.55, ymax = 3.7) +
    annotation_raster(style_s_1, xmin = -2.6, xmax = -1.9,ymin = -2.65, ymax = -1.7) +
    annotation_raster(ovule_h_1, xmin = 3.5, xmax = 4.2,ymin = -0.45, ymax = 0.50) +
    annotation_raster(ovule_l_1, xmin = -4.2, xmax = -3.5,ymin = -0.45, ymax = 0.5) +
    annotation_raster(selfing_n_1, xmin = -0.75, xmax = 1.2,ymin = 2, ymax = 4.7) +
    annotation_raster(selfing_h_1, xmin = -0.30, xmax = 0.15,ymin = -3.9, ymax = -3.1) +
    annotation_raster(single_flower_1, xmin = 3.3, xmax = 4.1,ymin = -1.7, ymax = -0.7) +
    annotation_raster(many_flowers_1, xmin = -4.20, xmax = -3.40,ymin = 0.8, ymax = 1.45) +
    annotation_raster(large_flower_1, xmin = 3.15, xmax = 4.15,ymin = 1.3, ymax = 2.55) +
    annotation_raster(flower_small_1, xmin = -3.50, xmax = -2.55,ymin = -2, ymax = -1.50) +
    annotation_raster(herb_1, xmin = 2.6, xmax = 3,ymin = -2.8, ymax = -2) 


    
      #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.7,5.05,5.6,7.85,7.3,6.15)), y = -(PCAloadings$PC2*c(4.693,2.5,3.1,6.6,5,5.5)+c(0,0,0,0,0.4,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4)
  
 
 plot <- plot + annotate("text", x = (PCAloadings$PC1*c(4.6,4.95,4.5,6.6,7.3,5.15)), y = (PCAloadings$PC2*c(3.83,6.4,5.7,7.4,-1,7.45)+c(0,0,0,0,-0.41,0)),
                         label =c("Low selfing", "Few flowers", "Small flowers", "Short styles", "Few ovules", "Short plants" ), color="black",fontface =2,size=4)
 
 
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

plot_grid(all_spp(PC))



```

We found that most categorical traits were statistically associated with the first two axes of trait variation (Figure 2 and Table S2). Flower symmetry, which was only associated with PC2 (Sum of squares = 8.51, F-value = 14.72, p < 0.01 ), and nectar provision, which was independent of PC1 and PC2 (PC1: Sum of squares = 0.37, F-value = 0.29 , p = 0.59; PC2:  Sum of squares = 0.83, F-value = 1.43, p = 0.23) showed lack of statistical association. In addition, we found statistical differences (Tukey test) between the different levels of categorical traits in the trait space (Figure S7). Regarding self compatibility, we found larger differences on PC2 (i.e., species with unisexual flowers that were self incompatibile were statistically differentiated from species with partial or full self compatibility; Figure S7 A and B). Life forms differed statistically across both axes of trait variation and followed a gradient of larger life forms (trees and shrubs) with higher pollinator dependence to smaller ones (herbs) with lower pollinator dependence (Figure S7 C and D). Consequently, lifespan also followed this gradient but perennial and short lived species only differed statistically on PC2 (Figure S7 E and F). Species with unisexual flowers (monoecious and dioecious) were clustered on both extremes of the first two principal components and had the highest pollinator dependence and highest number of flowers (Figure S7 G and H). Moreover, we found that the campanulate and capitulum flower shapes were differentiated from tube, papilionaceous, open and brush shapes in the trait space. The former morphologies had larger flowers and greater pollinator dependence, while the latter had higher flower number and greater autonomous selfing (Figure S7 I and J). Regarding flower symmetry, zygomorphic flowers were associated with lower levels of pollinator dependence, whereas actinomorphic flowers had higher levels of pollinator dependence (Figure S7 K and L).


\blandscape

\vspace*{-28mm}


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=12, fig.width=18,fig.pos = "!H",fig.cap= "**Fig. 2 | Location of the different qualitative traits on the trait space.** The panel is composed by the traits that showed statistical association with the first two axes of trait variation: compatibility system (a), life form (b), lifespan (c), breeding system (d), flower shape (e) and flower symmetry (f)."}

#Set working directory
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
#library(phytools)
#library(ape) #for phylogenetic distance
#library(dplyr) #data processing
#library(rtrees) #for phylogenetic distancelibrary(MASS)
#library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
#library(cowplot)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(0.55, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank(),
            plot.title = element_text(size = rel(1.65), face="bold")
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_for_rmd_plot_ppca_QUALITATIVE.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")

#CALL the output PC for simplicity
PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots
Compatibility <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$Compatibility <- dat_cleaning_5$Compatibility_system
  dat$Compatibility <- as.character(dat$Compatibility)
  dat$Compatibility[dat$Compatibility=="dioecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="monoecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="partially_self_compatible"] <- "Partially self compatible"
  dat$Compatibility[dat$Compatibility=="self_compatible"] <- "Self compatible"
  dat$Compatibility[dat$Compatibility=="self_incompatible"] <- "Self incompatible"
  dat$Compatibility <- factor(dat$Compatibility, levels = c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Compatibility),size=1.75)+scale_color_manual(values=c("cyan4", "deepskyblue2","orange","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.185, 0.13)) +ggtitle("(a)") 
  
  
  plot
  
}

#Compatibility(PC)

#############################################################################################################################################################
#Life form
#############################################################################################################################################################
#Load plots
Life_form <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Life form` <- dat_cleaning_5$life_form
  dat$`Life form` <- as.character(dat$`Life form`)
  dat$`Life form`[dat$`Life form`=="herb"] <- "Herb"
  dat$`Life form`[dat$`Life form`=="shrub"] <- "Shrub"
  dat$`Life form`[dat$`Life form`=="tree"] <- "Tree"
  dat$`Life form`[dat$`Life form`=="vine"] <- "Shrub"
  
  dat$`Life form` <- factor( dat$`Life form`, levels = c("Herb", "Shrub", "Tree"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Life form`),size=1.75)+scale_color_manual(values=c("forestgreen", "darkorange2","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("(b)") 
  
  plot
  
}

#Life_form(PC)


#############################################################################################################################################################
#Life span
#############################################################################################################################################################
#Load plots
Life_span <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
    dat$Lifespan <- dat_cleaning_5$lifespan
    dat$Lifespan <- as.character(dat$Lifespan)

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Lifespan),size=1.75)+scale_color_manual(values=c("sienna4","forestgreen"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.102, 0.1)) + ggtitle("(c)") 
  
  plot
  
}

#Life_span(PC)


#############################################################################################################################################################
#Flower symmetry
#############################################################################################################################################################
#Load plots
Flower_sym <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower symmetry` <- dat_cleaning_5$Flower_symmetry
  dat$`Flower symmetry` <- as.character(dat$`Flower symmetry`)
  dat$`Flower symmetry`[dat$`Flower symmetry`=="actinomorphic"] <- "Actinomorphic"
  dat$`Flower symmetry`[dat$`Flower symmetry`=="zygomorphic"] <- "Zygomorphic"
  

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower symmetry`),size=1.75)+scale_color_manual(values=c("sienna2","purple"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.165, 0.1)) + ggtitle("(f)") 
  
  plot
  
}

#Flower_sym(PC)


#############################################################################################################################################################
#Flower shape
#############################################################################################################################################################
#Load plots
Flower_sha <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower shape` <- dat_cleaning_5$Flower_morphology
  dat$`Flower shape` <- as.character(dat$`Flower shape`)
  dat$`Flower shape`[dat$`Flower shape`=="Funnelform"] <- "Campanulate"
  dat$`Flower shape`[dat$`Flower shape`=="Spike"] <- "Brush"

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower shape`),size=1.75)+scale_color_manual(values=c("blue","cyan4", "red","forestgreen","purple","gold"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.13, 0.18)) + ggtitle("(e)") 
  
  plot
  
}

#Flower_sha(PC)


#############################################################################################################################################################
#Breeding system
#############################################################################################################################################################
#Load plots
Breeding_syst <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Breeding system` <- dat_cleaning_5$Breeding_system
  dat$`Breeding system` <- as.character(dat$`Breeding system`)
  dat$`Breeding system` <- factor(dat$`Breeding system`, levels=c("Hermaphrodite","Monoecious" ,"Dioecious"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Breeding system`),size=1.75)+scale_color_manual(values=c("forestgreen","orange", "black"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.163, 0.115)) + ggtitle("(d)") 
  
  plot
  
}

#Breeding_syst(PC)

#############################################################################################################################################################
#Nectar
#############################################################################################################################################################
#Load plots
#Nectar <- function(PC, x="PC1", y="PC2") {
#  # PC being a prcomp object
#  data <- data.frame(PC$S)
#  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
#  dat <- data.frame(x = data[,x], y = data[,y])
#  
#  #######
#  #DENSITY FUNCTION
#  #######
#  get_density <- function(x, y, ...) {
#    dens <- MASS::kde2d(x, y, ...)
#    ix <- findInterval(x, dens$x)
#    iy <- findInterval(y, dens$y)
#    ii <- cbind(ix, iy)
#    return(dens$z[ii])
#  }
#  
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$Nectar <- dat_cleaning_5$Nectar_presence_absence
#  dat$Nectar[dat$Nectar=="yes"] <- "Presence"
#  dat$Nectar[dat$Nectar=="no"] <- "Absence"
#  plot <- plot + geom_point(data=dat, aes(-x, -y, #colour=Nectar),size=1.75)+scale_color_manual(values=c("black","grey"))
#  
#  ########
#  #ADD ARROWS 
#  ########
#  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
#  mult <- min(
#    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
#    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
#  )
#  datapc <- transform(datapc,
#                      v1 = .75 * mult * (get(x)),
#                      v2 = .75 * mult * (get(y))
#  )
#  # add arrows
#  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, #yend=-v2),size=1, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
#  
#  #Add axis with perctentage
#  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
#
#  
#  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
#  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.6, #arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
#  
#  #ADD LABELS
#  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
#  
#  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
#  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = #-(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
#                          label = PCAloadings$Variables, color="black",size=3)
#  
#  #CHANGE THEME
#  #CHANGE THEME
#  
#  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("G)") 
#  
#  plot
#  
#}
#
# #plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flower_sym(PC),Nectar(PC), ncol=2,nrow=4,  align = "hv")

#  plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flowe#r_sym(PC),ncol=3,nrow=2,  align = "hv")

library(patchwork)
Compatibility(PC) + Life_form(PC) + Life_span(PC) + Breeding_syst(PC) + Flower_sha(PC) + Flower_sym(PC) + plot_layout(ncol=3)


```

\elandscape

\vspace{5mm}



\blandscape

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=13, fig.width=27, out.extra='',fig.cap="Location of the different qualitative traits that showed statistical association with the first two axes of trait variation. These different traits included: compatibility system (a), life form (b), lifespan (c), breeding system (d), flower shape (e) and flower symmetry (f)."}

#LOAD LIBRARIES 
#library(phytools)
#library(ape) #for phylogenetic distance
#library(dplyr) #data processing
#library(rtrees) #for phylogenetic distancelibrary(MASS)
#library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
#library(tidyverse)
library(patchwork) #panel of plots
#library(brms)
#library(cmdstanr)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2)),
           axis.text=element_text(size = rel(1.8), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.8, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.75),face="bold"),
           plot.subtitle = element_text(face="bold",size=rel(2))
     ))
}


setwd("~/R_Projects/Reproductive Traits")


p1 <- readRDS("Main_Figures/figure_2_1.rds")
p2 <- readRDS("Main_Figures/figure_2_2.rds")
p3 <- readRDS("Main_Figures/figure_2_3.rds")
pp1 <- readRDS("Main_Figures/figure_2_4.rds")
pp2 <- readRDS("Main_Figures/figure_2_5.rds")
pp3 <- readRDS("Main_Figures/figure_2_6.rds")

library(patchwork)

combined <- p1 + p2 + p3 + pp1 + pp2 + pp3 & theme(legend.position = "right")
combined + plot_layout(guides = "collect",ncol = 3)

```

\elandscape

**Phylogenetic signal of traits**


###OLD


Among flowering plants there is an astonishing diversity of floral structures and plant reproductive strategies [@barrett2002; @schiestl2013]. Subsequently, pollination biologists have long studied their relevance on plant-pollinator interactions. However, despite recent efforts exploring reproductive (e.g., mating and compatibility system) and floral traits (e.g., flower size or nectar provision) with large sets of species [@carvalheiro2014; @baude2016; @munoz2016; @moeller2017; @grossenbacher2017], most studies focus on the individual, community level or specific taxa and macroecological patterns remain poorly investigated. For instance, studies depicting species’ life history strategies generally focus on vegetative traits and rarely consider reproductive traits on the main axes of trait variation [@diaz2016; @salguero2016]. In addition, there is not a unified framework that explores the compromises of floral traits and their relevance on plant life strategies [@roddy2021]. Similarly, there is growing interest in understanding what determines plant-pollinator network structure. Approaches with traits range from the description of pollination syndromes [e.g., @dellinger2020], to more specific trait-matching analysis [@bartomeus2016], but again the reproductive biology of the species has received little attention [but see @tur2013 and @devaux2014] and floral traits have been overlooked beyond highly specialised plant-pollinator interactions [@dellinger2020; @roddy2021].


With increased availability of large trait databases, plant ecological strategies have begun to be examined more frequently [e.g., TRY, @kattge2011 and COMPADRE; @salguero2015], highlighting global patterns and constraints of plant form and function [@diaz2016; @salguero2016; @carmona2021]. However, these resources and their research have mainly focused on vegetative traits such as the leaf [@wright2004] or wood [@chave2009] trade-offs and neglected reproductive and floral traits that also can influence the spectrum of trait variation. For instance, short lived and perennial species tend to have high and low levels of outcrossing respectively [@barrett2003; @moeller2017] and outcrossing levels have been shown to be positively correlated with flower size [@goodwillie2010]. In addition, the presence of costly rewards (e.g., pollen or nectar) and showy flowers or floral displays cannot be understood without considering pollinators that are thought to be responsible for approximately 87.5% of the pollination of flowering plants [@ollerton2011]. Hence, exploring plant life strategies with reproductive and floral trade-offs, in conjunction with their known pollinators seems necessary for a correct understanding of the plant economics.

Several key studies have progressed knowledge of the link between traits and network properties [@lazaro2008; @bartomeus2013; @carvalheiro2014; @klumpers2019]. Functional traits can determine whether species interact, and thus define the species network role (e.g., specialist vs generalist). For instance, species with high investment in floral display tend to have higher visitation rates [@stang2006; @novella-fernandez2019] and greater specialization is generally associated with occupation of the trait space extremes [@junker2013; @coux2016]. In addition, the structure of the pollination network highly depends on the degree of trait-matching between plants and pollinators [@stang2009; @ibanez2012; @peralta2020]. However, little is known about the consequences of reproductive traits and floral rewards on plant species roles. In addition, although some attempts have been made to evaluate trait relationships in plant-pollinator interactions at a global scale [@carvalheiro2014; @rech2016], macroecological patterns have been little explored.

Here, we explore the major axes of plant reproductive trait variation. We investigate how these traits influence the structure of plant-pollinator networks by compiling a unique dataset comprising 20 plant functional traits for 1,506 species from 64 unique networks and 8 metawebs. First, we evaluate the major axes of reproductive trait variation and tradeoffs that determine plant form and function. Second, we investigate how plant species’ position in trait-space influences interaction strength with different  pollinator functional groups. Finally, we assess the relevance of the main axes of trait variation and traits in understanding the plant species role within the networks with complementary species level metrics (i.e., interaction strength, normalized degree and specialization).

# METHODS


##Plant-pollinator network studies

We selected 28 studies from 18 different countries that constituted a total of 64 plant-pollinator networks. All these studies censored plant-pollinator interactions in natural systems and were selected in order to have a wide representation of geographical areas of the world. Although these studies differ in sampling effort and methodology, all studies provided information about plant-pollinator interactions (weighted and non-weighted) allowing us to build a database of plants that are likely to be animal pollinated. Some of these networks have been already used in past studies of plant-pollinator networks [@olesen2007; @fortuna2010; @carvalheiro2014] and are available on the online networks archives The Web of Life [@fortuna2014] and Mangal [@poisot2016]. In total, our network dataset (Table S1) constituted 60 weighted (interaction frequency) and 4 binary networks, each sampled at a unique location and year, as well as 8 meta-webs where sampled interactions were pooled across several locations and multiple years. 

##Taxonomy of plants and pollinators 

All plant species names, genera, families and orders were retrieved and standardized from the taxonomy data sources NCBI (https://www.ncbi.nlm.nih.gov/taxonomy) (plants) and ITIS (https://www.itis.gov/) (pollinators) using the R package taxize [version 0.9.99, @chamberlain2020]. We filled the ‘not found’ searches manually using http://www.theplantlist.org/ and http://www.mobot.org/ for plants and http://www.catalogueoflife.org/ for floral visitors.

##Functional traits

We selected 20 different functional traits based on their relevance to plant reproduction and data availability (Table 1). The selected traits were quantitative (12) and categorical (8) and belonged to three different trait types: vegetative, floral and reproductive. For each species, we undertook an extensive literature and online search across a wide range of resources (plant databases, online floras, books, journals and images) from a total of 30,120 cells (20 columns x 1,506 spp) we were able to fill 23,969 cells (79.6% of the dataset, see Figure S1 for missing values information per variable).

\setstretch{1.25}


```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE, fig.height=8, fig.width=12}
setwd("~/R_Projects/Reproductive Traits")


library(kableExtra)

library(dplyr)
library(readxl) #read excel file (trait data)
library(dplyr) #data manipulation
library(visdat) #VISUALIZE MISSING DATA
library(naniar)
library(tidyverse)
########################################################################################################################################################
#1) READ TRAIT DATA
########################################################################################################################################################
#load data
trait_data <- read_excel("Data/Trait_data_raw/Trait_data_final.xlsx",na = "NA")
########################################################################################################################################################
#2) A) CLEAN DATA AND B) RENAME LEVELS FOR IMPUTATION 
########################################################################################################################################################
#####
#A) CLEAN DATA
#####
#select just filled rows
trait_data_1 <- trait_data[1:1712,] #It may be a more elegant way but this does the job, 1712 rows of data

#filter data, select species with flower level info and capitulum
trait_filtered <- filter(trait_data_1, Info_level == "flower" |  Info_level == "capitulum")
#remove NA's and duplicated species|Some spp are repeated once the spp names are standardize with taxize
trait_filtered$Species_all[trait_filtered$Species_all=="NA"]<-NA 
trait_filtered_1 <- trait_filtered[!is.na(trait_filtered$Species_all),]
trait_filtered_2 <- trait_filtered_1[!duplicated(trait_filtered_1$Species_all),]

#Select columns to work with
t <- trait_filtered_2[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system",
                        "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
                        "Flowers_per_plant","Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
                        "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration","Pollen_per_flower")]

########################################################################################################################################################
#####
#B) RENAME LEVELS FOR IMPUTATION
#####
#Breeding_system| For the purpose of this study we are not going to consider other complex breeding systems and just focus on 
#Hermaphroditism, dioecy and monoecy, the closest levels are grouped within each category
t$Breeding_system <- as.character(t$Breeding_system)
t$Breeding_system[t$Breeding_system=="androdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="androgynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="andromonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="gynoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="monoecious_dioecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="polygamo-dioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="protandrous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="protogynous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="subdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="submonoecious"] <- "monoecious"
#Change to capital letters| There are already levels with lower case
t$Breeding_system[t$Breeding_system=="monoecious"] <- "Monoecious"
t$Breeding_system[t$Breeding_system=="dioecious"] <- "Dioecious"
t$Breeding_system[t$Breeding_system=="hermaphrodite"] <- "Hermaphrodite"
t$Breeding_system <- as.factor(t$Breeding_system)

#Now 3 levels
#Flower_morphology
t$Flower_morphology <- as.character(t$Flower_morphology)
t$Flower_morphology[t$Flower_morphology=="bowl"] <- "open"
t$Flower_morphology[t$Flower_morphology=="dish"] <- "open"
t$Flower_morphology[t$Flower_morphology=="exposed"] <- "open"
t$Flower_morphology[t$Flower_morphology=="spadix"] <- "spike"
t$Flower_morphology[t$Flower_morphology=="open"] <- "Open"
t$Flower_morphology[t$Flower_morphology=="brush"] <- "Brush"
t$Flower_morphology[t$Flower_morphology=="campanulate"] <- "Campanulate"
t$Flower_morphology[t$Flower_morphology=="capitulum"] <- "Capitulum"
t$Flower_morphology[t$Flower_morphology=="funnelform"] <- "Funnelform"
t$Flower_morphology[t$Flower_morphology=="papilionaceous"] <- "Papilionaceous"
t$Flower_morphology[t$Flower_morphology=="spike"] <- "Spike"
t$Flower_morphology[t$Flower_morphology=="tube"] <- "Tube"
t$Flower_morphology <- as.factor(t$Flower_morphology)

#Life span
t$lifespan <- as.character(t$lifespan )
t$lifespan[t$lifespan=="annual"] <- "short_lived"
t$lifespan[t$lifespan=="biennial"] <- "short_lived"
t$lifespan[t$lifespan=="short_lived"] <- "Short lived"
t$lifespan[t$lifespan=="perennial"] <- "Perennial"
t$lifespan <- as.factor(t$lifespan )

########################################################################################################################################################
#3) EXPLORE PATTERNS OF MISSING DATA
########################################################################################################################################################

#We convert cualitative data to quantitative to reduce missing data on this column and hence conduct the imputation 
#use ifelse base r does not work with these NA'S Even with work around. base r does not like the na option of read excel
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("high") & is.na(t$Autonomous_selfing_level_fruit_set), 88, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("medium") & is.na(t$Autonomous_selfing_level_fruit_set), 50.5, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("low") & is.na(t$Autonomous_selfing_level_fruit_set), 13, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("none") & is.na(t$Autonomous_selfing_level_fruit_set), 0, t$Autonomous_selfing_level_fruit_set)

#t$Nectar_ul adding it here just to see how many cells 
#Now we just select presence/absence of nectar
#select columns of interest
t <- t[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system","Autonomous_selfing_level",
         "Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", "Flowers_per_plant", "Floral_unit_width",
         "Corolla_diameter_mean", "Corolla_length_mean", "Style_length", "Ovule_number", "life_form", "lifespan",
         "Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg","Nectar_concentration","Pollen_per_flower")]


########################################################################################################################################################
#4) CALCULATE PHYLOGENETIC DISTANCE TO CORRECT WITH EIGENVALUES IN THE IMPUTATION
########################################################################################################################################################
#Convert to factor 
cols <- c("Order_all", "Family_all", "Genus_all", "Species_all", "Compatibility_system", "Autonomous_selfing_level", "Flower_morphology",
          "Flower_symmetry", "life_form", "lifespan","Nectar_presence_absence")
t[cols] <- lapply(t[cols], factor)  ## as.factor() could also be used


cols.num <- c("Family_all","Genus_all","Species_all")
t[cols.num] <- sapply(t[cols.num],as.character)
t$Species_all <- gsub("Species_all_", "", t$Species_all)

t <- t[!t$Species_all == "Pinus luchuensis", ]   # remove gymnosperm species

#remove species that are not until species level
#ALL THE SPECIES WITH SP. ARE DELETD
t$Species_geonet <- gsub("M_PL_.*","",t$Species_geonet) #subsitute partial string for nothing
t$Species_geonet <- gsub(" $","", t$Species_geonet, perl=T) #remove trailing spaces
t$Species_geonet <-  sub('sp.1$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp.2$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp$', 'sp.', t$Species_geonet) #PREPARE ALL SP TO SP.
t$Species_geonet <- sub("sp.$", "DELETE", t$Species_geonet) #change all sp. for DELETE
t <- t[- grep("DELETE",  t$Species_geonet),] #remove species with "DELETE"
#CHECK LEVELS

#Make these NA's as NA
t$Species_all[t$Species_all=="NA"] <- NA
t$Family_all[t$Family_all=="NA"] <- NA
t$Genus_all[t$Genus_all=="NA"] <- NA
#remove NA's
t <- t[!is.na(t$Family_all),]
t <- t[!is.na(t$Species_all),]
t <- t[!is.na(t$Genus_all),]



missing.values <- t %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

n_of_records <- subset(missing.values, isna=="FALSE")
Trait <- c("Plant height (m)", "Flower width (mm)", "Flower length (mm)", "Inflorescence width (mm)", "Style length (mm)", "Ovules per flower",
           "Flowers per plant", "Nectar ($\\mu$l)", "Nectar (mg)", "Nectar concentration ($\\%$)", "Pollen grains per flower", "Autonomous selfing (fruit set)")

Trait1 <- c("Lifepan", "Life form", "Flower shape", "Flower symmetry", "Nectar", "Autonomous selfing", "Compatibility system", "Breeding system", " ", " ", " ", " ")

T.cat <- linebreak(c("Short-lived \n Perennial", "Herb \n Shrub \n Tree", "Brush \n Campanulate \n Capitulum \n Open \n Papilionaceous \n Tube",  "Actinomorphic \n Zygomorphic",
           "Presence \n Absence", "None \n Low \n Medium \n High", "Self-incomp. \n Partially self-comp. \n Self-comp.", "Hermaphrodite \n Monoecious \n Dioecious"," ", " ", " ", " "),align = c("l"))

Type <- c("V", "F", "F", "F", "F", "F", "F","F","F","F","F","R")

Type_1 <- c("V", "V", "F", "F", "F", "R", "R", "R","","","","")


dat <- data.frame(Type, Trait,Type_1, Trait1, T.cat)

Number_of_records_quantitative <- c(n_of_records$num.isna[n_of_records$key=="Plant_height_mean_m"], n_of_records$num.isna[n_of_records$key=="Corolla_diameter_mean"],
  n_of_records$num.isna[n_of_records$key=="Corolla_length_mean"], n_of_records$num.isna[n_of_records$key=="Floral_unit_width"],
  n_of_records$num.isna[n_of_records$key=="Style_length"], n_of_records$num.isna[n_of_records$key=="Ovule_number"],
  n_of_records$num.isna[n_of_records$key=="Flowers_per_plant"], n_of_records$num.isna[n_of_records$key=="Nectar_ul"],
  n_of_records$num.isna[n_of_records$key=="Nectar_mg"], n_of_records$num.isna[n_of_records$key=="Nectar_concentration"], n_of_records$num.isna[n_of_records$key=="Pollen_per_flower"],
  n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level_fruit_set"]) 


Number_of_records_categorical <- c(n_of_records$num.isna[n_of_records$key=="lifespan"], n_of_records$num.isna[n_of_records$key=="life_form"],
                                   n_of_records$num.isna[n_of_records$key=="Flower_morphology"], n_of_records$num.isna[n_of_records$key=="Flower_symmetry"],
                                   n_of_records$num.isna[n_of_records$key=="Nectar_presence_absence"], n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level"],
                                   n_of_records$num.isna[n_of_records$key=="Compatibility_system"], n_of_records$num.isna[n_of_records$key=="Breeding_system"],
                                   rep("",4))

dat <- data.frame(Type, Trait,Number_of_records_quantitative,Type_1, Trait1, T.cat,Number_of_records_categorical)


colnames(dat) <- c("Type","Traits", "Records","Type", "Traits", "Categories", "Records")





kbl(dat, booktabs = T,  linesep = "\\addlinespace", escape = FALSE, align = c("c","l","c","c","l","l","c"), caption= "List of the 20 traits compiled in this study divided in quantitative and categorical traits. The different types of trait (vegetative ‘V’, floral ‘F’ and reproductive ‘R’), total records found for the 1,506 species and categories of the qualitative traits are also provided. ") %>%
kable_styling(full_width = T,font_size = 10) %>%
add_header_above(c("Quantitative traits" = 3,"Categorical traits" = 4),bold=T)  %>%
    column_spec(c(1,4), bold = T) %>% row_spec(0, bold=T)



```

\setstretch{2}

##Phylogenetic Distance

We calculated the phylogenetic distance between different plant species using the function get_tree from the package rtrees (downloaded from github, https://github.com/daijiang/rtrees), which downloads phylogenetic distances from the extended R implementation of the Open Tree of Life [@smith2018] developed by @jin2019. 

##Data Imputation

Missing values were imputed with the function missForest [@stekhoven2012] which allows imputation of data sets with continuous and categorical variables. We accounted for the phylogenetic distance among species on the imputation process by including the eigenvectors of a principal component analysis of the phylogenetic distance (PCoA) which has been shown to improve the performance of missForest [@penone2014]. To extract the eigenvectors, we used the function PVRdecomp from the package PVR [@santos2018] based on the conceptual framework of @diniz-filho2012. Although the variable of autonomous selfing had a high percentage of missing values (68%), we were able to solve this by back transforming the qualitative column of autonomous selfing to numerical. The categories of ‘none’, ‘low’, ‘medium’ and ‘high’ were converted to representative percentages of each category 0%, 13%, 50.8% and 80% respectively. This reduced the percentage of missing values for this column from 68% to 35% and allowed the imputation of this variable. However, we were unable to impute nectar and pollen quantity due to the high percentage of missing values (Figure S1). The imputed dataset had 9.7% of missing values with a total of 8 categorical and 8 numerical variables. Finally, we conducted an additional imputation for the subset of species with quantitative information of nectar and pollen; all variables had lower than 30% of missing values (N = 636) and the total proportion of missing values in this dataset considering all variables was 13%. 

##Plant strategies

We explored the trade-offs between different quantitative plant functional traits with a phylogenetically informed Principal Component Analysis (pPCA). We did not include the quantitative variables of flower length and inflorescence width because they were highly and moderately correlated to flower width (Pearson’s correlation = 0.72, p < 0.01 and Pearson’s correlation = 0.36, p < 0.01 respectively), and thus we avoided overemphasizing flower size on the spectrum of trait variation. In addition, we explored the location of different qualitative traits in the trait space. Prior to the analyses, we excluded outliers and standardized the data. Due to the high sensitivity of dimensionality reduction to outliers, we excluded values in the 2.5th-97.5th percentile range [@legendre2012]. Then, we log transformed the variables to reduce the influence of outliers and z-transformed (X= 0, SD=1) so that all variables were within the same numerical range. We performed the pPCA using the function phyl.pca from the package phytools [version number 0.7-70, @revell2012] with the method lambda ($\lambda$) that calculates the phylogenetic correlation between 0 (phylogenetic independence) and 1 (shared evolutionary history) and we implemented the mode covariance because our variables are on the same scale after the log and z-transformation [@abdi2010]. Moreover, to corroborate that our imputation of missing values did not affect our results, we conducted a pPCA on the full dataset without missing values (Figure S2). We found little difference between the variance explained with the imputed dataset (51.08%) and the dataset without missing values (56.26%). In addition, the loadings on each principal component had a similar contribution and correlation patterns, with the exception of plant height which showed slight variations between the imputed and non imputed dataset. Finally, we explored with the imputed dataset with quantitative information of pollen and nectar the compromises in the trait space of these two floral rewards with the other quantitative traits. For this, we considered solely one variable of nectar quantity (microlites of nectar per flower) in order to avoid overemphasizing nectar on the spectrum of trait variation.

##Phylogenetic signal of traits

We calculated the phylogenetic signal of the different quantitative traits on the imputed dataset with the full set of species (N = 1506) with the package phytools version 0.7-70 [@revell2012] and we used Pagel’s lambda ($\lambda$) as a measurement of the phylogenetic signal. For pollen and nectar traits, phylogenetic signal was calculated on the imputed dataset that included these traits (N = 636).

##Networks analysis

Our analyses were conducted on the subset of 60 weighted networks with interaction frequency sampled in a unique flowering season and site. Although floral visitors are not always pollinators and the frequency of visits does not consider each pollinator species efficiency [@ballantyne2015], interaction frequency provides valuable information of the impact of pollinators (Vázquez et al., 2005; Vázquez et al., 2012). Although not all networks were sampled using the same method, our aim was not to compare patterns across networks but within each network in order to obtain a general picture of associations between traits and the main axes of trait variation and plant species functional roles.

*Functional groups visitation patterns*

We explored the relevance of pollinator functional groups and the main axes of trait variation (pPCA with imputed dataset) on pollinator visitation per plant species. For this, we divided floral visitors into six main groups that differ in life form and behaviour: (i) Hymenoptera-Anthophila (bees), (ii) Hymenoptera-non-Anthophila (other non-bee Hymenoptera), (iii) Diptera-Syrphids, (iv) Diptera-Non-Syrphids, (v) Lepidoptera and (vi) Coleoptera. In addition, because Hymenoptera was the most represented group with 2,256 records counted and had the highest frequency of visits of all groups, we also explored visitation patterns of the most represented families of Hymenoptera on the trait space (Andrenidae, Apidae, Colletidae, Halictidae and Megachilidae). Apis mellifera was the species with the largest proportion of records (7.55% from the total) which is is consistent with the results of @hung2018 that showed that A. mellifera was the most frequent visiting species on a similar dataset of 80 interaction plant-pollinator networks on natural systems. Hence, to control for the relevance of Apis mellifera on the observed visitation patterns of bees, we conducted an analogous analysis excluding A. mellifera. We found that A. mellifera, was driving, in part, some of the observed trends on PC1 (Figure S3). However, we did not find major changes on PC2 and PC3.

*Plant species functional roles*

We investigated if the main axes of trait variation and traits explained plant species functional roles. We considered all uncorrelated traits apart from the principal components because this allowed us to consider quantitative and categorical traits. For this, we also used a modelling approach and conducted decision trees which help to interpret visually how the different traits determine species functional roles. We selected simple and complementary plant species level metrics with a relatively straightforward ecological interpretation relevant to our research goals: (i) sum of visits per plant species; (ii) normalized degree calculated as the number of links per plant species divided by the possible number of partners which helps comparison across networks; and (iii) specialization (d’) [@bluthgen2006], which measures the deviation of an expected random choice of the available interaction partners and ranges between 0 (maximum generalization) and 1 (maximum specialization). Normalized degree and specialization were calculated with the specieslevel function from the R package bipartite  [version 2.15, @dormann2008].

## Analyses

First, we implemented Bayesian generalized linear mixed models using the R package brms [version 2.14.6, @burkner2017]. We modelled the frequency of visits as a function of the main axes of trait variation and floral visitors functional groups (Visits~PC1xFG+PC2xFG+PC3xFG). Because we were interested in possible differences among main visitor guilds to plants with different strategies, we included the interaction between the main axes of trait variation and the distinct floral visitor functional groups. We added a nested random effect with networks nested on the study system to capture the network variability per study and within networks. We specified this model with a zero inflated negative binomial distribution and weakly informative priors from the brms function. Moreover, we included the phylogenetic covariance matrix as a random factor due to the possible shared evolutionary history of the species and therefore lack of independence across them. 

Second, we modelled the distinct plant species metrics (sum of visits, normalized degree and plant specialization) as a function of the three main axes of trait variation in three different models for each metric (plant species level metric~PC1+PC2+PC3). In addition we also explored how all uncorrelated traits (13) explained these metrics in three other models (plant species level metric ~ plant height + lifespan + life form + flower shape + flower symmetry + flower width + style length + ovule number + flowers per plant + nectar provision + autonomous selfing + compatibility system + breeding system). For each response variable (metric), we used different distribution families: zero inflated negative binomial for the sum of visits, weibull for normalized degree and zero one inflated beta for specialization. Moreover, we included a nested random effect with networks nested on the study system and a phylogenetic random effect for species (as detailed above) in each model. 

All analyses were conducted in R Version 4.0.3. In addition, all models were run for 3,000 iterations with 1000 warm up iterations. We set delta () to 0.99 to avoid divergent transitions and visualized the posterior predictive checks with the function pp_check using the bayesplot package (version 1.7.2, Gabry et al., 2019).

[ADD REGRESSION TREE TO METHODS]
We conducted regression trees in order to explore the relevance of traits on the species plant functional role. We repeated the procedure as the modelling analysis and we ran a decision tree for each plant level species metric (interaction frequency, normalized degree and specialization). We used the full datase

rpart 4.1-15 (Therneau et al., 2019)
rpart.plot 3.0.9 (Milborrow 2018)

# RESULTS

## Plant strategies
The phylogenetically informed principal component analysis (pPCA) captured with the first two and three axes 51.8% and 70.97% of the trait variation respectively (Figure 1 and Figure S4) and had a phylogenetic correlation ($\lambda$) of 0.76. The first principal component (PC1) represented 26.72% of the trait variation and showed the flower number versus flower size compromise. Thus, as flower number and plant height increase, flower size, style length and ovule number decrease; and, as flower size, style length and ovule number increase, flower number and plant height decrease. The main contributing traits to PC1 were plant height, flower number, ovule number and flower size (loadings > |0.5|; Table S2) but style length also contributed moderately on PC1 (loading = -0.33). The second principal component (PC2) represented 25.05% of the trait variation and showed the trade-off between low and high pollinator dependence and we refer to this axis as the pollinator dependence trade-off. The main driver of trait variation of PC2 was autonomous selfing (loading = 0.85) but the other traits (except ovule number) also made a moderate contribution to PC2 (loadings from 0.27 to 0.4; Table S2). We found that high pollinator dependence was associated with larger and higher number of flowers, greater plant height and longer styles. In contrast, species with high levels of autonomous selfing had a general lower investment in flower number and size, plant height and style length. Further, PC3 also explained a considerable amount of variability (19.17%) and the main contributors to this axis were style length (loading = -0.66) and the degree of autonomous selfing (loading = -0.51). The remaining traits, apart from ovule number, were moderately correlated to changes on PC3 (loadings from -0.23 to -0.46; Table S2). In addition,  the pPCA with the species subset that had nectar and pollen quantity showed that nectar quantity (microlitres of nectar per flower) was positively associated with flower size, style length and ovule number (PC1, 24.70%); and pollen quantity was positively correlated with flower number and plant height and negatively associated with autonomous selfing (PC2, 20.59%; Figure S5). This pPCA also showed similar explained variance with two components (50.06%) and similar associations of traits despite some variability in the loadings (Table S3).




```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=10, fig.width=10,fig.cap= "Life history strategies for 1,236 plant species from 29 plant-pollinator networks studies across the first two axes of variation from a phylogenetically informed principal component analysis (pPCA). The solid arrows indicate the direction and weights of the six quantitative traits (flower number, plant height, style length, flower size, ovule number and autonomous selfing level) and the labelled icons at their end represent the extreme form of the trait continuum. The dashed lines indicate the opposed direction of trait variation and the non-labelled icons at their end illustrate the other extreme of the continuum."}
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.2)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")


PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

library(magick)

#Images were made by Paula Martin
#Check her work on https://paulamartinart.com/

tree <- image_read("Images/PPCA_Plot/Tree.png")
tree_1 <- as.raster(tree)

style_l <- image_read("Images/PPCA_Plot/Style_Long.png")
style_l_1 <- as.raster(style_l)

style_s <- image_read("Images/PPCA_Plot/Style_Short.png")
style_s_1 <- as.raster(style_s)

ovule_h <- image_read("Images/PPCA_Plot/Ovule_High.png")
ovule_h_1 <- as.raster(ovule_h)

ovule_l <- image_read("Images/PPCA_Plot/Ovule_Low.png")
ovule_l_1 <- as.raster(ovule_l)

selfing_n <- image_read("Images/PPCA_Plot/Selfing_None.png")
selfing_n_1 <- as.raster(selfing_n)

selfing_h <- image_read("Images/PPCA_Plot/selfing.png")
selfing_h_1 <- as.raster(selfing_h)

single_flower <- image_read("Images/PPCA_Plot/Single_Flower.png")
single_flower_1 <- as.raster(single_flower)

many_flowers <- image_read("Images/PPCA_Plot/Inflorescencia.png")
many_flowers_1 <- as.raster(many_flowers)
#many_flowers_1 <- image_rotate(many_flowers, 45)


large_flower <- image_read("Images/PPCA_Plot/flower_big.png")
large_flower_1 <- as.raster(large_flower)

flower_small <- image_read("Images/PPCA_Plot/flower_short.png")
flower_small_1 <- as.raster(flower_small)

herb <- image_read("Images/PPCA_Plot/herb.png")
herb_1 <- as.raster(herb)

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]


all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density


  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("PC1 ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("PC2 ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() + annotation_raster(tree_1, xmin = -4.1, xmax = -2.85,ymin = 2.05, ymax = 4.05)+
     annotation_raster(style_l_1, xmin = 2.05, xmax = 2.85,ymin = 2.35, ymax = 3.5) +
    annotation_raster(style_s_1, xmin = -2.6, xmax = -1.9,ymin = -2.65, ymax = -1.7) +
    annotation_raster(ovule_h_1, xmin = 3.5, xmax = 4.2,ymin = -0.45, ymax = 0.50) +
    annotation_raster(ovule_l_1, xmin = -4.2, xmax = -3.5,ymin = -0.45, ymax = 0.5) +
    annotation_raster(selfing_n_1, xmin = -0.75, xmax = 1.2,ymin = 1.8, ymax = 4.5) +
    annotation_raster(selfing_h_1, xmin = -0.30, xmax = 0.15,ymin = -3.9, ymax = -3.1) +
    annotation_raster(single_flower_1, xmin = 3.3, xmax = 4.1,ymin = -1.7, ymax = -0.7) +
    annotation_raster(many_flowers_1, xmin = -4.20, xmax = -3.40,ymin = 0.8, ymax = 1.45) +
    annotation_raster(large_flower_1, xmin = 3.15, xmax = 4.15,ymin = 1.3, ymax = 2.55) +
    annotation_raster(flower_small_1, xmin = -3.50, xmax = -2.55,ymin = -2.1, ymax = -1.60) +
    annotation_raster(herb_1, xmin = 2.6, xmax = 3,ymin = -2.8, ymax = -2) 


    
      #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower number", "Flower Size", "Style length", "Ovule number", "Plant height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5.5,7.25,7.3,6.15)), y = -(PCAloadings$PC2*c(4.693,2.4,3,6.2,5,5.5)+c(0,0,0,0,0.4,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4)
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

plot_grid(all_spp(PC))



```


Evaluation of qualitative variable positions in the trait space revealed statistical association on both axes of trait variation for compatibility, breeding system, life form, lifespan and flower shape (Figure 2 and Table S4). In addition, flower symmetry was associated with PC2 (Sum of squares = 8.51, F-value = 14.72 , p < 0.01 ). Nectar provision was independent of both axes (PC1 Sum of squares = 0.37, F-value = 0.29 , p = 0.59; PC2  Sum of squares = 0.83, F-value = 1.43 , p = 0.23). Concerning self compatibility, we found larger differences in pollinator dependence the trade off  (i.e., species with unisexual flowers and self incompatibility were statistically differentiated from species with partially and fullyself compatibility in trait space; Figure S3 A and B). Life forms differed statistically across both axes of trait variation and followed a gradient of larger life forms (trees and shrubs) with higher pollinator dependence to smaller ones (herbs) with lower pollinator dependence (Figure S3 C and D). Consequently, lifespan also followed this gradient but perennial and short lived species just differed statistically on PC2 (Figure S3 E and F). Species with unisexual flowers (monoecious and dioecious) were clustered on both extremes of trait variation with the highest pollinator dependence and flower number investment (Figure S3 G and H). Moreover, we found that the campanulate and capitulum flower shapes were differentiated  from tube, papilionaceous, open and brush shapes in the trait space. The former morphologies tended to occupy positions with larger flowers and greater pollination dependence, while the latter positions had higher number of flowers and autonomous selfing (Figure S3 I and J). Regarding flower symmetry, zygomorphic flowers were associated with lower levels of pollinator dependence, whereas actinomorphic flowers had higher pollinator dependence (Figure S3 K and L).



```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=12, fig.width=18, fig.cap="Location of the qualitative traits in the trait space for traits that showed a statistical association with the main axis of trait variation. These different traits included: compatibility system (a), life form (b), lifespan (c), breeding system (d), flower shape (e) and flower symmetry (f)."}

#Set working directory
setwd("~/R_Projects/Reproductive Traits")

#Load libraries
#LOAD LIBRARIES
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(cowplot)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.3)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(0.4, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank(),
            plot.title = element_text(size = rel(1.75), face="bold")
      ))
}

#Load data
dat_cleaning_5 <- readRDS("Data/RData/data_all_species_for_rmd_plot_ppca_QUALITATIVE.rds")
phyl_pca_forest <- readRDS("Data/RData/phyl_pca_forest.rds")

#CALL the output PC for simplicity
PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots
Compatibility <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$Compatibility <- dat_cleaning_5$Compatibility_system
  dat$Compatibility <- as.character(dat$Compatibility)
  dat$Compatibility[dat$Compatibility=="dioecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="monoecious"] <- "Unisexual flowers"
  dat$Compatibility[dat$Compatibility=="partially_self_compatible"] <- "Partially self compatible"
  dat$Compatibility[dat$Compatibility=="self_compatible"] <- "Self compatible"
  dat$Compatibility[dat$Compatibility=="self_incompatible"] <- "Self incompatible"
  dat$Compatibility <- factor(dat$Compatibility, levels = c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Compatibility),size=1.75)+scale_color_manual(values=c("cyan4", "deepskyblue2","orange","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.185, 0.13)) +ggtitle("(a)") 
  
  
  plot
  
}

#Compatibility(PC)

#############################################################################################################################################################
#Life form
#############################################################################################################################################################
#Load plots
Life_form <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Life form` <- dat_cleaning_5$life_form
  dat$`Life form` <- as.character(dat$`Life form`)
  dat$`Life form`[dat$`Life form`=="herb"] <- "Herb"
  dat$`Life form`[dat$`Life form`=="shrub"] <- "Shrub"
  dat$`Life form`[dat$`Life form`=="tree"] <- "Tree"
  dat$`Life form`[dat$`Life form`=="vine"] <- "Shrub"
  
  dat$`Life form` <- factor( dat$`Life form`, levels = c("Herb", "Shrub", "Tree"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Life form`),size=1.75)+scale_color_manual(values=c("forestgreen", "darkorange2","gray7"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("(b)") 
  
  plot
  
}

#Life_form(PC)


#############################################################################################################################################################
#Life span
#############################################################################################################################################################
#Load plots
Life_span <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
    dat$Lifespan <- dat_cleaning_5$lifespan
    dat$Lifespan <- as.character(dat$Lifespan)

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=Lifespan),size=1.75)+scale_color_manual(values=c("sienna4","forestgreen"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.102, 0.1)) + ggtitle("(c)") 
  
  plot
  
}

#Life_span(PC)


#############################################################################################################################################################
#Flower symmetry
#############################################################################################################################################################
#Load plots
Flower_sym <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower symmetry` <- dat_cleaning_5$Flower_symmetry
  dat$`Flower symmetry` <- as.character(dat$`Flower symmetry`)
  dat$`Flower symmetry`[dat$`Flower symmetry`=="actinomorphic"] <- "Actinomorphic"
  dat$`Flower symmetry`[dat$`Flower symmetry`=="zygomorphic"] <- "Zygomorphic"
  

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower symmetry`),size=1.75)+scale_color_manual(values=c("sienna2","purple"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.165, 0.1)) + ggtitle("(f)") 
  
  plot
  
}

#Flower_sym(PC)


#############################################################################################################################################################
#Flower shape
#############################################################################################################################################################
#Load plots
Flower_sha <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Flower shape` <- dat_cleaning_5$Flower_morphology
  dat$`Flower shape` <- as.character(dat$`Flower shape`)
  dat$`Flower shape`[dat$`Flower shape`=="Funnelform"] <- "Campanulate"
  dat$`Flower shape`[dat$`Flower shape`=="Spike"] <- "Brush"

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Flower shape`),size=1.75)+scale_color_manual(values=c("blue","cyan4", "red","forestgreen","purple","gold"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.13, 0.18)) + ggtitle("(e)") 
  
  plot
  
}

#Flower_sha(PC)


#############################################################################################################################################################
#Breeding system
#############################################################################################################################################################
#Load plots
Breeding_syst <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
  dat$`Breeding system` <- dat_cleaning_5$Breeding_system
  dat$`Breeding system` <- as.character(dat$`Breeding system`)
  dat$`Breeding system` <- factor(dat$`Breeding system`, levels=c("Hermaphrodite","Monoecious" ,"Dioecious"))

  plot <- plot + geom_point(data=dat, aes(-x, -y, colour=`Breeding system`),size=1.75)+scale_color_manual(values=c("forestgreen","orange", "black"))
  
  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .75 * mult * (get(x)),
                      v2 = .75 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.2, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
  
  #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage

  
  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.8, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
  
  #ADD LABELS
  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = -(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
                          label = PCAloadings$Variables, color="black",size=3)
  
  #CHANGE THEME
  #CHANGE THEME
  
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.163, 0.115)) + ggtitle("(d)") 
  
  plot
  
}

#Breeding_syst(PC)

#############################################################################################################################################################
#Nectar
#############################################################################################################################################################
#Load plots
#Nectar <- function(PC, x="PC1", y="PC2") {
#  # PC being a prcomp object
#  data <- data.frame(PC$S)
#  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
#  dat <- data.frame(x = data[,x], y = data[,y])
#  
#  #######
#  #DENSITY FUNCTION
#  #######
#  get_density <- function(x, y, ...) {
#    dens <- MASS::kde2d(x, y, ...)
#    ix <- findInterval(x, dens$x)
#    iy <- findInterval(y, dens$y)
#    ii <- cbind(ix, iy)
#    return(dens$z[ii])
#  }
#  
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density
#  dat$Nectar <- dat_cleaning_5$Nectar_presence_absence
#  dat$Nectar[dat$Nectar=="yes"] <- "Presence"
#  dat$Nectar[dat$Nectar=="no"] <- "Absence"
#  plot <- plot + geom_point(data=dat, aes(-x, -y, #colour=Nectar),size=1.75)+scale_color_manual(values=c("black","grey"))
#  
#  ########
#  #ADD ARROWS 
#  ########
#  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
#  mult <- min(
#    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
#    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
#  )
#  datapc <- transform(datapc,
#                      v1 = .75 * mult * (get(x)),
#                      v2 = .75 * mult * (get(y))
#  )
#  # add arrows
#  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, #yend=-v2),size=1, arrow=arrow(length=unit(0.5,"cm")), alpha=1, color="black")
#  
#  #Add axis with perctentage
#  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
#
#  
#  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
#  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=0.6, #arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.8, color="black")
#  
#  #ADD LABELS
#  rownames(PC$L) <- c("Selfing", "Flower N.", "Flower size", "Style Length", "Ovule N.", "Plant Height" )
#  
#  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
#  plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.6,4.95,5,7.5,7.1,6)), y = #-(PCAloadings$PC2*c(4.3,2.6,5,7,5.8,6.5)+c(0,0,0,0,-0.15,0)),
#                          label = PCAloadings$Variables, color="black",size=3)
#  
#  #CHANGE THEME
#  #CHANGE THEME
#  
#  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.115)) + ggtitle("G)") 
#  
#  plot
#  
#}
#
# #plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flower_sym(PC),Nectar(PC), ncol=2,nrow=4,  align = "hv")

  plot_grid(Compatibility(PC),Life_form(PC),Life_span(PC),Breeding_syst(PC),Flower_sha(PC),Flower_sym(PC),ncol=3,nrow=2,  align = "hv")


```


## Phylogenetic signal of traits

We found a strong phylogenetic signal with statistical association (P < 0.01) for all quantitative traits (Table S4). The traits with the highest phylogenetic signal were ovule number ($\lambda$ = 1) and plant height ($\lambda$ = 0.96), followed by flower length ($\lambda$ = 0.75), flower width ($\lambda$ = 0.73) and flower number per plant ($\lambda$ = 0.69).  Finally the traits that showed lower phylogenetic signal were inflorescence width ($\lambda$ = 0.57), style length ($\lambda$ = 0.49) and autonomous selfing ($\lambda$ = 0.34).

Add
*pollen and nectar traits


## Visitation patterns

The overall visitation records of functional groups differed considerably. There were 2,256 for bees, 1,768 for non-syrphid-Diptera, 845 for syrphids, 437 for Lepidoptera, 432 for Coleoptera and 362 for non-bee-Hymenoptera. The main axes of trait variation explained little of the visitation patterns (conditional R2 = 0.31; marginal R2 = 0.06) but showed interesting trends for the different functional groups (Figure 3). Furthermore, the additional model with interaction between the most represented families of Hymenoptera and the main axis of trait variation (marginal R2 = 0.30; conditional R2 = 0.03) showed that the family Apidae was the main driver of the observed patterns (Figure S2). Although Apis mellifera contributed substantially to floral visitation, the general pattern of bee visitation did not change when A. mellifera were removed (FSX).



```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=14, fig.width=28}

#LOAD LIBRARIES 
library(phytools)
library(ape) #for phylogenetic distance
library(dplyr) #data processing
library(rtrees) #for phylogenetic distancelibrary(MASS)
library(reshape2)
library(viridis) #COLOUR GGPLOT
library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(tidyverse)
library(patchwork) #panel of plots
library(brms)
library(cmdstanr)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2)),
           axis.text=element_text(size = rel(1.8), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.4)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.8, 'lines'),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.75),face="bold"),
           plot.subtitle = element_text(face="bold",size=rel(2))
     ))
}


setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github

#Plot nicely PC1
analysis_1_just_bees <- readRDS("results_analysis_1_just_bees.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_just_bees.rds")

ce_pc1 <- conditional_effects(analysis_1_just_bees, effects = "PC1",points=T) 
ce_pc1[[1]]$guild <- "bees"

p1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("Number of visits")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + ggtitle("PC1", subtitle = "(a)")

#Plot nicely PC2
ce_pc2 <- conditional_effects(analysis_1_just_bees, effects = "PC2",points=T) 
ce_pc1[[1]]$guild <- "bees"

p2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + ggtitle("PC2", subtitle = "(b)")
#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1_just_bees, effects = "PC3",points=T)
ce_pc1[[1]]$guild <- "bees"


p3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1))) + geom_point(data = dat_analysis,
  aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.5, color="orange") + geom_line(size=1.4, color="orange") + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("")+
  theme_ms() + theme(legend.position = "none") + ggtitle("PC3", subtitle = "(c)")


#Plot nicely PC1
analysis_1_no_bees <- readRDS("results_analysis_1_no_bees.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1_no_bees.rds")


ce_pc1 <- conditional_effects(analysis_1_no_bees, effects = "PC1:guild",points=T) 

pp1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1), group=guild, colour=guild)) + geom_point(data = dat_analysis,
  aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.5) + geom_line(size=1.4) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("Number of visits")+ xlab("High Flower N.    Large flowers")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(size=rel(2),hjust = 0,face="bold")) + scale_color_manual(name="Functional groups",labels=c("Anthophila (bees)","Coleoptera", "Lepidoptera", "Non-Anthophila-Hymenoptera",
   "Non-syrphids-diptera", "Syrphids"),values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),
    limits = c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera","Non-syrphids-diptera", "Syrphids")) + ggtitle("(d)")

ce_pc2 <- conditional_effects(analysis_1_no_bees, effects = "PC2:guild",points=T) 

pp2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1), group=guild, colour=guild)) + geom_point(data = dat_analysis,
  aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.5) + geom_line(size=1.4) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("Low poll. depend. High poll. depend.")+
  theme_ms() + theme(legend.position = "none",plot.title = element_text(size=rel(2),hjust = 0,face="bold")) + scale_color_manual(name="Functional groups",labels=c("Anthophila (bees)","Coleoptera", "Lepidoptera", "Non-Anthophila-Hymenoptera",
   "Non-syrphids-diptera", "Syrphids"),values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),
    limits = c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera","Non-syrphids-diptera", "Syrphids")) + ggtitle("(e)")
  
#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1_no_bees, effects = "PC3:guild",points=T)


pp3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1), group=guild, colour=guild)) + geom_point(data = dat_analysis,
  aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.5) + geom_line(size=1.4) + 
  ylim(0,quantile(dat_analysis$Interaction, 0.95)) + ylab("")+ xlab("Short styles    Long styles")+
  theme_ms() +theme(legend.position = "none",plot.title = element_text(size=rel(2),hjust = 0,face="bold")) + scale_color_manual(name="Functional groups",labels=c("Anthophila (bees)","Coleoptera", "Lepidoptera", "Non-Anthophila-Hymenoptera",
    "Non-syrphids-diptera", "Syrphids"),values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),
    limits = c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera",
               "Non-syrphids-diptera", "Syrphids")) + ggtitle("(f)")

library(patchwork)

combined <- p1 + p2 + p3 + pp1 + pp2 + pp3 & theme(legend.position = "right")
combined + plot_layout(guides = "collect",ncol = 3)




```

## Plant species metrics

The three main axes of trait variation did not explain the position or role of the plant species in the network (visits ~ PCs: conditional R2 =0.11 , marginal R2 = 0.02; normalized degree ~ PCs: conditional R2 =0.24 , marginal R2 = 0.02 and specialization ~ PCs: conditional R2 =0.37 , marginal R2 = 0.03). However, the functional groups showed different visitation patterns across the three main axes of trait variation (Figure 3). On the flower number versus size compromise, all functional groups showed higher visitation rates on plant species with greater vegetative investment and more flowers except syrphids which showed the opposite trend (higher visitation on species with larger flowers and associated traits). Remarkably, on the pollinator dependence trade-off, all pollinator functional groups showed an increasing visitation pattern for species with higher pollinator dependence. Lastly, we found that bees, Lepidoptera and non-bee Hymenoptera visited more species with larger style length and Coleoptera, Non-Syrphids Diptera and Syrphids had greater visitation patterns on species with shorter styles. Furthermore, with the full model that included all traits, we found that a considerable amount of  variance for plant species network metrics was explained by the different qualitative and quantitative traits (Visits ~ Traits: conditional R2 =0.32 , marginal R2 = 0.07; Normalize degree ~ Traits: conditional R2 =0.46 , marginal R2 = 0.16; Specialization ~ Traits: conditional R2 =0.49, marginal R2 = 0.14). 


# DISCUSSION

Our work highlights that in plant-pollinator networks, plant species have displayed clear trade-offs in life strategies. These trade-offs can be differentiated on two main axes of trait variation: the flower number-size trade-off and the pollinator dependence trade-off. In addition, we found that relevant qualitative traits were aggregated within trait space, showing clear delimited strategies of different plant species within plant-pollinated systems. Moreover, the distinct pollinator functional groups showed changes in their interaction strength along these axes of trait variation.  Although the main axes of trait variation explained little the variation of plant species network metrics, the full model of uncorrelated traits explained partially the plan level metrics.  



# CONCLUSIONS

Wrap up


# ACKNOWLEDGEMENTS

On the shoulders of giants.


# REFERENCES


<div id ="refs"></div>


\eleft


<!--# Tables below -->

\listoftables


<!--# Figures below -->

\listoffigures


# SUPPLEMENTARY MATERIAL {-}

\beginsupplement

<!--# To have separate reference lists for main text and Suppl Mat, see https://gist.github.com/Pakillo/e1407cc0632a9202813ec2aee2434cc3 -->

