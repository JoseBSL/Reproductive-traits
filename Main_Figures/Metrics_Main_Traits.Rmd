---
title: ""
output:
  pdf_document: default
  html_document: default
---
```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=18, fig.width=18}

library(ggplot2)
library(emmeans)
library(patchwork)
library(brms)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.3)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(0.4, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank(),
            plot.title = element_text(size = rel(1.75), face="bold"),
            axis.title.y = element_text(size = rel(1.5))
      ))
}

setwd("~/Dropbox/PhD/R/Chapter_2")

#Load data
df <- readRDS("df.rds")

#Model outputs
fit_v <- readRDS("results_fit_v.rds")
fit_nd <- readRDS("results_fit_nd.rds")
fit_d <- readRDS("results_fit_d.rds")

#Tukey posthoc comparisons
cld_visits_life_tukey <- readRDS("cld_visits_life_tukey.rds")
cld_nd_life_tukey <- readRDS("cld_nd_life_tukey.rds")
cld_d_life_tukey <- readRDS("cld_d_life_tukey.rds")
v_cld_comp_tukey <- readRDS("v_cld_comp_tukey.rds")
nd_cld_comp_tukey <- readRDS("nd_cld_comp_tukey.rds")
d_cld_comp_tukey <- readRDS("d_cld_comp_tukey.rds")


##################################################################
##LIFE FORM
##################################################################

#VISITATION
#merge to include in gg
life_v <- conditional_effects(fit_v, effects = "life_form",points=T) 
life_v[[1]] <- merge(life_v[[1]], cld_visits_life_tukey, by="life_form", all.x = TRUE)
#Plot
v_life <-  ggplot(life_v[[1]], aes(x = life_form, y = (estimate__),color=life_form)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = life_form, y =                       Visits),size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__), ymax=(upper__)),width=0.2, size=1) +theme_ms()+
          xlab("") + ylab("Sum of visits") +scale_color_manual(values=c("forestgreen", "darkorange2","black")) +theme(legend.position="none")+
          scale_y_continuous(breaks = seq(0, 280, 50), limits = c(0,280),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = life_v[[1]], aes(y =             270, label = .group),size=6)+ labs(title = bquote(bold('(d)')~ 'Life form'))+theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1))


#NORMNALIZED DEGREE
#calculate posterior for life form
life_nd <- conditional_effects(fit_nd, effects = "life_form",points=T) 
life_nd[[1]] <- merge(life_nd[[1]], cld_nd_life_tukey, by="life_form", all.x = TRUE)
#Plot
nd_life <-  ggplot(life_nd[[1]], aes(x = life_form, y = (estimate__),color=life_form)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = life_form, y =                       normalised.degree),size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__),     ymax=(upper__)),width=0.2,size=1)+theme_ms()+
          xlab("") + ylab("Normalized degree") +scale_color_manual(values=c("forestgreen", "darkorange2","black")) +theme(legend.position="none")+
          scale_y_continuous(breaks = seq(0, 0.8, 0.2), limits = c(0,0.8),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = life_nd[[1]], aes(y =             0.75, label = .group),size=6)+ labs(title = bquote(bold('(e)')~ 'Life form'))+theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1))

#SPECIALIZATION
#calculate posterior for life form
life_dd <- conditional_effects(fit_d, effects = "life_form",points=T) 
colnames(life_dd[[1]])[3] <- "Interaction"
#merge to include in gg
life_dd[[1]] <- merge(life_dd[[1]], cld_d_life_tukey, by="life_form", all.x = TRUE)
#Plot
d_life <- ggplot(life_dd[[1]], aes(x = life_form, y = (estimate__),color=life_form)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = life_form, y = d),
  size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__), ymax=(upper__)),width=0.2, size=1)+theme_ms()+
  xlab("") + ylab("Specialization (d')") +scale_color_manual(values=c("forestgreen", "darkorange2","black"))+theme(legend.position="none")+
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0,1.06),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = life_dd[[1]], aes(y = 1.05, label = .group),size=6) +
  labs(title = bquote(bold('(f)')~ 'Life form'))+theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1))


##################################################################
##COMPATIBILITY
##################################################################


#VISITATION
#calculate posterior for life form
comp_v <- conditional_effects(fit_v, effects = "Compatibility_system",points=T) 
colnames(comp_v[[1]])[3] <- "Interaction"
#merge to include in gg
comp_v[[1]] <- merge(comp_v[[1]], v_cld_comp_tukey, by="Compatibility_system", all.x = TRUE)
#Order labels for plotting
comp_v[[1]]$Compatibility_system <- factor(comp_v[[1]]$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))
df$Compatibility_system <- factor(df$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))
#Plot
v_comp <- ggplot(comp_v[[1]], aes(x = Compatibility_system, y = (estimate__),color=Compatibility_system)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = Compatibility_system, y = Visits),
  size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__), ymax=(upper__)),width=0.2, size=1) +theme_ms()+
  xlab("") + ylab("Sum of visits") +scale_color_manual(values=c("deepskyblue2", "cyan4","orange","gray7")) +theme(legend.position="none")+
  scale_y_continuous(breaks = seq(0, 280, 50), limits = c(0,280),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = comp_v[[1]], aes(y = 270, label = .group),size=6)+
  theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1)) + scale_x_discrete(name=c(""),labels=c("Self-comp", "Part-selfcomp", "Self-incomp", "Uni-flow")) + 
  labs(title = bquote(bold('(g)')~ 'Compatibility'))




#NORMNALIZED DEGREE
#calculate posterior for life form
comp_nd <- conditional_effects(fit_nd, effects = "Compatibility_system",points=T) 
colnames(comp_nd[[1]])[3] <- "Interaction"
#merge to include in gg
comp_nd[[1]] <- merge(comp_nd[[1]], nd_cld_comp_tukey, by="Compatibility_system", all.x = TRUE)

comp_nd[[1]]$Compatibility_system <- factor(comp_nd[[1]]$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))
df$Compatibility_system <- factor(df$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

#Plot
nd_comp <- ggplot(comp_nd[[1]], aes(x = Compatibility_system, y = (estimate__),color=Compatibility_system)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = Compatibility_system, y = normalised.degree),
  size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__), ymax=(upper__)),width=0.2, size=1) +theme_ms()+
  xlab("") + ylab("Normalized degree") +scale_color_manual(values=c("deepskyblue2", "cyan4","orange","gray7")) +theme(legend.position="none")+
  scale_y_continuous(breaks = seq(0, 0.8, 0.2), limits = c(0,0.8),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = comp_nd[[1]], aes(y = 0.75, label = .group),size=6)+
  theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1)) + scale_x_discrete(name=c(""), labels=c("Self-comp", "Part-selfcomp", "Self-incomp", "Uni-flow")) +
  labs(title = bquote(bold('(h)')~ 'Compatibility'))

#SPECIALIZATION
#calculate posterior for life form
#NORMNALIZED DEGREE
#calculate posterior for life form
comp_d <- conditional_effects(fit_d, effects = "Compatibility_system",points=T) 
colnames(comp_d[[1]])[3] <- "Interaction"
#merge to include in gg
comp_d[[1]] <- merge(comp_d[[1]], d_cld_comp_tukey, by="Compatibility_system", all.x = TRUE)

comp_d[[1]]$Compatibility_system <- factor(comp_d[[1]]$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))
df$Compatibility_system <- factor(df$Compatibility_system, levels=c("Self compatible", "Partially self compatible", "Self incompatible", "Unisexual flowers"))

#Plot
d_comp <- ggplot(comp_d[[1]], aes(x = Compatibility_system, y = (estimate__),color=Compatibility_system)) + geom_jitter(width = 0.15,alpha=0.2,data = df,aes(x = Compatibility_system, y = d),
  size = 1, alpha=0.9) +geom_point(size=3.5) +geom_errorbar(aes(ymin=(lower__), ymax=(upper__)),width=0.2, size=1) +theme_ms()+
  xlab("") + ylab("Specialization (d')") +scale_color_manual(values=c( "deepskyblue2", "cyan4","orange","gray7")) +theme(legend.position="none")+
  scale_y_continuous(breaks = seq(0, 1, 0.2), limits = c(0,1.06),  expand = expansion(mult = c(0.05, .05))) +geom_text(data = comp_d[[1]], aes(y = 1.05, label = .group),size=6)+
  theme(axis.text.x = element_text(angle = 30, vjust = 1,hjust=1)) + scale_x_discrete(name=c(""),labels=c("Self-comp", "Part-selfcomp", "Self-incomp", "Uni-flow")) +
  labs(title = bquote(bold('(i)')~ 'Compatibility'))

##################################################################
##FLOWER NUMBER
##################################################################

#VISITATION
v_flower <- conditional_effects(fit_v, effects = "Flowers_per_plant",points=T) 
colnames(v_flower[[1]])[3] <- "Interaction"

pp1 <- ggplot(v_flower[[1]], aes(x = Flowers_per_plant, y = (estimate__+1))) + geom_point(data = df,aes(x = Flowers_per_plant, y = Visits),
  size = 2, alpha=0.35,colour="darkgrey") + geom_line(colour="black",size=1.2) + ylim(0,quantile(df$Visits, 0.95)) +theme_ms()+
  geom_ribbon(aes(ymin=(lower__+1), ymax=(upper__+1)), linetype=2, alpha=0.15,fill="black") + ylab("Sum of visits") + xlab("")+
  labs(title = bquote(bold('(a)')~ 'Flower number'))


#SPECIALIZATION
d_flower <- conditional_effects(fit_d, effects = "Flowers_per_plant",points=T) 
colnames(d_flower[[1]])[3] <- "Interaction"

dd1 <- ggplot(d_flower[[1]], aes(x = Flowers_per_plant, y = (estimate__))) + geom_point(data = df,aes(x = Flowers_per_plant, y = d),
  size = 2, alpha=0.35,colour="darkgrey") + geom_line(colour="black",size=1.2)  +  theme_ms()+
  geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.15,fill="black") + ylab("Specialization (d')") + xlab("")+
  labs(title = bquote(bold('(b)')~ 'Flower number'))

#NORMLAIZED DEGREE
nd_flower <- conditional_effects(fit_nd, effects = "Flowers_per_plant",points=T) 
colnames(nd_flower[[1]])[3] <- "Interaction"

ndd1 <- ggplot(nd_flower[[1]], aes(x = Flowers_per_plant, y = (estimate__))) + geom_point(data = df,aes(x = Flowers_per_plant, y = normalised.degree),
  size = 2, alpha=0.35,colour="darkgrey") + geom_line(colour="black",size=1.2)  +  theme_ms()+
  geom_ribbon(aes(ymin=(lower__), ymax=(upper__)), linetype=2, alpha=0.15,fill="black") + ylab("Normalized degree") + xlab("")+
  labs(title = bquote(bold('(c)')~ 'Flower number'))

pp1 + ndd1 + dd1 +v_life + nd_life + d_life + v_comp + nd_comp + d_comp + plot_layout(ncol = 3)

```