---
output:
  word_document: default
  pdf_document: default
fontsize: 12pt
always_allow_html: true

header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}
- \usepackage{titlesec}
- "\\titlespacing{\\title}{0pt}{\\parskip}{-\\parskip}"
- \usepackage[style=nature]{biblatex}
- \usepackage[labelformat = empty]{caption}
- \usepackage{pdflscape}
- \usepackage[T1]{fontenc}
- \DeclareUnicodeCharacter{0301}{*************************************}
- \DeclareUnicodeCharacter{1EF3}{*************************************}
- \usepackage{orcidlink}
---

\singlespacing

```{r, echo=FALSE, message=FALSE, cache=FALSE, warning=FALSE, fig.height=1, fig.width=14}

library(kableExtra)

library(dplyr)
library(readxl) #read excel file (trait data)
library(dplyr) #data manipulation
library(visdat) #VISUALIZE MISSING DATA
library(naniar)
library(tidyverse)
########################################################################################################################################################
#1) READ TRAIT DATA
########################################################################################################################################################
#load data
trait_data <- read_excel("../Data/Trait_data_raw/Trait_data_final.xlsx",na = "NA")
########################################################################################################################################################
#2) A) CLEAN DATA AND B) RENAME LEVELS FOR IMPUTATION 
########################################################################################################################################################
#####
#A) CLEAN DATA
#####
#select just filled rows
trait_data_1 <- trait_data[1:1712,] #It may be a more elegant way but this does the job, 1712 rows of data

#filter data, select species with flower level info and capitulum
trait_filtered <- filter(trait_data_1, Info_level == "flower" |  Info_level == "capitulum")
#remove NA's and duplicated species|Some spp are repeated once the spp names are standardize with taxize
trait_filtered$Species_all[trait_filtered$Species_all=="NA"]<-NA 
trait_filtered_1 <- trait_filtered[!is.na(trait_filtered$Species_all),]
trait_filtered_2 <- trait_filtered_1[!duplicated(trait_filtered_1$Species_all),]

#Select columns to work with
t <- trait_filtered_2[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system",
                        "Autonomous_selfing_level","Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", 
                        "Flowers_per_plant","Floral_unit_width", "Corolla_diameter_mean", "Corolla_length_mean","Style_length", "Ovule_number", 
                        "life_form", "lifespan","Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg", "Pollen_per_flower")]

########################################################################################################################################################
#####
#B) RENAME LEVELS FOR IMPUTATION
#####
#Breeding_system| For the purpose of this study we are not going to consider other complex breeding systems and just focus on 
#Hermaphroditism, dioecy and monoecy, the closest levels are grouped within each category
t$Breeding_system <- as.character(t$Breeding_system)
t$Breeding_system[t$Breeding_system=="androdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="androgynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="andromonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynodioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="gynoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="gynomonoecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="monoecious_dioecious"] <- "monoecious"
t$Breeding_system[t$Breeding_system=="polygamo-dioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="protandrous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="protogynous"] <- "hermaphrodite"
t$Breeding_system[t$Breeding_system=="subdioecious"] <- "dioecious"
t$Breeding_system[t$Breeding_system=="submonoecious"] <- "monoecious"
#Change to capital letters| There are already levels with lower case
t$Breeding_system[t$Breeding_system=="monoecious"] <- "Monoecious"
t$Breeding_system[t$Breeding_system=="dioecious"] <- "Dioecious"
t$Breeding_system[t$Breeding_system=="hermaphrodite"] <- "Hermaphrodite"
t$Breeding_system <- as.factor(t$Breeding_system)

#Now 3 levels
#Flower_morphology
t$Flower_morphology <- as.character(t$Flower_morphology)
t$Flower_morphology[t$Flower_morphology=="bowl"] <- "open"
t$Flower_morphology[t$Flower_morphology=="dish"] <- "open"
t$Flower_morphology[t$Flower_morphology=="exposed"] <- "open"
t$Flower_morphology[t$Flower_morphology=="spadix"] <- "spike"
t$Flower_morphology[t$Flower_morphology=="open"] <- "Open"
t$Flower_morphology[t$Flower_morphology=="brush"] <- "Brush"
t$Flower_morphology[t$Flower_morphology=="campanulate"] <- "Campanulate"
t$Flower_morphology[t$Flower_morphology=="capitulum"] <- "Capitulum"
t$Flower_morphology[t$Flower_morphology=="funnelform"] <- "Funnelform"
t$Flower_morphology[t$Flower_morphology=="papilionaceous"] <- "Papilionaceous"
t$Flower_morphology[t$Flower_morphology=="spike"] <- "Spike"
t$Flower_morphology[t$Flower_morphology=="tube"] <- "Tube"
t$Flower_morphology <- as.factor(t$Flower_morphology)

#Life span
t$lifespan <- as.character(t$lifespan )
t$lifespan[t$lifespan=="annual"] <- "short_lived"
t$lifespan[t$lifespan=="biennial"] <- "short_lived"
t$lifespan[t$lifespan=="short_lived"] <- "Short lived"
t$lifespan[t$lifespan=="perennial"] <- "Perennial"
t$lifespan <- as.factor(t$lifespan )

########################################################################################################################################################
#3) EXPLORE PATTERNS OF MISSING DATA
########################################################################################################################################################

#We convert cualitative data to quantitative to reduce missing data on this column and hence conduct the imputation 
#use ifelse base r does not work with these NA'S Even with work around. base r does not like the na option of read excel
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("high") & is.na(t$Autonomous_selfing_level_fruit_set), 88, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("medium") & is.na(t$Autonomous_selfing_level_fruit_set), 50.5, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("low") & is.na(t$Autonomous_selfing_level_fruit_set), 13, t$Autonomous_selfing_level_fruit_set)
t$Autonomous_selfing_level_fruit_set <- ifelse(t$Autonomous_selfing_level %in% c("none") & is.na(t$Autonomous_selfing_level_fruit_set), 0, t$Autonomous_selfing_level_fruit_set)

#t$Nectar_ul adding it here just to see how many cells 
#Now we just select presence/absence of nectar
#select columns of interest
t <- t[c("Species_geonet","Order_all","Family_all","Genus_all","Species_all","Breeding_system","Compatibility_system","Autonomous_selfing_level",
         "Autonomous_selfing_level_fruit_set", "Flower_morphology", "Flower_symmetry", "Flowers_per_plant", "Floral_unit_width",
         "Corolla_diameter_mean", "Corolla_length_mean", "Style_length", "Ovule_number", "life_form", "lifespan",
         "Plant_height_mean_m","Nectar_presence_absence","Nectar_ul","Nectar_mg", "Pollen_per_flower")]

########################################################################################################################################################
#4) CALCULATE PHYLOGENETIC DISTANCE TO CORRECT WITH EIGENVALUES IN THE IMPUTATION
########################################################################################################################################################
#Convert to factor 
cols <- c("Order_all", "Family_all", "Genus_all", "Species_all", "Compatibility_system", "Autonomous_selfing_level", "Flower_morphology",
          "Flower_symmetry", "life_form", "lifespan","Nectar_presence_absence")
t[cols] <- lapply(t[cols], factor)  ## as.factor() could also be used

cols.num <- c("Family_all","Genus_all","Species_all")
t[cols.num] <- sapply(t[cols.num],as.character)
t$Species_all <- gsub("Species_all_", "", t$Species_all)

t <- t[!t$Species_all == "Pinus luchuensis", ]   # remove gymnosperm species

#remove species that are not until species level
#ALL THE SPECIES WITH SP. ARE DELETD
t$Species_geonet <- gsub("M_PL_.*","",t$Species_geonet) #subsitute partial string for nothing
t$Species_geonet <- gsub(" $","", t$Species_geonet, perl=T) #remove trailing spaces
t$Species_geonet <-  sub('sp.1$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp.2$', 'sp.', t$Species_geonet)#PREPARE ALL SP TO SP.
t$Species_geonet <- sub('sp$', 'sp.', t$Species_geonet) #PREPARE ALL SP TO SP.
t$Species_geonet <- sub("sp.$", "DELETE", t$Species_geonet) #change all sp. for DELETE
t <- t[- grep("DELETE",  t$Species_geonet),] #remove species with "DELETE"
#CHECK LEVELS

#Make these NA's as NA
t$Species_all[t$Species_all=="NA"] <- NA
t$Family_all[t$Family_all=="NA"] <- NA
t$Genus_all[t$Genus_all=="NA"] <- NA
#remove NA's
t <- t[!is.na(t$Family_all),]
t <- t[!is.na(t$Species_all),]
t <- t[!is.na(t$Genus_all),]



missing.values <- t %>%
  gather(key = "key", value = "val") %>%
  mutate(isna = is.na(val)) %>%
  group_by(key) %>%
  mutate(total = n()) %>%
  group_by(key, total, isna) %>%
  summarise(num.isna = n()) %>%
  mutate(pct = num.isna / total * 100)

n_of_records <- subset(missing.values, isna=="FALSE")

Trait <- c("Plant height", "Flower width", "Flower length", "Inflorescence width", "Style length", "Ovules per flower",
           "Flowers per plant", "Microliters of nectar", "Milligrams of nectar", "Pollen grains per flower", "Autonomous selfing (fruit set)")

Trait1 <- linebreak(c("Lifepan", "Life form", "Flower shape", "Flower symmetry", "Nectar", "Compatibility system", "Breeding system"),align = c("l"))

#T.cat <- linebreak(c("Short-lived \n Perennial", "Herb \n Shrub #\n Tree", "Brush \n Campanulate \n Capitulum \n Open \n #Papilionaceous \n Tube",  "Actinomorphic \n Zygomorphic",
#           "Presence \n Absence", "Self-incomp. \n Part. #self-comp. \n Self-comp.", "Hermaphrodite \n Monoecious \n #Dioecious"),align = c("l"))
#
T.cat <- linebreak(c("Short-lived and perennial", "Herb, shrub and tree", "Brush, campanulate, capitulum,\n open, papilionaceous and tube",  "Actinomorphic and zygomorphic",
           "Presence and absence", "Self-incompatible, partially self-compabtile \n and self-compatible", "Hermaphrodite, monoecious and dioecious"), align = c("l"))



Number_of_records_quantitative <- c(n_of_records$num.isna[n_of_records$key=="Plant_height_mean_m"], n_of_records$num.isna[n_of_records$key=="Corolla_diameter_mean"],
  n_of_records$num.isna[n_of_records$key=="Corolla_length_mean"], n_of_records$num.isna[n_of_records$key=="Floral_unit_width"],
  n_of_records$num.isna[n_of_records$key=="Style_length"], n_of_records$num.isna[n_of_records$key=="Ovule_number"],
  n_of_records$num.isna[n_of_records$key=="Flowers_per_plant"], n_of_records$num.isna[n_of_records$key=="Nectar_ul"],
  n_of_records$num.isna[n_of_records$key=="Nectar_mg"],  n_of_records$num.isna[n_of_records$key=="Pollen_per_flower"],
  n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level_fruit_set"]) 

Number_of_records_categorical <- c(n_of_records$num.isna[n_of_records$key=="lifespan"], n_of_records$num.isna[n_of_records$key=="life_form"],
                                   n_of_records$num.isna[n_of_records$key=="Flower_morphology"], n_of_records$num.isna[n_of_records$key=="Flower_symmetry"],
                                   n_of_records$num.isna[n_of_records$key=="Nectar_presence_absence"], n_of_records$num.isna[n_of_records$key=="Autonomous_selfing_level"],
                                   n_of_records$num.isna[n_of_records$key=="Compatibility_system"], n_of_records$num.isna[n_of_records$key=="Breeding_system"],
                                   rep("",4))

T.range <- c("0.01-30m", "0.50-205mm", "0.20-195mm", "0.80-300mm", "0-138mm", "1-25000", "1-1.8 x $10^5$", "0-160$\\mu$l", "0-6.1mg", "13-2 x $10^8$", "0-100$\\%$")
  
dat_1 <- data.frame(Trait,T.range)
dat_2 <- data.frame(Trait1, T.cat)

colnames(dat_1) <- c("Quantitative traits", "Numerical range")
colnames(dat_2) <- c("Categorical traits", "Categories")

#kable(list(dat_1, dat_2), booktabs = T, linesep = #"\\addlinespace", escape = FALSE,caption = "\\textbf{Table 1 | #Quantitative and categorical traits used in this study.}") %>%
#  kable_styling(full_width = F,font_size = 10) %>%  #column_spec(1:4, 
#              width = "3in", 
#              latex_valign = "m")
#
#

colnames(dat_1) <- c("Traits", "Numerical range/Categories")
colnames(dat_2) <- c("Traits", "Numerical range/Categories")

d <- rbind(dat_1,dat_2)

kable(d, booktabs = T, linesep = "\\addlinespace", escape = FALSE,caption = "\\textbf{Table 1.} Quantitative and categorical traits used in this study.") %>%
  kable_styling(full_width = F,font_size = 12) %>% row_spec(0, bold=T) %>% pack_rows("Quantitative", 1, 11) %>%
pack_rows("Categorical", 12, 18) 



```

\doublespacing