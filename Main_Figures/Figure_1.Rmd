---
output: pdf_document
fontsize: 12pt

header-includes:
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{tabu}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{xcolor}
- \usepackage{float}
- \floatplacement{figure}{H}
- \usepackage[skip=3pt]{caption}
- \captionsetup[figure]{labelformat=empty}
- \usepackage{setspace}
- \usepackage{titlesec}
- \titlespacing{\title}{0pt}{\parskip}{-\parskip}
- \usepackage[style=nature]{biblatex}
- \usepackage[labelformat = empty]{caption}
- \usepackage{pdflscape}
- \usepackage[T1]{fontenc}
- \DeclareUnicodeCharacter{0301}{*************************************}
- \DeclareUnicodeCharacter{1EF3}{*************************************}
- \usepackage{orcidlink}
---


```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, out.width="85%", fig.height=10,fig.align='center',fig.width=10,fig.cap= "\\textbf{Figure 1.} Phylogenetically informed principal component analysis (pPCA) of 1,236 plant species from 28 plant-pollinator network studies. The solid arrows indicate the direction of the different quantitative traits (flower number, plant height, style length, flower size, ovule number and level of autonomous selfing) across the two main axes of trait variation. The length of the arrows indicate the weight of the variables on each principal component and the dashed lines show the opposed direction of trait variation. The icons at both ends of arrows and dashed lines illustrate the extreme form of the trait continuum."}

#Load libraries
library(viridis) #COLOUR GGPLOT
library(ggplot2)
library(broman) #crayon colours
library(cowplot)
library(magick)

# Theme for publication
theme_ms <- function(base_size=12, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
      theme(text=element_text(color="black"),
            axis.title=element_text( size = rel(1.75)),
            axis.text=element_text(size = rel(1.75), color = "black"),
            legend.title=element_text(face="bold"),
            legend.text=element_text(),
            legend.background=element_rect(fill="transparent"),
            legend.key.size = unit(1.2, 'lines'),
            panel.border=element_rect(color="black",size=1),
            panel.grid.minor.x =element_blank(),
            panel.grid.minor.y= element_blank(),
             panel.grid.major= element_blank()
      ))
}

#Load data
dat_cleaning_5 <- readRDS("../Data/RData/data_all_species_PPCA.rds")
phyl_pca_forest <- readRDS("../Data/RData/phyl_pca_forest.rds")

PC <- phyl_pca_forest
#CHECK CONTENT
#EIGENVALUES
PC$Eval
#PC score (POINTS)
PC$S
#PC loadings (ARROWS)
PC$L

#Images were made by Paula Martin
#Check her work on https://paulamartinart.com/

tree <- image_read("../Images/PPCA_Plot/Tree.png")
tree_1 <- as.raster(tree)

style_l <- image_read("../Images/PPCA_Plot/Style_Long.png")
style_l_1 <- as.raster(style_l)

style_s <- image_read("../Images/PPCA_Plot/Style_Short.png")
style_s_1 <- as.raster(style_s)

ovule_h <- image_read("../Images/PPCA_Plot/Ovule_High.png")
ovule_h_1 <- as.raster(ovule_h)

ovule_l <- image_read("../Images/PPCA_Plot/Ovule_Low.png")
ovule_l_1 <- as.raster(ovule_l)

selfing_n <- image_read("../Images/PPCA_Plot/Selfing_None.png")
selfing_n_1 <- as.raster(selfing_n)

selfing_h <- image_read("../Images/PPCA_Plot/selfing.png")
selfing_h_1 <- as.raster(selfing_h)

single_flower <- image_read("../Images/PPCA_Plot/Single_Flower.png")
single_flower_1 <- as.raster(single_flower)

many_flowers <- image_read("../Images/PPCA_Plot/Inflorescencia.png")
many_flowers_1 <- as.raster(many_flowers)
#many_flowers_1 <- image_rotate(many_flowers, 45)

large_flower <- image_read("../Images/PPCA_Plot/flower_big.png")
large_flower_1 <- as.raster(large_flower)

#"Images/PPCA_Plot/flower_short.png"
flower_small <- image_read("../Images/PPCA_Plot/flower_big.png")
flower_small_1 <- as.raster(flower_small)

herb <- image_read("../Images/PPCA_Plot/herb.png")
herb_1 <- as.raster(herb)

#############################################################################################################################################################
#COMPATIBILITY
#############################################################################################################################################################
#Load plots

#Invert axes
PC$S[,1] <- -PC$S[,1]
PC$S[,2] <- -PC$S[,2]

all_spp <- function(PC, x="PC1", y="PC2") {
  # PC being a prcomp object
  data <- data.frame(PC$S)
  plot <- ggplot(data, aes_string(x=x, y=y)) #generate plot
  dat <- data.frame(x = data[,x], y = data[,y])
  
  #######
  #DENSITY FUNCTION
  #######
  get_density <- function(x, y, ...) {
    dens <- MASS::kde2d(x, y, ...)
    ix <- findInterval(x, dens$x)
    iy <- findInterval(y, dens$y)
    ii <- cbind(ix, iy)
    return(dens$z[ii])
  }
  
  dat$density <- get_density(dat$x, dat$y, h = c(2, 2), n = 1000) #obtain density

  
  plot <- plot+stat_density2d(aes(fill=..level..,alpha=..level..),geom='polygon') + 
  scale_fill_continuous(low="green",high="red",guide=FALSE,breaks = c(0.02, 0.050, 0.09), labels = c("Low", "Medium", "High")) + theme(legend.position = "none")+guides(fill = guide_legend(override.aes = list(alpha = 0.7),title="Kernel density"))+
    scale_alpha(guide = 'none')
  
  
    plot <- plot + geom_point(data=dat, aes(x, y),size=1.3, color="black")

  ########
  #ADD ARROWS 
  ########
  datapc <- data.frame(PC$L) #CREATE DATAFRAME WITH LOADINGS
  mult <- min(
    (max(data[,y]) - min(data[,y])/(max(datapc[,y])-min(datapc[,y]))),
    (max(data[,x]) - min(data[,x])/(max(datapc[,x])-min(datapc[,x])))
  )
  datapc <- transform(datapc,
                      v1 = .7 * mult * (get(x)),
                      v2 = .7 * mult * (get(y))
  )
  # add arrows
  plot <- plot + geom_segment(data=datapc,linejoin="round", lineend="round",aes(x=0, y=0, xend=-v1, yend=-v2),size=1.8, arrow=arrow(length=unit(0.5,"cm")), alpha=0.8, colour=c("black"))
  

  #ADD THE OTHER DIRECTION OF THE SEGMENT BECAUSE LOOKS COOL
  plot <- plot + geom_segment(data=datapc, aes(x=0, y=0, xend=v1, yend=v2),size=1.6, arrow=arrow(length=unit(0,"cm")),linetype=2, alpha=0.5, colour=c("black"))
  
   #Add axis with perctentage
  percentage <- round(diag(PC$Eval) / sum(PC$Eval) * 100, 2) #calculate percentage
  
  plot <- plot + xlab(paste("Flower number - Flower size axis ", "(",(percentage[1]),"%",")", sep = "")) #XLAB
  plot <- plot + ylab(paste("Autonomous selfing - Floral display axis ", "(",(percentage[2]),"%",")", sep = "")) #YLAB
  

  #CHANGE THEME
    
  plot <- plot + theme_bw() + annotation_raster(tree_1, xmin = -4.1, xmax = -2.85,ymin = 2.05, ymax = 4.05)+
     annotation_raster(style_l_1, xmin = 2.25, xmax = 3.05,ymin = 2.55, ymax = 3.7) +
    annotation_raster(style_s_1, xmin = -2.6, xmax = -1.9,ymin = -2.65, ymax = -1.7) +
    annotation_raster(ovule_h_1, xmin = 3.5, xmax = 4.2,ymin = -0.45, ymax = 0.50) +
    annotation_raster(ovule_l_1, xmin = -4.2, xmax = -3.5,ymin = -0.45, ymax = 0.5) +
    annotation_raster(selfing_n_1, xmin = -0.75, xmax = 1.2,ymin = 2, ymax = 4.7) +
    annotation_raster(selfing_h_1, xmin = -0.30, xmax = 0.15,ymin = -3.9, ymax = -3.1) +
    annotation_raster(single_flower_1, xmin = 3.3, xmax = 4.1,ymin = -1.7, ymax = -0.7) +
    annotation_raster(many_flowers_1, xmin = -4.20, xmax = -3.40,ymin = 0.8, ymax = 1.45) +
    annotation_raster(large_flower_1, xmin = 3.18, xmax = 4.13,ymin = 1.3, ymax = 2.4) +
    annotation_raster(flower_small_1, xmin = -3.21, xmax = -2.81,ymin = -2, ymax = -1.45) +
    annotation_raster(herb_1, xmin = 2.6, xmax = 3,ymin = -2.8, ymax = -2) 

    
      #ADD LABELS
  rownames(PC$L) <- c("High selfing", "Many flowers", "Large flowers", "Long styles", "Many ovules", "Tall plants" )
  
  PCAloadings <- data.frame(Variables = rownames(PC$L), PC$L)
 plot <- plot + annotate("text", x = -(PCAloadings$PC1*c(4.7,5.05,5.6,7.85,7.3,6.15)), y = -(PCAloadings$PC2*c(4.693,2.5,3.1,6.6,5,5.5)+c(0,0,0,0,0.4,0)),
                         label = PCAloadings$Variables, color="black",fontface =2,size=4)
  
 
 plot <- plot + annotate("text", x = (PCAloadings$PC1*c(4.6,4.95,4.5,6.6,7.3,5.15)), y = (PCAloadings$PC2*c(3.83,6.4,5.7,7.4,-1,7.45)+c(0,0,0,0,-0.41,0)),
                         label =c("Low selfing", "Few flowers", "Small flowers", "Short styles", "Few ovules", "Short plants" ), color="black",fontface =2,size=4)
 
 
  plot <- plot + theme_ms() +ylim(-4,4) + xlim(-4,4) +  theme(legend.position = c(0.095, 0.11)) +ggtitle("") 
  
  
  
  plot
  
}

plot_grid(all_spp(PC))



```
