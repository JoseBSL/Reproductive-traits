---
output:
  pdf_document: default
  html_document: default
classoption: landscape

---

\pagenumbering{gobble}

```{r, echo=FALSE, message=FALSE, cache=FALSE, results='hide', warning=FALSE, fig.height=14, fig.width=27}

#LOAD LIBRARIES 
#library(phytools)
#library(ape) #for phylogenetic distance
#library(dplyr) #data processing
#library(rtrees) #for phylogenetic distancelibrary(MASS)
#library(reshape2)
library(viridis) #COLOUR GGPLOT
#library(MASS)
library(ggplot2)
library(broman) #crayon colours
library(tidyverse)
library(patchwork) #panel of plots
library(brms)

#Load theme for publication

theme_ms <- function(base_size=14, base_family="Helvetica") {
  (theme_bw(base_size = base_size, base_family = base_family)+
     theme(text=element_text(color="black"),
           axis.title=element_text( size = rel(2)),
           axis.text=element_text(size = rel(1.8), color = "black"),
           legend.title=element_text(face="bold",size=rel(2)),
           legend.text=element_text(size=rel(1.7)),
           legend.background=element_rect(fill="transparent"),
           legend.key.size = unit(1.9, 'lines'),
           legend.box.margin=margin(20,20,20,20),
           panel.border=element_rect(color="black",size=2.4),
           panel.grid.minor.x =element_blank(),
           panel.grid.minor.y= element_blank(),
           panel.grid.major= element_blank(),
           plot.title = element_text(hjust = 0.5,size=rel(2.75),face="bold"),
           plot.margin = margin(1,1,1,1, unit = "cm"),
           plot.subtitle = element_text(face="bold",size=rel(2.5))
           
     ))
}

#decimal places for ggplot

scaleFUN <- function(x) sprintf("%.1f", x)


#Prepare plot with presence absence and interaction frequency
setwd("~/Dropbox/PhD/R/Chapter_2") #DROPBOX, files too large for github
#Plot nicely PC1
analysis_1 <- readRDS("results_analysis_1_presence_absence.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_presence_absence.rds")

ce_pc1 <- conditional_effects(analysis_1, effects = "PC1:guild",points=T) 

pp1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__), group=guild, colour=guild)) + 
geom_point(data = dat_analysis,
aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + 
ylab("Interaction") + 
xlab(NULL) +
theme_ms() + 
theme(legend.position = "none") + scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A","cyan4","blueviolet"),           labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera","Non-syrphid-Diptera", "Syrphids")) + ggtitle("PC1", subtitle = "(a)") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))


ce_pc2 <- conditional_effects(analysis_1, effects = "PC2:guild",points=T) 

pp2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__), group=guild, colour=guild)) + geom_point(data = dat_analysis,
aes(x = -PC2, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + ylab(NULL)+ xlab(NULL)+
  theme_ms() + theme(legend.position = "none") + scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera",
    "Non-syrphid-Diptera", "Syrphids"))+ ggtitle("PC2", subtitle = "(b)") + scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))


ce_pc3 <- conditional_effects(analysis_1, effects = "PC3:guild",points=T) 

pp3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__), group=guild, colour=guild)) + geom_point(data = dat_analysis,
 aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5)  + ylab(NULL)+ xlab(NULL)+
  theme_ms() + theme(legend.position = "none") + 
  scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera",
    "Non-syrphid-Diptera", "Syrphids"))+ ggtitle("PC3", subtitle = "(c)")+ scale_y_continuous(breaks = c(0,  1), labels=c("No", "Yes"))
#Plot nicely PC1
analysis_1 <- readRDS("results_analysis_1.rds")
dat_analysis <- readRDS("dat_analysis_results_analysis_1.rds")
########################################################################################################################

########################################################################################################################
ce_pc1 <- conditional_effects(analysis_1, effects = "PC1:guild",points=T) 

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)


p1 <- ggplot(ce_pc1[[1]], aes(x = -PC1, y = (estimate__+1), group=guild, colour=guild)) + 
geom_point(data = dat_analysis,
aes(x = -PC1, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5) + 
coord_cartesian(ylim=c(1,100),clip="off") + 
ylab("Number of visits") +  
theme_ms() + 
theme(legend.position = "none",plot.title = element_text(size=rel(2.5),hjust = 0,face="bold")) + scale_color_manual(name="Functional groups",
  values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"),labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera",
    "Non-syrphid-Diptera", "Syrphids")) +
scale_y_log10() +
ggtitle(NULL, subtitle = "(d)") +
annotate(geom = "text", x = -1.7, y =0.2 , label = "High flower N.", size = 8) +
annotate(geom = "text", x = -1.75, y =0.12 , label = "Small flowers", size = 8) + 
annotate(geom = "text", x = 1.8, y =0.2 , label = "Low flower N.", size = 8) + 
annotate(geom = "text", x = 1.8, y =0.12 , label = "Large flowers", size = 8) +
xlab("") +
annotate(geom = "text", x = -0.1, y =0.35 , label = "Flower number - Flower size axis", size = 8.5, fontface =2) + xlab("") + theme(panel.border=element_rect(color="black",size=1.2))
  




#Plot nicely PC2
ce_pc2 <- conditional_effects(analysis_1, effects = "PC2:guild",points=T) 

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)

p2 <- ggplot(ce_pc2[[1]], aes(x = -PC2, y = (estimate__+1), group=guild, colour=guild)) + 
geom_point(data = dat_analysis, aes(x = -PC2, y = Interaction), size = 2.5, alpha=0.4) + 
geom_line(size=1.5) + 
coord_cartesian(ylim=c(1,100),clip="off") + 
ylab(NULL)  +
theme_ms() + 
theme(legend.position = "none",plot.title = element_text(size=rel(2.5),hjust = 0,face="bold")) + 
scale_color_manual(name="Functional groups",values=c("orange", "black", "limegreen","#E7298A", "cyan4","blueviolet"), labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera", "Non-syrphid-Diptera", "Syrphids")) + scale_y_log10()+
ggtitle(NULL, subtitle = "(e)") +
annotate(geom = "text", x = -1.78, y =0.2 , label = "High aut. selfing", size = 8) +
annotate(geom = "text", x = -1.65, y =0.12 , label = "Small floral display", size = 8) + 
annotate(geom = "text", x = 1.665, y =0.2 , label = "Low aut. selfing", size = 8) + 
annotate(geom = "text", x = 1.85, y =0.12 , label = "Large floral display", size = 8) +
xlab("") +
annotate(geom = "text", x = -0.1, y =0.35 , label = "Autonomous selfing - Floral display axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2))
  

#Plot nicely PC3
ce_pc3 <- conditional_effects(analysis_1, effects = "PC3:guild",points=T)

dat_analysis <- dat_analysis %>% dplyr::filter(Interaction<100)

p3 <- ggplot(ce_pc3[[1]], aes(x = -PC3, y = (estimate__+1), group=guild, colour=guild)) + geom_point(data = dat_analysis,
  aes(x = -PC3, y = Interaction),size = 2.5, alpha=0.4) + geom_line(size=1.5) + 
coord_cartesian(ylim=c(1,100),clip="off") +
ylab(NULL) +
theme_ms() + 
theme(legend.position = "none",plot.title = element_text(size=rel(2.5),hjust = 0,face="bold")) + 
scale_color_manual(name="Functional groups",values=c("orange", 
  "black", "limegreen","#E7298A", "cyan4","blueviolet"),labels=c("Bees","Coleoptera", "Lepidoptera", "Non-bee-Hymenoptera", "Non-syrphid-Diptera", "Syrphids")) + 
scale_y_log10() + 
ggtitle(NULL, subtitle = "(f)") +
annotate(geom = "text", x = -1.48, y =0.2 , label = "Short styles", size = 8) +
annotate(geom = "text", x = -1.25, y =0.12 , label = "Low aut. selfing", size = 8) + 
annotate(geom = "text", x = 2.24, y =0.2 , label = "Long styles", size = 8) + 
annotate(geom = "text", x = 2.5, y =0.12 , label = "High aut. selfing", size = 8) +
xlab(" \n \n  ") +
annotate(geom = "text", x = 0.25, y =0.35 , label = "Style length - Autonomous selfing axis", size = 8.5, fontface =2) +
theme(panel.border=element_rect(color="black",size=1.2))
  


combined <- pp1 + pp2 + pp3 + p1 + p2 + p3 & theme(legend.position = "bottom")
combined + plot_layout(guides = "collect",ncol = 3)


setwd("~/R_Projects/Reproductive Traits")

saveRDS(p1,"Main_Figures/figure_3_1.rds")
saveRDS(p2,"Main_Figures/figure_3_2.rds")
saveRDS(p3,"Main_Figures/figure_3_3.rds")
saveRDS(pp1,"Main_Figures/figure_3_4.rds")
saveRDS(pp2,"Main_Figures/figure_3_5.rds")
saveRDS(pp3,"Main_Figures/figure_3_6.rds")

```

